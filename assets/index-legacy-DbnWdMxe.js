System.register(["./phaser-legacy-B5t1eIzh.js"],function(e,t){"use strict";var s;return{setters:[e=>{s=e.P}],execute:function(){const e="empty",t="solid",a="powder",n="liquid",i="gas",r=3,o="combustible",l="heat_source",d="very_hot",h="freezing",c="oxidizer",m="explosive",u="corrosive",g="dissolves",f="evaporates",p="condenses",y="solidifies_lava",w="organic",b="mineral",M="conductive",E="extinguishes_fire",v=1,C=2,S=4,T=6,x=7,I=8,D=10,k=14,R=22,_=23;class B{constructor(){this.interactions=[],this.registerDefaultInteractions()}registerInteraction(e){const t={...e,priority:void 0!==e.priority?e.priority:10};this.interactions.push(t),this.interactions.sort((e,t)=>e.priority-t.priority)}registerDefaultInteractions(){this.registerInteraction({name:"lava_water_solidification",priority:0,check:(e,t)=>e.hasTag(y)&&"lava"===t.name||t.hasTag(y)&&"lava"===e.name,apply:(e,t,s,a,n,i,r,o)=>{const[l,d,h,c]=e.hasTag(y)?[a,n,i,r]:[i,r,a,n];return Math.random()<.7?(s.setElement(h,c,o.get("stone")),s.setElement(l,d,o.get("steam"))):s.setElement(l,d,o.get("steam")),!0}}),this.registerInteraction({name:"ignition",priority:5,check:(e,t)=>e.hasTag(l)&&t.hasTag(o)||t.hasTag(l)&&e.hasTag(o),apply:(e,t,s,a,n,i,r,l)=>{const[d,h,c]=e.hasTag(o)?[a,n,e]:[i,r,t],m=.1*(1-(c.ignitionResistance||0));if(Math.random()<m){const e=c.burnsInto?l.get(c.burnsInto):l.get("fire");return s.setElement(d,h,e),!0}return!1}}),this.registerInteraction({name:"fire_extinguishing",priority:7,check:(e,t)=>e.hasTag(E)&&"fire"===t.name||t.hasTag(E)&&"fire"===e.name,apply:(e,t,s,a,n,i,r,o)=>{const[l,d]="fire"===e.name?[a,n]:[i,r],[h,c]="fire"===e.name?[i,r]:[a,n];return Math.random()<.9&&(s.setElement(l,d,Math.random()<.3?o.get("steam"):o.get("empty")),Math.random()<.5&&s.setElement(h,c,o.get("steam")),!0)}}),this.registerInteraction({name:"evaporation",priority:10,check:(e,t)=>e.hasTag(f)&&t.hasTag(l)||t.hasTag(f)&&e.hasTag(l),apply:(e,t,s,a,n,i,r,o)=>{const[d,h,c]=e.hasTag(f)?[a,n,e]:[i,r,t];if(Math.random()>.9&&c.evaporatesInto){const t=o.get(c.evaporatesInto);s.setElement(d,h,t);const[m,u]=e.hasTag(l)?[a,n]:[i,r];return Math.random()>.5&&s.setElement(m,u,o.get("empty")),!0}return!1}}),this.registerInteraction({name:"oxidation",check:(e,t)=>e.hasTag(c)&&t.hasTag(l)||t.hasTag(c)&&e.hasTag(l),apply:(e,t,s,a,n,i,r,o)=>{if(Math.random()>.95){const[t,l]=e.hasTag(c)?[a,n]:[i,r];return s.setElement(t,l,o.get("fire")),!0}return!1}}),this.registerInteraction({name:"wet_sand_formation",check:(e,t)=>"water"===e.name&&"sand"===t.name||"sand"===e.name&&"water"===t.name,apply:(e,t,s,a,n,i,r,o)=>{const[l,d,h,c]="sand"===e.name?[a,n,i,r]:[i,r,a,n],m=s.getElement(l,d-1),u=h===l&&c===d-1,g=[m,s.getElement(l,d+1),s.getElement(l-1,d),s.getElement(l+1,d)].filter(e=>e&&"water"===e.name).length,f=g>=3,p=!m||0===m.id;let y=0,w=0;if(u)y=.5,w=.01;else if(f)y=.2,w=.01;else{if(!(g>=1)||p)return!1;y=.15,w=.005}if(Math.random()<y){const e=o.get("wet_sand");if(e)return s.setElement(l,d,e),u&&Math.random()<w&&s.setElement(h,c,o.get("empty")),!0}return!1}}),this.registerInteraction({name:"steam_ice_condensation",priority:8,check:(e,t)=>"steam"===e.name&&"ice"===t.name||"steam"===t.name&&"ice"===e.name,apply:(e,t,s,a,n,i,r,o)=>{const[l,d]="steam"===e.name?[a,n]:[i,r];return Math.random()<.3&&(s.setElement(l,d,o.get("water")),!0)}}),this.registerInteraction({name:"oil_water_separation",priority:15,check:(e,t)=>"oil"===e.name&&"water"===t.name||"oil"===t.name&&"water"===e.name,apply:(e,t,s,a,n,i,r)=>{const[o,l]="oil"===e.name?[a,n]:[i,r],[d,h]="oil"===e.name?[i,r]:[a,n];return l>h&&Math.random()<.2&&(s.swap(o,l,d,h),!0)}}),this.registerInteraction({name:"steam_condensation",priority:16,check:(e,t)=>{const s=["stone","wood","sand","wet_sand","glass","obsidian"];return"steam"===e.name&&s.includes(t.name)||"steam"===t.name&&s.includes(e.name)},apply:(e,t,s,a,n,i,r,o)=>{const[l,d]="steam"===e.name?[a,n]:[i,r],h={stone:.1,obsidian:.12,glass:.08,wet_sand:.06,sand:.05,wood:.03}["steam"===e.name?t.name:e.name]||.05;if(Math.random()<h){const e=o.get("water");if(e)return s.setElement(l,d,e),!0}return!1}})}checkInteraction(e,t,s,a,n,i,r,o){if(0===e.id||0===t.id)return!1;const l=e.tags&&e.tags.size>0,d=t.tags&&t.tags.size>0;if(!(l||d||e.onInteract||t.onInteract))return!1;const h=e.onInteract?.(t,s,a,n,i,r);if(h)return!0;const c=t.onInteract?.(e,s,i,r,a,n);if(c)return!0;if(!l&&!d)return!1;for(const m of this.interactions)if(m.check(e,t)&&m.apply(e,t,s,a,n,i,r,o))return!0;return!1}}const P=new class{constructor(){this.enabled=!1,this.metrics=new Map,this.frameSamples=60,this.currentFrame=0}enable(){this.enabled=!0}disable(){this.enabled=!1}toggle(){return this.enabled=!this.enabled,this.enabled}start(e){this.enabled&&performance.mark(`${e}-start`)}end(e){if(!this.enabled)return;const t=`${e}-end`,s=`${e}-measure`;performance.mark(t);try{performance.measure(s,`${e}-start`,t);const a=performance.getEntriesByName(s)[0];a&&this.record(e,a.duration),performance.clearMarks(`${e}-start`),performance.clearMarks(t),performance.clearMeasures(s)}catch(a){}}record(e,t){this.metrics.has(e)||this.metrics.set(e,{total:0,count:0,min:1/0,max:0,samples:[]});const s=this.metrics.get(e);s.total+=t,s.count++,s.min=Math.min(s.min,t),s.max=Math.max(s.max,t),s.samples.push(t),s.samples.length>this.frameSamples&&s.samples.shift()}getAverage(e){const t=this.metrics.get(e);return t&&0!==t.samples.length?t.samples.reduce((e,t)=>e+t,0)/t.samples.length:0}getMetrics(){const e={};for(const[t,s]of this.metrics.entries())if(s.samples.length>0){const a=s.samples.reduce((e,t)=>e+t,0);e[t]={avg:a/s.samples.length,min:s.min,max:s.max,count:s.count}}return e}getBottlenecks(e=5){const t=this.getMetrics();return Object.entries(t).sort((e,t)=>t[1].avg-e[1].avg).slice(0,e)}reset(){this.metrics.clear(),this.currentFrame=0}wrap(e,t){return this.enabled?(...s)=>{this.start(e);const a=t(...s);return this.end(e),a}:t}profileElementType(e,t){return(s,a,n)=>{this.start(`element:${e}`);const i=t.call(this,s,a,n);return this.end(`element:${e}`),i}}};class N{constructor(e,t,s,a={}){this.id=e,this.name=t,this.color=s,this.density=a.density||0,this.state=a.state||"empty",this.temperature=a.temperature||0,this.dispersion=a.dispersion||0,this.movable=!1!==a.movable,this.defaultLifetime=a.lifetime||-1,this.tags=new Set(a.tags||[]),this.ignitionResistance=a.ignitionResistance||0,this.burnRate=a.burnRate||1,this.brushSize=void 0!==a.brushSize?a.brushSize:5,this.emissionDensity=void 0!==a.emissionDensity?a.emissionDensity:1,this.canInteract=!1!==a.canInteract,this.burnsInto=a.burnsInto||null,this.evaporatesInto=a.evaporatesInto||null,this.condensesInto=a.condensesInto||null,this.meltInto=a.meltInto||null,this.behaviors=[]}hasTag(e){return this.tags.has(e)}addBehavior(e){return this.behaviors.push(e),this}applyBehaviors(e,t,s){const a=s.getCell(e,t);if(!a)return!1;for(const n of this.behaviors)if(n.apply(e,t,s,a))return!0;return!1}update(e,t,s){if(P.enabled){P.start(`element:${this.name}`);const a=this.updateImpl(e,t,s);return P.end(`element:${this.name}`),a}return this.updateImpl(e,t,s)}updateImpl(e,t,s){return!!this.applyBehaviors(e,t,s)||!!this.movement&&this.movement.apply(e,t,s)}onInteract(e,t,s,a,n,i){return null}}class A{constructor(e={}){this.fallSpeed=e.fallSpeed||1,this.slideAngle=!1!==e.slideAngle,this.slideStability=e.slideStability||.85}apply(e,t,s){const a=s.getCell(e,t);if(a&&(void 0!==a.data.velocityX||void 0!==a.data.velocityY)&&this.applyVelocity(e,t,s,a))return!0;if(s.canMoveTo(e,t,e,t+1))return s.swap(e,t,e,t+1),!0;if(this.slideAngle){const a=Math.random()>.5?-1:1,n=!!s.isEmpty(e+a,t+2)||Math.random()>this.slideStability;if(n&&s.canMoveTo(e,t,e+a,t+1))return s.swap(e,t,e+a,t+1),!0;if(n&&s.canMoveTo(e,t,e-a,t+1))return s.swap(e,t,e-a,t+1),!0}return!1}applyVelocity(e,t,s,a){let n=a.data.velocityX||0,i=a.data.velocityY||0;if(n*=.92,i*=.92,i+=.15,Math.abs(n)<.3&&Math.abs(i)<.3)return delete a.data.velocityX,delete a.data.velocityY,!1;const r=e+Math.round(n),o=t+Math.round(i),l=s.getElement(e,t);if(s.isInBounds(r,o)){const a=s.getElement(r,o);if(a&&(0===a.id||a.movable&&a.density<l.density)){s.swap(e,t,r,o);const a=s.getCell(r,o);return a&&(a.data.velocityX=n,a.data.velocityY=i),!0}}return Math.abs(n)>Math.abs(i)?n*=-.3:i*=-.4,a.data.velocityX=n,a.data.velocityY=i,!1}}class L{constructor(e={}){this.fallSpeed=e.fallSpeed||4,this.dispersionRate=e.dispersionRate||2,this.viscosity=e.viscosity||0,this.levelingEnabled=!1!==e.levelingEnabled,this.avoidElements=e.avoidElements||[]}apply(e,t,s){const a=s.getCell(e,t);if(s.getElement(e,t),a&&(void 0!==a.data.velocityX||void 0!==a.data.velocityY)&&this.applyVelocity(e,t,s,a))return!0;let n=0;const i=Math.max(1,this.fallSpeed-this.viscosity);for(;n<i;){const a=t+n+1;if(!s.canMoveTo(e,t+n,e,a))break;const i=s.getElement(e,a);if(i&&this.avoidElements.includes(i.name))break;n++}if(n>0)return s.swap(e,t,e,t+n),!0;const r=Math.random()>.5?1:-1;if(s.canMoveTo(e,t,e+r,t+1)){const a=s.getElement(e+r,t+1);if(!a||!this.avoidElements.includes(a.name))return s.swap(e,t,e+r,t+1),!0}if(s.canMoveTo(e,t,e-r,t+1)){const a=s.getElement(e-r,t+1);if(!a||!this.avoidElements.includes(a.name))return s.swap(e,t,e-r,t+1),!0}if(this.levelingEnabled&&s.frameCount%2==0&&Math.random()>.2&&this.waterLeveling(e,t,s))return!0;if(this.dispersionRate>0){const a=Math.random()>.5?1:-1;for(let n=1;n<=this.dispersionRate;n++){const i=e+a*n;let r=!0;for(let n=e+a;a>0?n<=i:n>=i;n+=a){const e=s.getElement(n,t);if(e&&0!==e.id&&"liquid"!==e.state){r=!1;break}}if(r&&s.canMoveTo(e,t,i,t)){const a=s.getElement(i,t);if(!a||!this.avoidElements.includes(a.name))return s.swap(e,t,i,t),!0}}}return!1}waterLeveling(e,t,s){const a=s.getElement(e,t),n=this.measureLiquidDepth(e-1,t,s,a.state),i=this.measureLiquidDepth(e+1,t,s,a.state),r=this.measureLiquidDepth(e,t+1,s,a.state);return n<r-1&&s.canMoveTo(e,t,e-1,t)?(s.swap(e,t,e-1,t),!0):!!(i<r-1&&s.canMoveTo(e,t,e+1,t))&&(s.swap(e,t,e+1,t),!0)}measureLiquidDepth(e,t,s,a){const n=s.getElement(e,t);if(!n||n.state!==a)return 0;const i=s.getCell(e,t);if(!i)return 0;if(void 0!==i.data.cachedDepth&&void 0!==i.data.cachedDepthFrame&&s.frameCount-i.data.cachedDepthFrame<10)return i.data.cachedDepth;let r=0,o=t;for(;o<s.height&&r<3;){const t=s.getElement(e,o);if(!t||t.state!==a)break;r++,o++}return i.data.cachedDepth=r,i.data.cachedDepthFrame=s.frameCount,r}applyVelocity(e,t,s,a){let n=a.data.velocityX||0,i=a.data.velocityY||0;if(n*=.92,i*=.92,i+=.15,Math.abs(n)<.3&&Math.abs(i)<.3)return delete a.data.velocityX,delete a.data.velocityY,!1;const r=e+Math.round(n),o=t+Math.round(i),l=s.getElement(e,t);if(s.isInBounds(r,o)){const a=s.getElement(r,o);if(a&&(0===a.id||a.movable&&a.density<l.density)){s.swap(e,t,r,o);const a=s.getCell(r,o);return a&&(a.data.velocityX=n,a.data.velocityY=i),!0}}return Math.abs(n)>Math.abs(i)?n*=-.3:i*=-.4,a.data.velocityX=n,a.data.velocityY=i,!1}}class G{constructor(e={}){this.riseSpeed=void 0!==e.riseSpeed?e.riseSpeed:.7,this.spreadRate=void 0!==e.spreadRate?e.spreadRate:.2,this.dissipation=e.dissipation||!1,this.dissipationRate=e.dissipationRate||.001}apply(e,t,s){if(this.dissipation&&Math.random()<this.dissipationRate)return s.setElement(e,t,s.registry.get("empty")),!0;if(Math.random()<this.riseSpeed){if(s.isEmpty(e,t-1))return s.swap(e,t,e,t-1),!0;const a=Math.random()>.5?1:-1;if(s.isEmpty(e+a,t-1))return s.swap(e,t,e+a,t-1),!0;if(s.isEmpty(e-a,t-1))return s.swap(e,t,e-a,t-1),!0}if(Math.random()<this.spreadRate){const a=Math.random()>.5?1:-1;if(s.isEmpty(e+a,t))return s.swap(e,t,e+a,t),!0}return!1}}class F{constructor(e={}){this.pushDownChance=e.pushDownChance||.92,this.glassifyBelowChance=e.glassifyBelowChance||.08,this.glassifySideChance=e.glassifySideChance||.03,this.pushSideChance=e.pushSideChance||.15,this.dryWetSandChance=e.dryWetSandChance||.6}apply(e,t,s){const a=s.getElement(e,t+1);if(a&&"wet_sand"===a.name)return Math.random()<this.dryWetSandChance&&(s.setElement(e,t+1,s.registry.get("sand")),!0);if(a&&"sand"===a.name)return Math.random()<this.pushDownChance?(s.swap(e,t,e,t+1),!0):(s.setElement(e,t+1,s.registry.get("glass")),!0);const n=[[e-1,t],[e+1,t]];for(const[i,r]of n){const t=s.getElement(i,r);if(t&&"sand"===t.name){if(Math.random()<this.pushSideChance){const t=i<e?-1:1,a=s.getElement(i+t,r);return a&&0===a.id?(s.swap(i,r,i+t,r),!0):(s.setElement(i,r,s.registry.get("glass")),!0)}if(Math.random()<this.glassifySideChance)return s.setElement(i,r,s.registry.get("glass")),!0}}return!1}}class z{constructor(e={}){this.obsidianSideChance=e.obsidianSideChance||.3,this.evaporateWaterChance=e.evaporateWaterChance||.2}apply(e,t,s){const a=[[e-1,t],[e+1,t]];for(const[i,r]of a){const a=s.getElement(i,r);if(a&&"water"===a.name){if(Math.random()<this.obsidianSideChance){s.setElement(i,r,s.registry.get("obsidian"));const a=s.getCell(i,r);a&&(a.data.temperature=100),s.setElement(e,t,s.registry.get("obsidian"));const n=s.getCell(e,t);return n&&(n.data.temperature=100),!0}if(Math.random()<this.evaporateWaterChance)return s.setElement(i,r,s.registry.get("steam")),!0}}const n=[[e-1,t-1],[e+1,t-1]];for(const[i,r]of n){const a=s.getElement(i,r);if(a&&"water"===a.name&&Math.random()<.1){s.setElement(i,r,s.registry.get("obsidian"));const a=s.getCell(i,r);a&&(a.data.temperature=100),s.setElement(e,t,s.registry.get("obsidian"));const n=s.getCell(e,t);return n&&(n.data.temperature=100),!0}}return!1}}class O{constructor(e={}){this.obsidianCoolRate=e.obsidianCoolRate||5,this.obsidianCoolThreshold=e.obsidianCoolThreshold||20,this.obsidianCrustChance=e.obsidianCrustChance||.4,this.hotObsidianEvaporateChance=e.hotObsidianEvaporateChance||.3}apply(e,t,s){const a=[[e-1,t],[e+1,t],[e,t-1]];for(const[n,i]of a){const a=s.getElement(n,i);if(a&&"obsidian"===a.name){const a=s.getCell(n,i);if(void 0===a.data.temperature)continue;const r=i===t-1?this.obsidianCoolRate:.5*this.obsidianCoolRate;if(a.data.temperature-=r,i===t-1){if(a.data.temperature<=this.obsidianCoolThreshold){if(Math.random()<this.obsidianCrustChance){s.setElement(e,t,s.registry.get("stone"));const a=s.getCell(e,t);return a&&(a.data.isCrust=!0),!0}return!1}if(Math.random()<this.hotObsidianEvaporateChance)return s.setElement(e,t,s.registry.get("steam")),!0}else if(a.data.temperature>50&&Math.random()<.2)return s.setElement(e,t,s.registry.get("steam")),!0}}return!1}}const W={DAY_LENGTH:1e3,MONTH_LENGTH:1,SEASON_LENGTH:3,SEASONS:["spring","summer","autumn","winter"],START_SEASON:"random",TEMPERATURE:{spring:{min:.3,max:.6},summer:{min:.7,max:1},autumn:{min:.3,max:.5},winter:{min:-.5,max:.2}},TEMP_TRANSITION_SPEED:.001,WIND_ENABLED:!0,WIND_CHANGE_INTERVAL:600,WIND_STRENGTH_RANGE:{min:0,max:3},WIND_PATTERNS:{spring:{strength:1.5,variability:.8},summer:{strength:.5,variability:.3},autumn:{strength:2.5,variability:1.2},winter:{strength:2,variability:.5}},TREE_GROWTH_MULTIPLIER:{spring:.5,summer:1,autumn:2,winter:999},TREE_DECAY_CHANCE:{spring:0,summer:0,autumn:1e-5,winter:2e-5},LEAF_FALL_RATE:{spring:0,summer:0,autumn:.002,winter:.005},LEAF_REGROWTH_CHANCE:1e-4,LEAVES_PER_BRANCH:3,LEAF_COLORS:{spring:[9498256,10025880,10145074],summer:[2263842,3050327,3978097],autumn:[16766720,16753920,16747520,16737095,16729344,14423100],winter:[9139029]},SURFACE_FREEZE_CHANCE:.001,FREEZE_DEPTH:2,ICE_MELT_MULTIPLIER:{spring:1.5,summer:3,autumn:1,winter:0},WATER_EVAPORATION_MULTIPLIER:{spring:2,summer:50,autumn:1,winter:.1},LEAF_DECAY_MULTIPLIER:{spring:5,summer:1,autumn:.5,winter:.2},SPRING_CLEANUP_THRESHOLD:.4,CLOUD_SPAWN_MULTIPLIER:{spring:1.5,summer:.5,autumn:1.2,winter:4},SNOW_CLOUD_CHANCE:.8,MIGRATION_START:.5,BIRD_SPAWN_SPRING:5,SKY_TINT:{spring:{r:1,g:1.05,b:1.1},summer:{r:1.1,g:1.1,b:1.15},autumn:{r:1.15,g:1,b:.9},winter:{r:.9,g:.95,b:1}},SUN_TINT:{spring:{r:1,g:1,b:.9},summer:{r:1.1,g:1.1,b:1},autumn:{r:1.05,g:.95,b:.85},winter:{r:.95,g:.95,b:.9}}};class Y{constructor(e={}){this.freezeChance=e.freezeChance||W.SURFACE_FREEZE_CHANCE,this.freezeDepth=e.freezeDepth||W.FREEZE_DEPTH}apply(e,t,s){const a=s.seasonData;if(!a)return!1;if(a.temperature>=0)return!1;const n=s.getElement(e,t-1);if(!n||0!==n.id)return!1;let i=0;for(let l=-1;l>=-this.freezeDepth;l--){const a=s.getElement(e,t+l);if(!a||0!==a.id)break;i++}const r=1/(i+1),o=this.freezeChance*r;return Math.random()<o&&(s.setElement(e,t,s.registry.get("ice")),!0)}}class H{constructor(e={}){this.baseMeltChance=e.baseMeltChance||.05}apply(e,t,s){const a=s.seasonData;return a?(a.temperature,"winter"===a.season?this.checkAdjacentHeat(e,t,s,.1*this.baseMeltChance):"summer"===a.season?this.checkAdjacentHeat(e,t,s,3*this.baseMeltChance):"spring"===a.season?this.checkAdjacentHeat(e,t,s,1.5*this.baseMeltChance):this.checkAdjacentHeat(e,t,s,this.baseMeltChance)):this.checkAdjacentHeat(e,t,s,this.baseMeltChance)}checkAdjacentHeat(e,t,s,a){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]];for(const[i,r]of n){const n=s.getElement(i,r);if(n&&n.hasTag&&n.hasTag("heat_source")&&Math.random()<a)return s.setElement(e,t,s.registry.get("water")),!0}return!1}}class X{constructor(e={}){this.lifetime=e.lifetime||3e3,this.spreadChance=e.spreadChance||.15,this.spreadIntensity=e.spreadIntensity||1,this.burnsInto=e.burnsInto||"ash"}apply(e,t,s,a){void 0===a.data.burnProgress&&(a.data.burnProgress=0,a.data.lifetime=this.lifetime),a.data.burnProgress++;const n=a.data.burnProgress/this.lifetime;if(a.data.burnProgress>=this.lifetime)return s.setElement(e,t,s.registry.get(this.burnsInto)),!0;const i=n<.66?1:.3,r=this.spreadChance*i;if(Math.random()<r){const a=[[e-1,t],[e+1,t],[e,t-1],[e,t+1]];a.sort(()=>Math.random()-.5);for(const[e,t]of a){const a=s.getElement(e,t);if(a&&a.hasTag&&a.hasTag(o)){const n=a.burnsInto?s.registry.get(a.burnsInto):s.registry.get("fire");return s.setElement(e,t,n),!0}}}return!1}}class ${constructor(e={}){this.emitElement=e.emitElement||"fire",this.emissionRate=e.emissionRate||.15,this.stages=e.stages||null,this.directions=e.directions||[[0,-1]],this.requiresEmpty=!1!==e.requiresEmpty}apply(e,t,s,a){let n=this.emissionRate;if(this.stages&&void 0!==a.data.burnProgress&&a.data.lifetime){const e=a.data.burnProgress/a.data.lifetime;for(const t of this.stages)if(e<t.until){n=t.rate;break}}if(Math.random()<n)for(const[i,r]of this.directions){const a=e+i,n=t+r;if((!this.requiresEmpty||s.isEmpty(a,n))&&(!this.requiresEmpty||s.isEmpty(a,n)))return s.setElement(a,n,s.registry.get(this.emitElement)),!0}return!1}}class q{constructor(e={}){this.ignitionChance=e.ignitionChance||.2,this.range=e.range||1,this.checkDiagonals=!1!==e.checkDiagonals}apply(e,t,s){const a=[];this.range>=1&&a.push([e-1,t],[e+1,t],[e,t-1],[e,t+1]),this.checkDiagonals&&this.range>=1&&a.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]),this.range>=2&&a.push([e,t-2],[e,t+2],[e-2,t],[e+2,t]),a.sort(()=>Math.random()-.5);for(const[n,i]of a){const e=s.getElement(n,i);if(e&&e.hasTag&&e.hasTag(o)){const t=1-(e.ignitionResistance||0),a=this.ignitionChance*t;if(Math.random()<a){const t=e.burnsInto?s.registry.get(e.burnsInto):s.registry.get("fire");return s.setElement(n,i,t),!0}}}return!1}}class V{constructor(e={}){this.detectionRange=e.detectionRange||1,this.ignitionChance=e.ignitionChance||.5,this.transformInto=e.transformInto||"fire",this.checkInterval=e.checkInterval||1}apply(e,t,s,a){if(void 0===a.data.ignitionCheckFrame&&(a.data.ignitionCheckFrame=0),a.data.ignitionCheckFrame++,a.data.ignitionCheckFrame<this.checkInterval)return!1;a.data.ignitionCheckFrame=0;for(let n=-this.detectionRange;n<=this.detectionRange;n++)for(let a=-this.detectionRange;a<=this.detectionRange;a++){if(0===a&&0===n)continue;const i=s.getElement(e+a,t+n);if(i&&i.hasTag&&i.hasTag(l)&&Math.random()<this.ignitionChance)return s.setElement(e,t,s.registry.get(this.transformInto)),!0}return!1}}class U{constructor(e={}){this.extinguishesTo=e.extinguishesTo||"ash",this.waterToSteamChance=e.waterToSteamChance||.5,this.extinguishChance=e.extinguishChance||1,this.waterSources=e.waterSources||["water"]}apply(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of a){const a=s.getElement(n,i);if(a&&this.waterSources.includes(a.name)&&Math.random()<this.extinguishChance)return s.setElement(e,t,s.registry.get(this.extinguishesTo)),Math.random()<this.waterToSteamChance&&s.setElement(n,i,s.registry.get("steam")),!0}return!1}}const j=()=>5+8*Math.random(),K=1,Z=()=>3+Math.floor(2*Math.random()),J=2,Q=()=>.5+.25*Math.random(),ee=25*Math.PI/180,te=50*Math.PI/180,se=20*Math.PI/180,ae=.3,ne=1,ie=120,re=80,oe=2,le=3;class de{constructor(e={}){this.transformInto=e.transformInto||"water",this.transformChance=e.transformChance||.05,this.requiredTag=e.requiredTag||l,this.checkDiagonals=!1!==e.checkDiagonals}apply(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];this.checkDiagonals&&a.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]);for(const[n,i]of a){const a=s.getElement(n,i);if(a&&a.hasTag&&a.hasTag(this.requiredTag)&&Math.random()<this.transformChance)return s.setElement(e,t,s.registry.get(this.transformInto)),!0}return!1}}class he{constructor(e={}){this.meltingRules=e.meltingRules||[],this.checkBelow=!1!==e.checkBelow,this.checkDiagonals=e.checkDiagonals||!1,this.checkCardinal=e.checkCardinal||!1}apply(e,t,s){const a=[];this.checkBelow&&a.push([e,t+1]),this.checkDiagonals&&a.push([e-1,t+1],[e+1,t+1]),this.checkCardinal&&a.push([e-1,t],[e+1,t],[e,t-1]);for(const[n,i]of a){const e=s.getElement(n,i);if(e)for(const t of this.meltingRules)if(e.name===t.target){const e=void 0!==t.chance?t.chance:1;if(Math.random()<e){let e=t.result;return Array.isArray(t.result)&&(e=t.result[Math.floor(Math.random()*t.result.length)]),s.setElement(n,i,s.registry.get(e)),!0}}}return!1}}class ce{constructor(e={}){this.targetElement=e.targetElement||"water",this.freezeInto=e.freezeInto||"ice",this.freezeChance=e.freezeChance||.03,this.checkDiagonals=!1!==e.checkDiagonals}apply(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];this.checkDiagonals&&a.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]);for(const[n,i]of a){const e=s.getElement(n,i);if(e&&e.name===this.targetElement&&Math.random()<this.freezeChance)return s.setElement(n,i,s.registry.get(this.freezeInto)),!0}return!1}}class me{constructor(e={}){this.corrosionRules=e.corrosionRules||[],this.checkDiagonals=e.checkDiagonals||!1,this.emitByproduct=e.emitByproduct||null,this.byproductChance=e.byproductChance||.5,this.selfDilutionChance=e.selfDilutionChance||0,this.selfDilutionResult=e.selfDilutionResult||"water"}apply(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];this.checkDiagonals&&a.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]);for(const[n,i]of a){const a=s.getElement(n,i);if(a)for(const r of this.corrosionRules){let o=!1;if(r.tag&&a.hasTag&&a.hasTag(r.tag)&&(o=!0),r.target&&a.name===r.target&&(o=!0),o&&Math.random()<r.chance){const a=r.result||"empty";return s.setElement(n,i,s.registry.get(a)),this.emitByproduct&&Math.random()<this.byproductChance&&s.isEmpty(n,i-1)&&s.setElement(n,i-1,s.registry.get(this.emitByproduct)),this.selfDilutionChance>0&&Math.random()<this.selfDilutionChance&&s.setElement(e,t,s.registry.get(this.selfDilutionResult)),!0}}}return!1}}class ue{constructor(e={}){this.wetForm=e.wetForm,this.dryForm=e.dryForm,this.waterSources=e.waterSources||["water","wet_sand"],this.wettingChance=e.wettingChance||1,this.dryingChance=e.dryingChance||5e-4,this.requiresExposure=e.requiresExposure||!1}apply(e,t,s,a){const n=s.getElement(e,t);if(!n)return!1;const i=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let r=!1;for(const[o,l]of i){const e=s.getElement(o,l);if(e&&this.waterSources.includes(e.name)){r=!0;break}}if(a.data.isTouchingWater=r,n.name===this.dryForm&&r&&Math.random()<this.wettingChance)return s.setElement(e,t,s.registry.get(this.wetForm)),!0;if(n.name===this.wetForm&&!r){if(this.requiresExposure){const a=s.getElement(e,t-1);if(!a||0!==a.id)return!1}if(Math.random()<this.dryingChance)return s.setElement(e,t,s.registry.get(this.dryForm)),!0}return!1}}const ge=new class{constructor(){this.elements=new Map,this.interactionManager=new B}register(e){this.elements.set(e.name,e),this.elements.set(e.id,e)}get(e){return this.elements.get(e)}getById(e){return this.elements.get(e)}getByName(e){return this.elements.get(e)}checkInteraction(e,t,s,a,n,i,r){return this.interactionManager.checkInteraction(e,t,s,a,n,i,r,this)}registerInteraction(e){this.interactionManager.registerInteraction(e)}getAllElements(){const e=[];for(const[t,s]of this.elements.entries())"string"==typeof t&&e.push(s);return e}};ge.register(new class extends N{constructor(){super(0,"empty",0,{density:0,state:e,movable:!1,tags:[]})}}),ge.register(new class extends N{constructor(){super(20,"player",65535,{density:3,state:t,movable:!1,ignitionResistance:1,tags:[],brushSize:0})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;a.data.initialized||(a.data.initialized=!0,a.data.velocityY=0,a.data.isOnGround=!1);const n=s.getElement(e,t+1);if(!n||"empty"!==n.name&&"water"!==n.name)a.data.velocityY=0,a.data.isOnGround=!0;else if(a.data.velocityY=Math.min(a.data.velocityY+.3,2),a.data.velocityY<0){const n=t-Math.ceil(Math.abs(a.data.velocityY)),i=s.getElement(e,n);if(i&&("empty"===i.name||"water"===i.name))return s.swap(e,t,e,n),a.data.isOnGround=!1,!0;a.data.velocityY=0}else if(a.data.velocityY>0){const n=Math.floor(a.data.velocityY);if(n>0){const i=t+n,r=s.getElement(e,i);if(r&&("empty"===r.name||"water"===r.name))return s.swap(e,t,e,i),a.data.isOnGround=!1,!0;{const n=s.getElement(e,t+1);if(n&&("empty"===n.name||"water"===n.name))return s.swap(e,t,e,t+1),a.data.isOnGround=!1,!0}}}return!1}handleMovement(e,t,s,a){if(!s.getCell(e,t))return!1;switch(a){case"left":return this.moveHorizontal(e,t,s,-1);case"right":return this.moveHorizontal(e,t,s,1);case"jump":return this.jump(e,t,s);default:return!1}}moveHorizontal(e,t,s,a){const n=e+a,i=s.getElement(n,t);if(i&&("empty"===i.name||"water"===i.name))return s.swap(e,t,n,t),!0;const r=s.getElement(n,t-1);return!(!r||"empty"!==r.name&&"water"!==r.name||(s.swap(e,t,n,t-1),0))}jump(e,t,s){const a=s.getCell(e,t);if(!a||!a.data.isOnGround)return!1;a.data.velocityY=-2.5,a.data.isOnGround=!1;const n=s.getElement(e,t-1);return!(!n||"empty"!==n.name&&"water"!==n.name||(s.swap(e,t,e,t-1),0))}}),ge.register(new class extends N{constructor(){super(S,"fire",16737792,{density:0,state:i,temperature:r,dispersion:2,lifetime:60,tags:new Set([l]),brushSize:2,emissionDensity:.5}),this.movement=new G({riseSpeed:.7,spreadRate:.2,dissipation:!1})}updateImpl(e,t,s){return this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(I,"smoke",5592405,{density:0,state:i,dispersion:3,lifetime:300,tags:new Set}),this.atmosphereThreshold=.4,this.movement=new G({riseSpeed:.6,spreadRate:.4,dissipation:!1}),this.atmosphereMovement=new G({riseSpeed:.15,spreadRate:.7,dissipation:!1})}updateImpl(e,t,s){return!!s.getCell(e,t)&&(t<Math.floor(s.height*this.atmosphereThreshold)?this.atmosphereMovement.apply(e,t,s):this.movement.apply(e,t,s))}}),ge.register(new class extends N{constructor(){super(T,"steam",13421772,{density:0,state:i,dispersion:2,lifetime:240,condensesInto:"cloud",tags:new Set([p])}),this.atmosphereThreshold=.4,this.movement=new G({riseSpeed:.8,spreadRate:.15,dissipation:!1})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;const n=t<=Math.floor(s.height*this.atmosphereThreshold);if(n){const n=this.countNearbySteam(e,t,s);if(n>=3){const a=s.registry.get("cloud");if(a){s.setElement(e,t,a);const i=s.getCell(e,t);return i&&(i.data.saturation=Math.min(n,5)),!0}}if(void 0===a.data.atmosphereTime&&(a.data.atmosphereTime=0,a.data.condensationDelay=360+Math.floor(240*Math.random())),a.data.atmosphereTime++,a.data.atmosphereTime>=a.data.condensationDelay){const a=s.registry.get("cloud");if(a){s.setElement(e,t,a);const n=s.getCell(e,t);return n&&(n.data.saturation=1),!0}}}else void 0!==a.data.atmosphereTime&&(delete a.data.atmosphereTime,delete a.data.condensationDelay);if(n){if(Math.random()>.5){const a=Math.random()>.5?1:-1;if(s.isEmpty(e+a,t))return s.swap(e,t,e+a,t),!0}return!1}return this.movement.apply(e,t,s)}countNearbySteam(e,t,s){let a=0;for(let n=-2;n<=2;n++)for(let i=-2;i<=2;i++){if(0===i&&0===n)continue;const r=s.getElement(e+i,t+n);r&&"steam"===r.name&&a++}return a}}),ge.register(new class extends N{constructor(){super(35,"electricity",16776960,{density:0,state:i,movable:!0,tags:[l],brushSize:0,emissionDensity:.3})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(void 0===a.data.lifetime&&(a.data.lifetime=5+Math.floor(10*Math.random()),a.data.hasConducted=!1),a.data.lifetime--,a.data.lifetime<=0)return s.setElement(e,t,s.registry.get("empty")),!0;if(!a.data.hasConducted){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[e,t]of n){const n=s.getElement(e,t);if(n&&n.hasTag&&n.hasTag(M)&&Math.random()<.4)return s.setElement(e,t,s.registry.get("electricity")),a.data.hasConducted=!0,!0;if(n&&n.hasTag&&n.hasTag(o)&&Math.random()<.5){const a=n.burnsInto?s.registry.get(n.burnsInto):s.registry.get("fire");return s.setElement(e,t,a),!0}}}if(Math.random()<.7){const a=s.getElement(e,t+1);if(a&&("empty"===a.name||a.hasTag&&a.hasTag(M)))return a.hasTag&&a.hasTag(M)?s.setElement(e,t+1,s.registry.get("electricity")):s.swap(e,t,e,t+1),!0;if(Math.random()<.3){const a=Math.random()>.5?1:-1,n=s.getElement(e+a,t+1);if(n&&"empty"===n.name)return s.swap(e,t,e+a,t+1),!0}}return!1}}),ge.register(new class extends N{constructor(){super(C,"water",39423,{density:2,state:n,dispersion:3,evaporatesInto:"steam",tags:new Set([f,y,E,M]),brushSize:5,emissionDensity:1}),this.addBehavior(new Y),this.addBehavior(new O({obsidianCoolRate:5,obsidianCoolThreshold:20,obsidianCrustChance:.4,hotObsidianEvaporateChance:.3})),this.movement=new L({fallSpeed:4,dispersionRate:3,viscosity:0,levelingEnabled:!0})}updateImpl(e,t,s){if(this.applyBehaviors(e,t,s))return!0;const a=s.getElement(e,t-1);if(a&&0===a.id&&this.isAtSurface(e,t,s)){const a=s.seasonData;let n=1;a&&(n={spring:2,summer:50,autumn:1,winter:.1}[a.season]||1,a.temperature>.7&&(n*=1.5));const i=1e-4*n;if(Math.random()<i)return s.setElement(e,t,s.registry.get("steam")),!0}const n=s.getElement(e,t+1);if(n&&"wet_sand"===n.name){const a=s.getElement(e,t+2);if(a&&0===a.id&&Math.random()>.93)return s.swap(e,t,e,t+2),!0}return this.movement.apply(e,t,s)}isAtSurface(e,t,s){const a=s.getElement(e,t-1);if(!a||0!==a.id)return!1;const n=s.getElement(e,t+1);if(!n||0===n.id){const a=s.getElement(e-1,t+1),i=s.getElement(e+1,t+1);return n&&0!==n.id||a&&"water"===a.name||i&&"water"===i.name}return!0}}),ge.register(new class extends N{constructor(){super(x,"oil",4013338,{density:1.5,state:n,dispersion:2,ignitionResistance:.2,tags:new Set([o]),burnsInto:"fire",brushSize:5,emissionDensity:1}),this.addBehavior(new V({detectionRange:1,ignitionChance:.5,transformInto:"fire",checkInterval:20})),this.movement=new L({fallSpeed:2,dispersionRate:1,viscosity:1,levelingEnabled:!1})}onInteract(e,t,s,a,n,i){if(e.hasTag(l)){const e=Math.random();if(e>.6){if(t.isEmpty(s,a-1))return t.setElement(s,a-1,t.registry.get("fire")),!0;const e=Math.random()>.5?1:-1;if(t.isEmpty(s+e,a))return t.setElement(s+e,a,t.registry.get("fire")),!0}return!(e>.8&&(t.setElement(s,a,t.registry.get("fire")),t.isEmpty(s,a-1)&&t.setElement(s,a-1,t.registry.get("smoke")),0))}return null}updateImpl(e,t,s){return!!this.applyBehaviors(e,t,s)||this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(R,"lava",16729344,{density:8,state:n,movable:!0,tags:new Set([l,d]),brushSize:3,emissionDensity:.7,lifetime:-1}),this.addBehavior(new q({ignitionChance:.2,range:1,checkDiagonals:!1})),this.addBehavior(new F({pushDownChance:.92,glassifyBelowChance:.08,glassifySideChance:.03,pushSideChance:.15,dryWetSandChance:.6})),this.addBehavior(new z({obsidianSideChance:.3,evaporateWaterChance:.2})),this.addBehavior(new he({meltingRules:[{target:"ice",result:"steam",chance:.3},{target:"salt",result:"smoke",chance:.1}],checkBelow:!0,checkDiagonals:!0,checkCardinal:!0})),this.addBehavior(new $({emitElement:"smoke",emissionRate:.02,directions:[[0,-1]]})),this.movement=new L({fallSpeed:2,dispersionRate:1,viscosity:2,levelingEnabled:!1})}updateImpl(e,t,s){const a=s.getCell(e,t),n=t>0&&0===s.grid[t-1]?.[e]?.element?.id,i=0===e||e===s.width-1||"lava"===s.grid[t]?.[e-1]?.element?.name||"lava"===s.grid[t]?.[e+1]?.element?.name;return a&&(a.data.isLavaSurface=n&&i),!!this.applyBehaviors(e,t,s)||this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(_,"acid",8388352,{density:1.2,state:n,movable:!0,tags:new Set([u]),brushSize:2,emissionDensity:.6}),this.addBehavior(new me({corrosionRules:[{tag:w,chance:.15,result:"smoke"},{tag:b,chance:.1,result:"smoke"},{target:"fish",chance:.15,result:"smoke"},{target:"ash",chance:.15,result:"smoke"}],emitByproduct:"smoke",byproductChance:.05,selfDilutionChance:.05,selfDilutionResult:"water",checkDiagonals:!1})),this.movement=new L({fallSpeed:3,dispersionRate:1,viscosity:0,levelingEnabled:!1})}updateImpl(e,t,s){if(this.applyBehaviors(e,t,s))return!0;const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of a){const a=s.getElement(n,i);if(a&&"lava"===a.name&&Math.random()<.3){if(s.setElement(e,t,s.registry.get("steam")),Math.random()<.5){const a=s.getElement(e,t-1);a&&0===a.id&&s.setElement(e,t-1,s.registry.get("smoke"))}return!0}if(a&&"fire"===a.name&&Math.random()<.2)return s.setElement(e,t,s.registry.get("steam")),!0}for(const[n,i]of a){const a=s.getElement(n,i);if(a&&"water"===a.name&&Math.random()<.05)return s.setElement(e,t,s.registry.get("water")),!0}return this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(32,"slush",11591910,{density:1.9,state:n,movable:!0,tags:new Set([h]),brushSize:3,emissionDensity:.7}),this.addBehavior(new de({transformInto:"water",transformChance:.1,requiredTag:l,checkDiagonals:!0})),this.movement=new L({fallSpeed:2,dispersionRate:1,viscosity:.7,levelingEnabled:!0})}updateImpl(e,t,s){if(this.applyBehaviors(e,t,s))return!0;const a=s.seasonData;if(a){const n=a.season,i=a.seasonProgress||0;let r=0;if("spring"===n?r=5e-4+.001*i:"summer"===n&&(r=.015),r>0&&Math.random()<r)return s.setElement(e,t,s.registry.get("water")),!0}const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let i=!1,r=!1;for(const[o,l]of n){const e=s.getElement(o,l);e&&"water"===e.name&&(i=!0),e&&0!==e.id||(r=!0)}return r&&!i&&Math.random()<.002?(s.setElement(e,t,s.registry.get("ice")),!0):this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(v,"sand",14329120,{density:3,state:a,dispersion:1,tags:new Set([b]),brushSize:5,emissionDensity:1}),this.movement=new A({fallSpeed:1,slideAngle:!0,slideStability:.85})}updateImpl(e,t,s){const a=s.getElement(e,t-1),n=s.getElement(e,t+1);return a&&"water"===a.name&&n&&(0===n.id||"sand"===n.name)&&Math.random()<.5?(s.swap(e,t-1,e,t),!0):this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(18,"wet_sand",9139029,{density:9,state:a,dispersion:0,tags:[],lifetime:-1,brushSize:5,emissionDensity:1})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;void 0===a.data.exposureTime&&(a.data.exposureTime=0);const n=s.getElement(e,t-1);!n||n.id;const i=n&&"water"===n.name,r=s.getElement(e,t+1),o=s.getElement(e-1,t),l=s.getElement(e+1,t);if(n&&"water"===n.name||r&&"water"===r.name||o&&"water"===o.name||l&&"water"===l.name||i)a.data.exposureTime=0;else{const i=[n,r,o,l];let d=0;for(const e of i)e&&0!==e.id&&"sand"!==e.name||d++;if(d>=4){if(a.data.exposureTime++,a.data.exposureTime>240)return s.setElement(e,t,s.registry.get("sand")),!0}else if(d>=3){if(a.data.exposureTime++,a.data.exposureTime>360)return s.setElement(e,t,s.registry.get("sand")),!0}else if(d>=2){if(a.data.exposureTime++,a.data.exposureTime>900)return s.setElement(e,t,s.registry.get("sand")),!0}else if(d>=1){if(a.data.exposureTime++,a.data.exposureTime>2400)return s.setElement(e,t,s.registry.get("sand")),!0}else a.data.exposureTime=0}if(i&&r&&0===r.id&&Math.random()<.7)return s.swap(e,t-1,e,t+1),!0;if(r&&"water"===r.name)return s.swap(e,t,e,t+1),!0;if(r&&0===r.id)return s.swap(e,t,e,t+1),!0;const d=Math.random()>.5?-1:1,h=s.getElement(e+d,t+1);if(h&&(0===h.id||"water"===h.name))return s.swap(e,t,e+d,t+1),!0;const c=s.getElement(e-d,t+1);return!(!c||0!==c.id&&"water"!==c.name||(s.swap(e,t,e-d,t+1),0))}}),ge.register(new class extends N{constructor(){super(k,"gunpowder",3355443,{density:3,state:a,dispersion:1,ignitionResistance:0,burnsInto:"fire",tags:new Set([o,m]),brushSize:4,emissionDensity:1}),this.addBehavior(new ue({dryForm:"gunpowder",wetForm:"wet_gunpowder",waterSources:["water","wet_sand"],wettingChance:1,dryingChance:5e-4})),this.movement=new A({fallSpeed:1,slideAngle:!0,slideStability:.85})}updateImpl(e,t,s){const a=s.getCell(e,t);return!!a&&(!(void 0===a.data.velocityX&&void 0===a.data.velocityY||!this.applyVelocity(e,t,s,a))||(!!this.applyBehaviors(e,t,s)||this.movement.apply(e,t,s)))}applyVelocity(e,t,s,a){let n=a.data.velocityX||0,i=a.data.velocityY||0;if(n*=.92,i*=.92,i+=.15,Math.abs(n)<.3&&Math.abs(i)<.3)return delete a.data.velocityX,delete a.data.velocityY,!1;const r=e+Math.round(n),o=t+Math.round(i);if(s.isInBounds(r,o)){const a=s.getCell(r,o).element;if(a&&(0===a.id||a.movable&&a.density<this.density)){s.swap(e,t,r,o);const a=s.getCell(r,o);return a&&(a.data.velocityX=n,a.data.velocityY=i),!0}}return Math.abs(n)>Math.abs(i)?n*=-.3:i*=-.4,a.data.velocityX=n,a.data.velocityY=i,!1}onInteract(e,t,s,a,n,i){return e.hasTag(l)?(this.explode(s,a,t),!0):null}explode(e,t,s){const a=s.registry.get("fire"),n=s.registry.get("smoke"),i=[];for(let r=-4;r<=4;r++)for(let a=-4;a<=4;a++){const n=Math.sqrt(a*a+r*r);if(n<=4){const o=e+a,l=t+r;s.isInBounds(o,l)&&i.push({x:o,y:l,dist:n,dx:a,dy:r})}}i.sort((e,t)=>e.dist-t.dist);for(const r of i){const e=s.getElement(r.x,r.y);if(!e)continue;const t=Math.pow(1-r.dist/4,1.5);if(r.dist<1.5)s.setElement(r.x,r.y,a);else if("gunpowder"===e.name&&r.dist<3.2)setTimeout(()=>{"gunpowder"===s.getElement(r.x,r.y)?.name&&this.explode(r.x,r.y,s)},50*Math.random()+10);else if(e.hasTag(o)&&Math.random()<.8*t)s.setElement(r.x,r.y,a);else{if(e.movable&&t>.2){const a=s.getCell(r.x,r.y);if(a){const s=Math.atan2(r.dy,r.dx),n=.7,i=Math.abs(Math.cos(s)),o=Math.abs(Math.sin(s)),l=8*t;let d,h;r.dy<0?(d=Math.sign(r.dx)*l*i*(1-n),h=-l*n):(d=Math.sign(r.dx)*l*i*.5,h=-l*(n+.3*o));const c=Math.max(.5,3/(e.density+1));d*=c,h*=c,a.data.velocityX=d,a.data.velocityY=h}}r.dist>2&&r.dist<3.5&&0===e.id&&Math.random()<.6&&s.setElement(r.x,r.y,n)}}}}),ge.register(new class extends N{constructor(){super(19,"wet_gunpowder",2763290,{density:4,state:a,movable:!0,ignitionResistance:.8,burnsInto:"fire",tags:[o],brushSize:0,emissionDensity:0}),this.addBehavior(new ue({dryForm:"gunpowder",wetForm:"wet_gunpowder",waterSources:["water","wet_sand"],wettingChance:1,dryingChance:5e-4})),this.movement=new A({fallSpeed:1,slideAngle:!0,slideStability:.85})}updateImpl(e,t,s){return!!this.applyBehaviors(e,t,s)||this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(D,"ash",10066329,{density:1,state:a,dispersion:1,tags:new Set([g]),lifetime:360}),this.movement=new A({fallSpeed:1,slideAngle:!0,slideStability:.9})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;const n=s.getElement(e,t+1);return n&&"water"===n.name?(a.lifetime>0&&(a.lifetime-=2),Math.random()>.7&&(s.swap(e,t,e,t+1),!0)):this.movement.apply(e,t,s)}}),ge.register(new class extends N{constructor(){super(31,"snow",16777215,{density:1,state:a,movable:!0,tags:[h],brushSize:3,emissionDensity:.6}),this.addBehavior(new de({transformInto:"water",transformChance:.15,requiredTag:l,checkDiagonals:!0}))}updateImpl(e,t,s){if(this.applyBehaviors(e,t,s))return!0;const a=s.seasonData;if(a){const n=a.season,i=a.seasonProgress||0;let r=0;if("spring"===n?r=1e-4+2e-4*i:"summer"===n&&(r=.005),r>0&&Math.random()<r)return s.setElement(e,t,s.registry.get("water")),!0}const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[o,l]of n){const a=s.getElement(o,l);if(a&&"water"===a.name&&Math.random()<.4)return s.setElement(e,t,s.registry.get("slush")),!0}if(Math.random()>.3)return!1;const i=s.getElement(e,t+1);if(i&&"water"===i.name)return s.setElement(e,t,s.registry.get("slush")),!0;if(s.canMoveTo(e,t,e,t+1))return s.swap(e,t,e,t+1),!0;const r=Math.random()>.5?-1:1;return!!(Math.random()>.5&&s.canMoveTo(e,t,e+r,t+1))&&(s.swap(e,t,e+r,t+1),!0)}}),ge.register(new class extends N{constructor(){super(3,"stone",8421504,{density:10,state:t,movable:!0,tags:[],brushSize:1,emissionDensity:1}),this.processedBoulders=new Set}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;const n=a.data.boulderId;return void 0!==n?this.updateBoulder(e,t,s,n):this.updateIndividual(e,t,s)}updateBoulder(e,t,s,a){return!this.processedBoulders.has(a)&&(this.processedBoulders.add(a),!!s.canBoulderMoveDown(a)&&(s.moveBoulderDown(a),!0))}updateIndividual(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(a.data.isCrust)return!1;const n=s.getCell(e,t+1);if(!n)return!1;const i=n.element;return(0===i.id||"liquid"===i.state&&this.density>i.density)&&(s.swap(e,t,e,t+1),!0)}}),ge.register(new class extends N{constructor(){super(5,"wood",9127187,{density:5,state:t,movable:!1,ignitionResistance:.65,burnsInto:"burning_wood",tags:[o,w],brushSize:1,emissionDensity:1})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let i=0;for(const[r,o]of n){const e=s.getElement(r,o);!e||"stone"!==e.name&&"sand"!==e.name||i++}if(i>=4){if(a.data.burialTime||(a.data.burialTime=0),a.data.burialTime++,a.data.burialTime>1200&&Math.random()>.99){const a=s.registry.get("fossil");if(a)return s.setElement(e,t,a),!0}}else{a.data.burialTime=0;for(const[a,i]of n){const n=s.getElement(a,i);if(n&&("sand"===n.name||"water"===n.name)){const a=s.registry.get("tree_trunk");if(a){s.setElement(e,t,a);const n=s.getCell(e,t);n&&(n.data.growthStage=0,n.data.growthTimer=0,n.data.canGrow=!0)}return!0}}}return!1}}),ge.register(new class extends N{constructor(){super(18,"ice",8900331,{density:1.8,state:t,movable:!0,tags:new Set([h]),brushSize:1,emissionDensity:.8}),this.addBehavior(new H({baseMeltChance:.05})),this.addBehavior(new ce({targetElement:"water",freezeInto:"ice",freezeChance:5e-4,checkDiagonals:!1}))}updateImpl(e,t,s){if(this.applyBehaviors(e,t,s))return!0;const a=s.seasonData;if(a){const n=a.season,i=a.seasonProgress||0;let r=0;if("spring"===n?r=2e-4+6e-4*i:"summer"===n&&(r=.01),r>0&&Math.random()<r)return s.setElement(e,t,s.registry.get("water")),!0}const n=s.getElement(e,t+1),i=s.getElement(e,t-1);return n&&0===n.id||n&&"water"===n.name&&i&&"ice"===i.name&&Math.random()<.3?(s.swap(e,t,e,t+1),!0):!(n&&"water"===n.name||!(n&&"liquid"===n.state&&n.density<this.density)||(s.swap(e,t,e,t+1),0))}}),ge.register(new class extends N{constructor(){super(21,"glass",11393254,{density:5,state:t,movable:!1,tags:[o],ignitionResistance:.9,burnsInto:"empty",brushSize:1,emissionDensity:.8,canInteract:!1})}updateImpl(e,t,s){return!1}}),ge.register(new class extends N{constructor(){super(18,"wall",4473924,{density:10,state:t,movable:!1,tags:[],brushSize:1,emissionDensity:1,canInteract:!1})}}),ge.register(new class extends N{constructor(){super(32,"obsidian",657940,{density:10,state:t,movable:!0,ignitionResistance:1,tags:[b],brushSize:2,emissionDensity:.8})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;void 0!==a.data.temperature&&a.data.temperature>0&&Math.random()<.001&&(a.data.temperature-=1,a.data.temperature>70?a.element.color=1706516:a.data.temperature>40?a.element.color=1182228:a.element.color=657940);const n=s.getElement(e,t+1);return!!n&&(0===n.id||"liquid"===n.state&&this.density>n.density)&&(s.swap(e,t,e,t+1),!0)}}),ge.register(new class extends N{constructor(){super(29,"coal",1710618,{density:5,state:t,movable:!0,ignitionResistance:.7,burnsInto:"burning_coal",tags:[o],brushSize:2,emissionDensity:.7})}updateImpl(e,t,s){const a=s.getElement(e,t+1);return(a&&0===a.id||!!(a&&"liquid"===a.state&&this.density>a.density))&&(s.swap(e,t,e,t+1),!0)}}),ge.register(new class extends N{constructor(){super(15,"fossil",9139029,{density:8,state:t,movable:!1,ignitionResistance:1,tags:[w],brushSize:1,emissionDensity:1})}updateImpl(e,t,s){if(Math.random()>.9999){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}for(const[e,t]of a)if(s.isEmpty(e,t)){const a=s.registry.get("oil");if(a)return s.setElement(e,t,a),!0}}return!1}}),ge.register(new class extends N{constructor(){super(50,"light",16774368,{density:0,state:t,movable:!1,tags:[],brushSize:0,emissionDensity:1,glowing:!0})}updateImpl(e,t,s){return!1}}),ge.register(new class extends N{constructor(){super(10,"tree_seed",6636321,{density:3,state:t,movable:!1,ignitionResistance:0,burnsInto:"ash",tags:[w,o],brushSize:0,emissionDensity:1})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(s.isEmpty(e,t+1)){if(s.canMoveTo(e,t,e,t+1))return s.swap(e,t,e,t+1),!0;const a=Math.random()>.5?1:-1;if(s.canMoveTo(e,t,e+a,t+1))return s.swap(e,t,e+a,t+1),!0;if(s.canMoveTo(e,t,e-a,t+1))return s.swap(e,t,e-a,t+1),!0}const n=s.getElement(e,t+1);if(!n||!["sand","wet_sand","stone","wall","wood","tree_trunk","tree_branch","fossil","ash"].includes(n.name))return a.data.treeStructure&&(delete a.data.treeStructure,delete a.data.growthTimer,delete a.data.growthFrameCounter),!1;if(void 0===a.data.growthTimer&&(a.data.growthTimer=0,a.data.checkedConditions=!1),a.data.growthTimer++,a.data.growthTimer<ie)return!1;if(!a.data.checkedConditions){const n=12,i=this.hasNearbyTree(e,t,s,n),r=Math.random()<.03;if(i&&!r)return Math.random()<.002&&s.setElement(e,t,s.registry.get("ash")),!1;a.data.checkedConditions=!0}if(!a.data.treeStructure)return a.data.treeStructure=this.generateFractalTree(e,t),a.data.growthFrameCounter=0,!1;const i=s.seasonData,r=i?i.season:"summer",o=re*({spring:.5,summer:1,autumn:2,winter:999}[r]||1);return a.data.growthFrameCounter++,!(a.data.growthFrameCounter<o)&&(a.data.growthFrameCounter=0,this.growTreeGradually(e,t,s,a))}hasNearbyTree(e,t,s,a){for(let n=-a;n<=a;n++)for(let i=-a;i<=a;i++){if(0===i&&0===n)continue;const a=s.getElement(e+i,t+n);if(a&&("tree_trunk"===a.name||"tree_branch"===a.name))return!0}return!1}generateFractalTree(e,t){const s=this.generateFractalTreeRecursive(e,t,-Math.PI/2,j(),K,0,Z());return{segments:s,totalSegments:s.length,currentSegmentIndex:0,isComplete:!1}}generateFractalTreeRecursive(e,t,s,a,n,i,r){const o=[];if(i>=r||a<J)return o;const l=e+a*Math.cos(s),d=t+a*Math.sin(s);o.push({x1:e,y1:t,x2:l,y2:d,thickness:n,depth:i,angle:s,length:a,type:i<=1?"tree_trunk":"tree_branch"});const h=Q(),c=ee+Math.random()*(te-ee);for(let m=0;m<2;m++){if(Math.random()<ae)continue;let e=s+(0===m?-c:c);e+=(Math.random()-.5)*se;const t=this.generateFractalTreeRecursive(l,d,e,a*h,1,i+1,r);o.push(...t)}return o}growTreeGradually(e,t,s,a){const n=a.data.treeStructure;if(!n.isComplete){for(let e=0;e<ne;e++){if(n.currentSegmentIndex>=n.segments.length){n.isComplete=!0;break}const e=n.segments[n.currentSegmentIndex];this.drawLineSegment(e.x1,e.y1,e.x2,e.y2,e.thickness,e.type,s),n.currentSegmentIndex++}return!0}return!(!n.isComplete||a.data.leavesSpawned||(this.spawnFractalLeaves(n,s),a.data.leavesSpawned=!0,0))}drawLineSegment(e,t,s,a,n,i,r){const o=this.bresenhamLine(Math.round(e),Math.round(t),Math.round(s),Math.round(a)),l=r.registry.get(i);for(const{x:d,y:h}of o)if(1===n)r.isEmpty(d,h)&&r.setElement(d,h,l);else if(2===n)for(let e=0;e<2;e++)for(let t=0;t<2;t++)r.isEmpty(d+e,h+t)&&r.setElement(d+e,h+t,l);else{const e=Math.floor(n/2);for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++)Math.abs(t)+Math.abs(s)<=e&&r.isEmpty(d+t,h+s)&&r.setElement(d+t,h+s,l)}}bresenhamLine(e,t,s,a){const n=[],i=Math.abs(s-e),r=Math.abs(a-t),o=e<s?1:-1,l=t<a?1:-1;let d=i-r,h=e,c=t;for(;n.push({x:h,y:c}),h!==s||c!==a;){const e=2*d;e>-r&&(d-=r,h+=o),e<i&&(d+=i,c+=l)}return n}spawnFractalLeaves(e,t){const s=t.registry.get("leaf"),a=e.segments.filter(e=>e.depth>=oe);for(const n of a){const e=Math.round(n.x2),a=Math.round(n.y2),i=2+Math.floor(Math.random()*le),r=[[e,a],[e-1,a],[e+1,a],[e,a-1],[e,a+1],[e-1,a-1],[e+1,a-1],[e-1,a+1],[e+1,a+1]];r.sort(()=>Math.random()-.5);for(let n=0;n<Math.min(i,r.length);n++){const[e,a]=r[n];t.isEmpty(e,a)&&t.setElement(e,a,s)}}}}),ge.register(new class extends N{constructor(){super(11,"tree_trunk",7029795,{density:6,state:t,movable:!1,ignitionResistance:.75,burnsInto:"burning_wood",tags:[o,w]})}updateImpl(e,t,s){const a=s.seasonData,n=a?a.season:"summer",i=s.getCell(e,t);if(!i)return!1;i.data||(i.data={});const r=s.getElement(e,t-1);if(r&&"water"===r.name&&(i.data.wetness||(i.data.wetness=0),i.data.wetness<100&&Math.random()<.08&&(i.data.wetness=Math.min(100,i.data.wetness+10),s.setElement(e,t-1,s.registry.get("empty")))),i.data.wetness>0&&(i.data.wetness-=.1,i.data.wetness<0&&(i.data.wetness=0)),a&&("winter"===n||"autumn"===n)){const a="winter"===n?2e-5:1e-5;if(Math.random()<a)return s.setElement(e,t,s.registry.get("ash")),!0}let o="spring"===n?.001:1e-4;if(i.data.wetness>20&&(o*=3),Math.random()<o){const a=s.registry.get("leaf");if(!a)return!1;let n=!1;for(let i=-2;i<=2;i++){for(let a=-2;a<=2;a++){const r=s.getElement(e+a,t+i);if(r&&"leaf"===r.name){n=!0;break}}if(n)break}if(!n){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];n.sort(()=>Math.random()-.5);for(const[e,t]of n)if(s.isEmpty(e,t))return s.setElement(e,t,a),!0}}return!1}}),ge.register(new class extends N{constructor(){super(12,"tree_branch",9132604,{density:5,state:t,movable:!1,ignitionResistance:.7,burnsInto:"burning_wood",tags:[o,w]})}updateImpl(e,t,s){const a=s.seasonData,n=a?a.season:"summer",i=s.getCell(e,t);if(!i)return!1;i.data||(i.data={});const r=s.getElement(e,t-1);if(r&&"water"===r.name&&(i.data.wetness||(i.data.wetness=0),i.data.wetness<100&&Math.random()<.08&&(i.data.wetness=Math.min(100,i.data.wetness+10),s.setElement(e,t-1,s.registry.get("empty")))),i.data.wetness>0&&(i.data.wetness-=.1,i.data.wetness<0&&(i.data.wetness=0)),a&&("autumn"===n||"winter"===n)){const a="winter"===n?2e-5:1e-5;if(Math.random()<a){const a=s.registry.get("wood");if(a){s.setElement(e,t,a);const n=s.getCell(e,t);n&&(n.element.movable=!0)}return!0}}let o="spring"===n?.001:5e-4;if(i.data.wetness>20&&(o*=3),Math.random()<o){const a=s.registry.get("leaf");if(!a)return!1;let n=!1;for(let i=-2;i<=2;i++){for(let a=-2;a<=2;a++){const r=s.getElement(e+a,t+i);if(r&&"leaf"===r.name){n=!0;break}}if(n)break}if(!n){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];n.sort(()=>Math.random()-.5);for(const[e,t]of n)if(s.isEmpty(e,t))return s.setElement(e,t,a),!0}}return!1}}),ge.register(new class extends N{constructor(){super(13,"leaf",3329330,{density:.5,state:t,movable:!0,ignitionResistance:.5,burnsInto:"fire",tags:[o,w]})}initializeCell(e){e.age=0}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;const n=s.seasonData,i=n?n.season:"summer";if(!a.data.leafColor&&n){const e={spring:[9498256,10025880,10145074],summer:[2263842,3050327,3978097],autumn:[16766720,16753920,16747520,16737095,16729344,14423100],winter:[9139029]},t=e[i]||e.summer;a.data.leafColor=t[Math.floor(Math.random()*t.length)]}const r=this.checkSupport(e,t,s);if(r&&n)if("autumn"===i){const e=.002;Math.random()<e&&(a.data.detached=!0)}else if("winter"===i){const e=.005;Math.random()<e&&(a.data.detached=!0)}if(!r||a.data.detached){const r=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[a,n]of r){const i=s.getElement(a,n);if(i&&"water"===i.name)return s.setElement(e,t,s.registry.get("water")),!0}a.data.age++;let o=1,l=!1;if(n&&(o={spring:5,summer:1,autumn:.5,winter:.2}[i]||1,"spring"===i&&n.seasonProgress>.4&&(l=!0,n.seasonProgress>.6&&(o*=3))),a.data.age>300){const e=Math.min((a.data.age-300)/600,1),t=a.data.leafColor||2263842,s=t>>16&255,n=t>>8&255,i=255&t,r=139,o=69,l=19,d=Math.floor(s+(r-s)*e),h=Math.floor(n+(o-n)*e),c=Math.floor(i+(l-i)*e);a.data.leafColor=d<<16|h<<8|c}if(l&&a.data.age>300){const a=.02*o;if(Math.random()<a)return s.setElement(e,t,s.registry.get("empty")),!0}const d=Math.floor(900/o);if(a.data.age>d){const a=.05*o;if(Math.random()<a){if(l)s.setElement(e,t,s.registry.get("empty"));else{const a=s.registry.get("ash");a?s.setElement(e,t,a):s.setElement(e,t,s.registry.get("empty"))}return!0}}if(Math.random()>.97){if(s.isEmpty(e,t+1))return s.swap(e,t,e,t+1),!0;const a=Math.random()>.5?1:-1;if(s.isEmpty(e+a,t+1))return s.swap(e,t,e+a,t+1),!0}}else a.data.age=0,a.data.detached=!1;if(r&&Math.random()>.999){const a=Math.random()>.5?1:-1;if(s.isEmpty(e+a,t))return s.swap(e,t,e+a,t),!0}if(r&&Math.random()>.9999){const a=s.registry.get("leaf");if(!a)return!1;const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let i=0,r=[];for(const[e,t]of n){const a=s.getElement(e,t);a&&"leaf"===a.name?i++:s.isEmpty(e,t)&&r.push([e,t])}if(i<2&&r.length>0){const[e,t]=r[Math.floor(Math.random()*r.length)];return s.setElement(e,t,a),!0}}return!1}checkSupport(e,t,s){const a=new Set,n=[[e,t,0]];for(a.add(`${e},${t}`);n.length>0;){const[e,t,i]=n.shift();if(i>8)continue;const r=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[o,l]of r){const e=`${o},${l}`;if(a.has(e))continue;a.add(e);const t=s.getElement(o,l);if(!t)continue;const r=t.name;if("tree_trunk"===r||"tree_branch"===r||"wood"===r||"burning_wood"===r)return!0;"leaf"===r&&n.push([o,l,i+1])}}return!1}}),ge.register(new class extends N{constructor(){super(24,"vine",2263842,{density:2,state:t,movable:!1,ignitionResistance:.75,burnsInto:"burning_wood",tags:[o,w],brushSize:1,emissionDensity:.5})}updateImpl(e,s,a){const n=a.getCell(e,s);if(!n)return!1;if(void 0===n.data.growthStage&&(n.data.growthStage=0,n.data.hasLanded=!1,n.data.swayTimer=Math.floor(60*Math.random()),n.data.age=0,n.data.branchLength=0,n.data.vineId=Math.random(),n.data.health=100),n.data.age++,(a.frameCount+(11*e+7*s)%4)%4!=0&&n.data.age>10)return!1;if(this.isInWater(e,s,a)){if(Math.random()<.001&&(n.data.health-=1),n.data.health<=0)return a.setElement(e,s,a.registry.get("empty")),!0;Math.random()>.98&&n.data.growthStage++;const t=this.countNearbyVines(e,s,a);if(t>10)return Math.random()<.005&&(n.data.health-=5),!1;if(n.data.growthStage>=4&&t<8&&Math.random()>.997){const t=this.calculateBranchLength(e,s,a);if(t>=6+Math.floor(6*Math.random()))return!1;const i=[];i.push([e,s-1],[e,s-1],[e,s-1],[e,s-1]),i.push([e-1,s-1],[e+1,s-1]),i.sort(()=>Math.random()-.5);for(const[e,s]of i){const i=a.getElement(e,s);if(i&&"water"===i.name&&this.hasNearbySupport(e,s,a)){a.setElement(e,s,a.registry.get("vine"));const i=a.getCell(e,s);return i&&(i.data.vineId=n.data.vineId,i.data.branchLength=t+1,i.data.health=80+Math.floor(20*Math.random())),!0}}}return!1}if(!n.data.hasLanded){const t=a.getElement(e,s+1);if(t&&0!==t.id)n.data.hasLanded=!0;else if(a.canMoveTo(e,s,e,s+1))return a.swap(e,s,e,s+1),!0}const i=a.getElement(e,s+1);if(!i||!["sand","wet_sand","stone","wood","fossil","salt","wall","vine","obsidian"].includes(i.name)&&i.state!==t)return Math.random()>.95&&(a.setElement(e,s,a.registry.get("empty")),!0);if(Math.random()<8e-4&&(n.data.health-=1),n.data.health<=0)return a.setElement(e,s,a.registry.get("empty")),!0;Math.random()>.98&&n.data.growthStage++;const r=this.countNearbyVines(e,s,a);if(r>12)return Math.random()<.003&&(n.data.health-=5),!1;if(n.data.growthStage>=5&&r<10&&Math.random()>.996){const t=this.calculateBranchLength(e,s,a);if(t>=5+Math.floor(5*Math.random()))return!1;a.getElement(e,s-1);const i=[];i.push([e,s-1],[e,s-1],[e,s-1]),i.push([e-1,s],[e+1,s]),Math.random()>.7&&i.push([e-1,s-1],[e+1,s-1]),i.sort(()=>Math.random()-.5);for(const[e,r]of i){const i=a.getElement(e,r);if(i&&0===i.id&&this.hasNearbySupport(e,r,a)){a.setElement(e,r,a.registry.get("vine"));const i=a.getCell(e,r);return i&&(i.data.vineId=n.data.vineId,i.data.branchLength=t+1,i.data.health=80+Math.floor(20*Math.random()),r===s&&(i.data.hasLanded=!0)),!0}}}return!1}countNearbyVines(e,t,s){let a=0;for(let n=-4;n<=4;n++)for(let i=-4;i<=4;i++){if(0===i&&0===n)continue;const r=s.getElement(e+i,t+n);r&&"vine"===r.name&&a++}return a}calculateBranchLength(e,s,a){const n=new Set,i=[[e,s,0]];for(;i.length>0&&n.size<40;){const[e,s,r]=i.shift(),o=`${e},${s}`;if(n.has(o))continue;n.add(o);const l=a.getElement(e,s);if(l&&"vine"!==l.name&&l.state===t)return r;if(l&&"vine"!==l.name&&"water"===l.name){const n=a.getElement(e,s+1);if(n&&n.state===t)return r}l&&"vine"===l.name&&r<12&&(i.push([e-1,s,r+1]),i.push([e+1,s,r+1]),i.push([e,s-1,r+1]),i.push([e,s+1,r+1]))}return 0}hasNearbySupport(e,s,a){const n=[[e,s-1],[e,s+1],[e-1,s],[e+1,s],[e-1,s-1],[e+1,s-1],[e-1,s+1],[e+1,s+1]];for(const[i,r]of n){const e=a.getElement(i,r);if(e&&(e.state===t||"vine"===e.name))return!0}return!1}isInWater(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of a){const e=s.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}}),ge.register(new class extends N{constructor(){super(31,"grass_seed",10145074,{density:1.5,state:t,movable:!0,tags:[w],brushSize:0,emissionDensity:1}),this.movement=new A({fallSpeed:1,slideAngle:!0,slideStability:.7})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;void 0===a.data.germTimer&&(a.data.germTimer=0);const n=s.getElement(e,t+1);if(!n||!["sand","wet_sand","stone","wood","fossil","salt"].includes(n.name))return this.movement.apply(e,t,s);if(a.data.germTimer++,a.data.germTimer>=30){let a=!1;for(let i=-2;i<=2;i++){for(let n=-2;n<=2;n++){const r=s.getElement(e+n,t+i);if(r&&"water"===r.name){a=!0;break}}if(a)break}const n=a?.05:.01;if(Math.random()<n)return s.setElement(e,t,s.registry.get("plant")),!0}return!1}}),ge.register(new class extends N{constructor(){super(17,"fish",16747586,{density:2.5,state:t,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[w,o],brushSize:0,emissionDensity:.2}),this.colorVariants=[16747586,16766720,16729156,2763306]}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(!a.data.swimDirection){a.data.swimDirection=Math.random()>.5?1:-1,a.data.swimTimer=0,a.data.outOfWaterTime=0,a.data.hunger=0,a.data.seekingFood=!1,a.data.restTimer=0,a.data.age=0,a.data.surfaceTimer=0,a.data.feedingStartTime=null,a.data.feedingCooldown=0,a.data.cachedSurfaceY=null,a.data.cachedFoodLocation=null,a.data.cachedNearbyFishCount=0,a.data.cacheFrame=0;const e=this.colorVariants[Math.floor(Math.random()*this.colorVariants.length)];a.data.fishColor=e}a.data.age++;const n=(s.frameCount+(e+t)%5)%5==0;if(!this.isInWater(e,t,s)){if(a.data.outOfWaterTime++,a.data.outOfWaterTime>300)return s.setElement(e,t,s.registry.get("ash")),!0;const n=s.getElement(e,t+1);if(n&&"empty"===n.name)return s.swap(e,t,e,t+1),!0;if(Math.random()>.95){const a=e+(Math.random()>.5?1:-1);if(s.isEmpty(a,t))return s.swap(e,t,a,t),!0}return!1}a.data.outOfWaterTime=0;let i=a.data.cachedNearbyFishCount;n&&(i=this.countNearbyFish(e,t,s,3),a.data.cachedNearbyFishCount=i);const r=i>4;a.data.feedingCooldown>0&&a.data.feedingCooldown--,null!==a.data.feedingStartTime&&a.data.age-a.data.feedingStartTime>=420&&(a.data.feedingCooldown=1250,a.data.feedingStartTime=null,a.data.seekingFood=!1),a.data.hunger=Math.min(100,a.data.hunger+.015);const o=a.data.hunger>=70;this.isNearCoral(e,t,s)&&a.data.hunger>0&&(a.data.hunger=Math.max(0,a.data.hunger-.007));let l=a.data.cachedSurfaceY;if(n&&(l=this.findSurfaceLevel(e,t,s),a.data.cachedSurfaceY=l),null!==l&&t<=l+10&&a.data.hunger<30?a.data.surfaceTimer++:a.data.surfaceTimer=0,a.data.surfaceTimer>900&&Math.random()>.3){const a=s.getElement(e,t+1);if(a&&"water"===a.name)return s.swap(e,t,e,t+1),!0}if(a.data.hunger>20&&0===a.data.feedingCooldown){let d=a.data.cachedFoodLocation;if(n&&(d=this.findNearbyFood(e,t,s),!d&&a.data.hunger>40&&(d=this.findNearbyCoral(e,t,s)),a.data.cachedFoodLocation=d),d){const[n,l]=d;if(null===a.data.feedingStartTime&&(a.data.feedingStartTime=a.data.age),Math.abs(n-e)<=1&&Math.abs(l-t)<=1){const d=s.getElement(n,l);if(d&&"coral"===d.name)return a.data.seekingFood=!1,a.data.cachedFoodLocation=null,a.data.feedingStartTime=null,!1;if(d&&("leaf"===d.name||"ash"===d.name||"tree_seed"===d.name))return s.setElement(n,l,s.registry.get("empty")),a.data.hunger=Math.max(0,a.data.hunger-70),a.data.seekingFood=!1,a.data.cachedFoodLocation=null,a.data.hunger<20&&!r&&!o&&i<3&&Math.random()<.05&&this.layEgg(e,t,s),!0}else if(a.data.seekingFood=!0,this.swimToward(e,t,n,l,s))return!0}else if(a.data.feedingStartTime=null,a.data.seekingFood=!1,a.data.hunger>60&&null!==l&&l<t-2&&Math.random()>.2){const a=s.getElement(e,t-1);if(a&&"water"===a.name)return s.swap(e,t,e,t-1),!0}}else a.data.seekingFood=!1;if(!a.data.seekingFood){const n=this.analyzeSchool(e,t,s);if(n.nearbyFish>0){const i=this.calculateSchoolDirection(e,t,n);if(Math.random()>.9&&i){const[n,r]=i,o=s.getElement(n,r);if(o&&"water"===o.name)return s.swap(e,t,n,r),a.data.swimDirection=Math.sign(n-e)||a.data.swimDirection,!0}}}if(a.data.swimTimer++,a.data.feedingCooldown>0||a.data.hunger<30){if(void 0===a.data.targetDepth||Math.random()>.99)if(null!==l){const e=s.height-l,t=Math.max(e-5,0);a.data.targetDepth=l+Math.floor(Math.random()*t)}else a.data.targetDepth=t;if(void 0!==a.data.targetDepth){const n=a.data.targetDepth-t;if(Math.abs(n)>2&&Math.random()>.6){const a=n>0?1:-1,i=s.getElement(e,t+a);if(i&&"water"===i.name)return s.swap(e,t,e,t+a),!0}}}if(a.data.restTimer>0){if(a.data.restTimer--,Math.random()>.85){const a=Math.random()>.5?1:-1,n=s.getElement(e+a,t);n&&"water"===n.name&&s.swap(e,t,e+a,t)}return!1}if(Math.random()>.985)return a.data.restTimer=30+Math.floor(60*Math.random()),!1;if(a.data.swimTimer>60&&Math.random()>.97&&(a.data.swimDirection*=-1,a.data.swimTimer=0),Math.random()>.7){const n=a.data.swimDirection;if(Math.random()>.3){const a=e+n,i=s.getElement(a,t);if(i&&"water"===i.name)return s.swap(e,t,a,t),!0;const r=Math.random()>.5?1:-1,o=s.getElement(a,t+r);if(o&&"water"===o.name)return s.swap(e,t,a,t+r),!0}if(Math.random()>.5){let a=0;for(let o=t+1;o<s.height;o++){const n=s.getElement(e,o);if(!n||"water"!==n.name){a=o-t-1;break}if(o-t>10){a=10;break}}let n=.5;a<=3?n=.85:a<=6&&(n=.7);const i=t+(Math.random()<n?-1:1),r=s.getElement(e,i);if(r&&"water"===r.name)return s.swap(e,t,e,i),!0}}return!1}countNearbyFish(e,t,s,a){let n=0;for(let i=-a;i<=a;i++)for(let r=-a;r<=a;r++){if(0===r&&0===i)continue;const a=s.getElement(e+r,t+i);a&&"fish"===a.name&&n++}return n}findSurfaceLevel(e,t,s){for(let a=t;a>=0;a--){const t=s.getElement(e,a);if(!t||"water"!==t.name)return a+1}return null}analyzeSchool(e,t,s){let a=0,n=0,i=0,r=0;for(let o=-3;o<=3;o++)for(let l=-3;l<=3;l++){if(0===l&&0===o)continue;const d=s.getElement(e+l,t+o);if(d&&"fish"===d.name){a++,n+=e+l,i+=t+o;const d=s.getCell(e+l,t+o);d&&d.data.swimDirection&&(r+=d.data.swimDirection)}}return a>0&&(n=Math.floor(n/a),i=Math.floor(i/a),r/=a),{nearbyFish:a,centerX:n,centerY:i,avgDirection:r}}calculateSchoolDirection(e,t,s){let a=e,n=t;const i=s.centerX-e,r=s.centerY-t,o=Math.sqrt(i*i+r*r);return o<3?(a=e-Math.sign(i),n=t-Math.sign(r)):o>5?(a=e+Math.sign(i),n=t+Math.sign(r)):(a=e+Math.sign(s.avgDirection||i),n=t),a=Math.max(e-1,Math.min(e+1,a)),n=Math.max(t-1,Math.min(t+1,n)),[a,n]}isInWater(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of a){const e=s.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}findNearbyFood(e,t,s){for(let a=-7;a<=7;a++)for(let n=-7;n<=7;n++){const i=s.getElement(e+n,t+a);if(i&&("leaf"===i.name||"ash"===i.name||"tree_seed"===i.name))return[e+n,t+a]}return null}swimToward(e,t,s,a,n){const i=s-e,r=a-t;if(Math.abs(r)>0&&Math.random()>.1){const s=r>0?1:-1,a=n.getElement(e,t+s);if(a&&"water"===a.name)return n.swap(e,t,e,t+s),!0}if(Math.abs(i)>0&&Math.random()>.1){const s=i>0?1:-1,a=n.getElement(e+s,t);if(a&&"water"===a.name)return n.swap(e,t,e+s,t),!0}if(Math.abs(i)>0&&Math.abs(r)>0){const s=i>0?1:-1,a=r>0?1:-1,o=n.getElement(e+s,t+a);if(o&&"water"===o.name)return n.swap(e,t,e+s,t+a),!0}return!1}layEgg(e,t,s){const a=[[0,1],[0,2],[-1,1],[1,1],[0,-1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1]];a.sort(()=>Math.random()-.5);for(const[n,i]of a){const a=e+n,r=t+i,o=s.getElement(a,r);if(o&&"water"===o.name)return s.setElement(a,r,s.registry.get("fish_egg")),!0}return!1}reproduce(e,t,s){const a=[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1],[0,-2],[0,2],[-2,0],[2,0]];a.sort(()=>Math.random()-.5);for(const[n,i]of a){const a=e+n,r=t+i,o=s.getElement(a,r);if(o&&"water"===o.name)return s.setElement(a,r,s.registry.get("fish")),!0}return!1}isNearCoral(e,t,s){for(let a=-3;a<=3;a++)for(let n=-3;n<=3;n++){const i=s.getElement(e+n,t+a);if(i&&"coral"===i.name)return!0}return!1}findNearbyCoral(e,t,s){for(let a=-8;a<=8;a++)for(let n=-8;n<=8;n++){const i=s.getElement(e+n,t+a);if(i&&"coral"===i.name)return[e+n,t+a]}return null}}),ge.register(new class extends N{constructor(){super(30,"fish_egg",9662683,{density:3,state:t,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[w,o],brushSize:0,emissionDensity:0})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(void 0===a.data.incubationTime&&(a.data.incubationTime=0,a.data.outOfWaterTime=0),!this.isInWater(e,t,s)){if(a.data.outOfWaterTime++,a.data.outOfWaterTime>180)return s.setElement(e,t,s.registry.get("ash")),!0;const n=s.getElement(e,t+1);return!(!n||"empty"!==n.name||(s.swap(e,t,e,t+1),0))}if(a.data.outOfWaterTime=0,a.data.incubationTime++,a.data.incubationTime>600)return this.countNearbyFish(e,t,s,8)>6?(s.setElement(e,t,s.registry.get("ash")),!0):(s.setElement(e,t,s.registry.get("fish")),!0);if(Math.random()>.8){const a=s.getElement(e,t+1);if(a&&"water"===a.name)return s.swap(e,t,e,t+1),!0}return!1}isInWater(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of a){const e=s.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}countNearbyFish(e,t,s,a){let n=0;for(let i=-a;i<=a;i++)for(let r=-a;r<=a;r++){if(0===r&&0===i)continue;const a=s.getElement(e+r,t+i);a&&"fish"===a.name&&n++}return n}}),ge.register(new class extends N{constructor(){super(42,"bird",16777215,{density:1.5,state:t,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[w,o],brushSize:0,emissionDensity:.2}),this.colorVariants=[16777215,16119285,15790320,15263976]}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;const n=s.dayNightCycle?s.dayNightCycle.getTime():.5,i=n>=.85||n<.2,r=n>=.2&&n<.3;if(!a.data.flyDirection){a.data.flyDirection=Math.random()>.5?1:-1,a.data.flyTimer=0,a.data.hunger=0,a.data.age=0,a.data.feedingCooldown=0,a.data.perchTimer=0,a.data.isPerching=!1,a.data.isSleeping=!1,a.data.altitude=t,a.data.glidePhase=0,a.data.cachedTreeLocation=null,a.data.cachedNearbyBirdCount=0,a.data.cacheFrame=0;const e=this.colorVariants[Math.floor(Math.random()*this.colorVariants.length)];a.data.birdColor=e}a.data.age++;const o=(s.frameCount+(e+t)%5)%5==0;a.data.feedingCooldown>0&&a.data.feedingCooldown--,a.data.hunger=Math.min(100,a.data.hunger+.015);let l=a.data.cachedNearbyBirdCount;o&&(l=this.countNearbyBirds(e,t,s,3),a.data.cachedNearbyBirdCount=l);const d=l>4,h=a.data.hunger>=70,c=s.seasonData,m=c?c.season:"summer",u=c?c.seasonProgress:0;if(c&&("autumn"===m&&u>.5&&(a.data.migrating=!0),a.data.migrating)){const a=s.getElement(e,t-1);if(a&&"empty"===a.name)return s.swap(e,t,e,t-1),!0;if(t<10)return s.setElement(e,t,s.registry.get("empty")),!0;const n=Math.random()>.5?1:-1;return!!s.isEmpty(e+n,t-1)&&(s.swap(e,t,e+n,t-1),!0)}if(i&&!a.data.isSleeping){if(this.canPerchAt(e,t,s))return a.data.isSleeping=!0,a.data.isPerching=!0,!1;{const a=this.findNearbyPerchSpot(e,t,s);if(a){const[n,i]=a;if(this.flyToward(e,t,n,i,s))return!0}else{const a=s.getElement(e,t+1);if(a&&"empty"===a.name)return s.swap(e,t,e,t+1),!0}}}if(r&&a.data.isSleeping&&(a.data.isSleeping=!1,a.data.isPerching=!1,a.data.perchTimer=0),a.data.isSleeping)return!1;if(a.data.isPerching){a.data.perchTimer++;const n=120+Math.floor(120*Math.random());if(!(a.data.perchTimer>n)){if(Math.random()>.98){const a=e+(Math.random()>.5?1:-1);if(this.canPerchAt(a,t,s))return s.swap(e,t,a,t),!0}return!1}a.data.isPerching=!1,a.data.perchTimer=0}const g=this.isEnclosed(e,t,s);if(g){const a=t+-1,n=s.getElement(e,a);if(n&&"empty"===n.name)return s.swap(e,t,e,a),!0;const i=Math.random()>.5?1:-1,r=s.getElement(e+i,a);if(r&&"empty"===r.name)return s.swap(e,t,e+i,a),!0}if(a.data.hunger>50&&0===a.data.feedingCooldown&&this.checkAdjacentSolid(e,t,s))return a.data.hunger=Math.max(0,a.data.hunger-50),a.data.feedingCooldown=600,a.data.hunger<20&&!d&&!h&&l<3&&Math.random()<.05&&this.layEgg(e,t,s),!1;if(!g&&!a.data.isPerching&&Math.random()>.995&&o){let n=a.data.cachedTreeLocation;if(o&&(n=this.findNearbyTree(e,t,s),a.data.cachedTreeLocation=n),n){const[i,r]=n;if(Math.abs(i-e)<=1&&r===t-1)return a.data.isPerching=!0,a.data.perchTimer=0,a.data.cachedTreeLocation=null,!1;if(this.flyToward(e,t,i,r-1,s))return!0}}a.data.flyTimer++,a.data.glidePhase+=.05;const f=e<15,p=e>s.width-15,y=t<15,w=t>s.height-15;if(f&&-1===a.data.flyDirection?a.data.flyDirection=1:p&&1===a.data.flyDirection&&(a.data.flyDirection=-1),y?a.data.altitude=Math.max(a.data.altitude,Math.floor(.5*s.height)):w&&(a.data.altitude=Math.min(a.data.altitude,Math.floor(.6*s.height))),o&&Math.random()>.98){const e=Math.floor(.4*s.height),t=Math.floor(.7*s.height);a.data.altitude=e+Math.floor(Math.random()*(t-e))}if(a.data.flyTimer>60&&Math.random()>.97&&(a.data.flyDirection*=-1,a.data.flyTimer=0),Math.random()>.3){const n=.5*Math.sin(a.data.glidePhase),i=a.data.altitude-t;let r=.25;if(i<-5?r=.1:i>5&&(r=.7),n>.2&&(r-=.1),n<-.2&&(r+=.1),Math.random()>.5){const a=t+(Math.random()<r?1:-1),n=s.getElement(e,a);if(n&&"empty"===n.name&&!this.isDangerousNearby(e,a,s))return s.swap(e,t,e,a),!0}if(Math.random()>.2){const n=e+a.data.flyDirection,i=s.getElement(n,t);if(i&&"empty"===i.name&&!this.isDangerousNearby(n,t,s))return s.swap(e,t,n,t),!0;const r=Math.random()>.5?1:-1,o=s.getElement(n,t+r);if(o&&"empty"===o.name&&!this.isDangerousNearby(n,t+r,s))return s.swap(e,t,n,t+r),!0}}return!1}countNearbyBirds(e,t,s,a){let n=0;for(let i=-a;i<=a;i++)for(let r=-a;r<=a;r++){if(0===r&&0===i)continue;const a=s.getElement(e+r,t+i);a&&"bird"===a.name&&n++}return n}findNearbyTree(e,t,s){for(let a=-7;a<=7;a++)for(let n=-7;n<=7;n++){const i=s.getElement(e+n,t+a);if(i&&("tree_trunk"===i.name||"tree_branch"===i.name)){const i=s.getElement(e+n,t+a-1);if(i&&"empty"===i.name)return[e+n,t+a]}}return null}isDangerousNearby(e,t,s){for(let a=-1;a<=1;a++)for(let n=-1;n<=1;n++){const i=s.getElement(e+n,t+a);if(i&&("lava"===i.name||"fire"===i.name))return!0}return!1}flyToward(e,t,s,a,n){const i=s-e,r=a-t;if(Math.abs(r)>0&&Math.random()>.1){const s=r>0?1:-1,a=n.getElement(e,t+s);if(a&&"empty"===a.name&&!this.isDangerousNearby(e,t+s,n))return n.swap(e,t,e,t+s),!0}if(Math.abs(i)>0&&Math.random()>.1){const s=i>0?1:-1,a=n.getElement(e+s,t);if(a&&"empty"===a.name&&!this.isDangerousNearby(e+s,t,n))return n.swap(e,t,e+s,t),!0}if(Math.abs(i)>0&&Math.abs(r)>0){const s=i>0?1:-1,a=r>0?1:-1,o=n.getElement(e+s,t+a);if(o&&"empty"===o.name&&!this.isDangerousNearby(e+s,t+a,n))return n.swap(e,t,e+s,t+a),!0}return!1}layEgg(e,t,s){const a=[[0,1],[0,2],[-1,1],[1,1],[-1,0],[1,0],[-1,-1],[1,-1]];a.sort(()=>Math.random()-.5);for(const[n,i]of a){const a=e+n,r=t+i,o=s.getElement(a,r);if(o&&"empty"===o.name)return s.setElement(a,r,s.registry.get("bird_egg")),!0}return!1}canPerchAt(e,t,s){const a=s.getElement(e,t+1);return!!a&&["tree_trunk","tree_branch","wood","stone","wall","sand","wet_sand"].includes(a.name)}isEnclosed(e,t,s){let a=0;for(let n=-2;n<=2;n++)for(let i=-2;i<=2;i++){if(0===i&&0===n)continue;const r=s.getElement(e+i,t+n);r&&"empty"!==r.name&&"lava"!==r.name&&"fire"!==r.name&&"bird"!==r.name&&"fish"!==r.name&&a++}return a>16}checkAdjacentSolid(e,t,s){const a=[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];for(const[n,i]of a){const a=s.getElement(e+n,t+i);if(a&&"empty"!==a.name&&"lava"!==a.name&&"fire"!==a.name&&"water"!==a.name&&"acid"!==a.name&&"bird"!==a.name&&"fish"!==a.name)return!0}return!1}findNearbyPerchSpot(e,t,s){for(let a=10;a>=-10;a--)for(let n=-10;n<=10;n++){const i=t+a,r=e+n,o=s.getElement(r,i);if(o&&"empty"===o.name){const e=s.getElement(r,i+1);if(e&&"empty"!==e.name&&"lava"!==e.name&&"fire"!==e.name&&"water"!==e.name&&"acid"!==e.name)return[r,i]}}return null}}),ge.register(new class extends N{constructor(){super(43,"bird_egg",15787660,{density:3,state:t,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[w,o],brushSize:0,emissionDensity:0})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(void 0===a.data.incubationTime&&(a.data.incubationTime=0,a.data.onGround=!1),!this.isOnSolidSurface(e,t,s)){const a=s.getElement(e,t+1);return!(!a||"empty"!==a.name||(s.swap(e,t,e,t+1),0))}return a.data.onGround=!0,a.data.incubationTime++,a.data.incubationTime>600&&(this.countNearbyBirds(e,t,s,8)>6?(s.setElement(e,t,s.registry.get("ash")),!0):(s.setElement(e,t,s.registry.get("bird")),!0))}isOnSolidSurface(e,t,s){const a=s.getElement(e,t+1);return!!a&&["tree_trunk","tree_branch","wood","stone","wall","sand","wet_sand","ash","fossil","coal","obsidian","glass","ice","leaf"].includes(a.name)}countNearbyBirds(e,t,s,a){let n=0;for(let i=-a;i<=a;i++)for(let r=-a;r<=a;r++){if(0===r&&0===i)continue;const a=s.getElement(e+r,t+i);a&&"bird"===a.name&&n++}return n}}),ge.register(new class extends N{constructor(){super(34,"coral",16739229,{density:8,state:t,movable:!1,ignitionResistance:.9,burnsInto:"ash",tags:[w,o],brushSize:1,emissionDensity:.5})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(void 0===a.data.growthStage&&(a.data.growthStage=0,a.data.outOfWaterTime=0,a.data.age=0,a.data.branchLength=0,a.data.coralId=Math.random(),a.data.health=100),a.data.age++,(s.frameCount+(7*e+13*t)%5)%5!=0&&a.data.age>10)return!1;if(this.isInWater(e,t,s)){if(a.data.outOfWaterTime=0,Math.random()<.001&&(a.data.health-=1),a.data.health<=0)return s.setElement(e,t,s.registry.get("stone")),!0;Math.random()>.97&&a.data.growthStage++;const n=this.countNearbyCoral(e,t,s);if(n>12)return Math.random()<.005&&(a.data.health-=5),!1;if(a.data.growthStage>=5&&n<10&&Math.random()>.995){const n=this.calculateBranchLength(e,t,s);if(n>=5+Math.floor(5*Math.random()))return!1;const i=[];i.push([e-1,t],[e+1,t],[e-1,t],[e+1,t]),i.push([e,t+1],[e-1,t+1],[e+1,t+1]),Math.random()>.8&&i.push([e,t-1]),i.sort(()=>Math.random()-.5);for(const[e,t]of i){const i=s.getElement(e,t);if(i&&"water"===i.name&&this.hasNearbySupport(e,t,s)){const i=s.registry.get("coral");s.setElement(e,t,i);const r=s.getCell(e,t);return r&&(r.data.coralId=a.data.coralId,r.data.branchLength=n+1,r.data.health=80+Math.floor(20*Math.random())),!0}}}}else if(a.data.outOfWaterTime++,a.data.outOfWaterTime>300)return s.setElement(e,t,s.registry.get("stone")),!0;return!1}countNearbyCoral(e,t,s){let a=0;for(let n=-5;n<=5;n++)for(let i=-5;i<=5;i++){if(0===i&&0===n)continue;const r=s.getElement(e+i,t+n);r&&"coral"===r.name&&a++}return a}calculateBranchLength(e,s,a){const n=new Set,i=[[e,s,0]];for(;i.length>0&&n.size<50;){const[e,s,r]=i.shift(),o=`${e},${s}`;if(n.has(o))continue;n.add(o);const l=a.getElement(e,s);if(l&&"coral"!==l.name&&l.state===t)return r;l&&"coral"===l.name&&r<15&&(i.push([e-1,s,r+1]),i.push([e+1,s,r+1]),i.push([e,s-1,r+1]),i.push([e,s+1,r+1]))}return 0}hasNearbySupport(e,s,a){const n=[[e,s-1],[e,s+1],[e-1,s],[e+1,s],[e-1,s-1],[e+1,s-1],[e-1,s+1],[e+1,s+1]];for(const[i,r]of n){const e=a.getElement(i,r);if(e&&(e.state===t||"coral"===e.name))return!0}return!1}isInWater(e,t,s){const a=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of a){const e=s.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}}),ge.register(new class extends N{constructor(){super(41,"house_seed",16766720,{density:5,state:t,tags:[o],ignitionResistance:.5,burnsInto:"ash",brushSize:1,emissionDensity:.1})}updateImpl(e,s,n){const i=n.getCell(e,s);if(!i)return!1;if(i.data._houseConstruction){if(i.data._constructionActive)return!1;if(i.data.buildCooldown||(i.data.buildCooldown=600),i.data.buildCooldown>0)return i.data.buildCooldown--,!1;delete i.data._houseConstruction,delete i.data.buildCooldown,i.data.initiated=!1,i.data.settled=!1,i.data.wanderAttempts=0}i.data.initiated||(i.data.initiated=!0,i.data.settled=!1,i.data.wanderAttempts=0,i.data.maxWanderAttempts=100,i.data.wanderDirection=Math.random()>.5?1:-1);const r=n.getElement(e,s+1);if(r&&(0===r.id||"liquid"===r.state))return n.swap(e,s,e,s+1),i.data.settled=!1,!0;if(r&&0!==r.id&&"liquid"!==r.state){const t=Math.random()>.5?1:-1,a=n.getElement(e+t,s+1),r=n.getElement(e+t,s);if(a&&r&&(0===a.id||"liquid"===a.state)&&(0===r.id||"liquid"===r.state))return n.swap(e,s,e+t,s+1),i.data.settled=!1,!0}if(!i.data.settled&&r&&(r.state===t||r.state===a))return i.data.settled=!0,i.data.buildDelay=5,!1;if(i.data.settled&&void 0!==i.data.buildDelay){if(i.data.buildDelay>0)return i.data.buildDelay--,!1;if(this.isGoodBuildingSpot(e,s,n))return this.handleBuilding(i,e,s,n);{if(i.data.wanderAttempts++,i.data.wanderAttempts>=i.data.maxWanderAttempts)return n.setElement(e,s,n.registry.get("ash")),!0;i.data.settled=!1,i.data.buildDelay=void 0;const t=i.data.wanderDirection,r=n.getElement(e+t,s),o=n.getElement(e+t,s+1),l=n.getElement(e+t,s-1);if(r&&0===r.id&&o&&0!==o.id)return n.swap(e,s,e+t,s),!0;if(r&&0!==r.id&&l&&0===l.id){const a=n.getElement(e+t,s-1);if(a&&0===a.id)return n.swap(e,s,e+t,s-1),!0}return r&&r.state===a?(n.setElement(e+t,s,n.registry.get("empty")),n.swap(e,s,e+t,s),!0):!r||"ash"!==r.name&&"leaf"!==r.name?(i.data.wanderDirection*=-1,!1):(n.setElement(e+t,s,n.registry.get("empty")),n.swap(e,s,e+t,s),!0)}}return!1}isGoodBuildingSpot(e,s,n){let i=0;for(let t=-1;t<=3;t++){const a=n.getElement(e,s+t);if(a&&"water"===a.name)return!1}for(let t=-1;t<10;t++)for(let a=-2;a<=2;a++){if(0===a&&t>=-1&&t<=3)continue;const r=n.getElement(e+a,s+t);r&&"water"===r.name&&i++}if(i>2)return!1;const r=["tree_trunk","tree_branch","leaf"];for(let t=-1;t<10;t++)for(let a=-2;a<=2;a++){const i=n.getElement(e+a,s+t);if(i&&r.includes(i.name))return!1}let o=0;for(let d=-2;d<=2;d++){const i=n.getElement(e+d,s+1);!i||i.state!==t&&i.state!==a||o++}if(o<3)return!1;let l=!0;for(let a=1;a<=5;a++){const i=n.getElement(e,s-a);if(i&&0!==i.id&&i.state===t){l=!1;break}}return!!l}handleBuilding(e,t,s,a){const n=s+1;if(!a.isInBounds(t,n))return!1;if(!a.getElement(t,n))return!1;const i=a.registry.get("stone");if(!i)return!1;a.setElement(t,n,i);const r=a.getCell(t,n);if(!r)return!1;r.data._houseConstruction={centerX:t,baseY:n,buildPhase:"ground_fill",buildStep:0,buildTimer:0,builderX:null,builderY:null},a.registerConstruction(t,n);const o=t+3*(Math.random()>.5?1:-1),l=a.getElement(o,s);let d=t,h=s;l&&0===l.id&&(a.swap(t,s,o,s),d=o),r.data._houseConstruction.builderX=d,r.data._houseConstruction.builderY=h;const c=a.getCell(d,h);return c&&(c.data._houseConstruction=!0,c.data._constructionActive=!0),!0}}),ge.register(new class extends N{constructor(){super(9,"burning_wood",16729344,{density:5,state:t,movable:!1,lifetime:1500,ignitionResistance:.95,burnsInto:"fire",tags:[l,o]}),this.addBehavior(new X({lifetime:1500,spreadChance:.12,spreadIntensity:1,burnsInto:"ash"})),this.addBehavior(new $({emitElement:"fire",emissionRate:.15,directions:[[0,-1]],stages:[{until:.33,rate:.15},{until:.66,rate:.2},{until:1,rate:.07}]})),this.addBehavior(new $({emitElement:"smoke",emissionRate:.01,directions:[[-1,-1],[1,-1]],stages:[{until:.33,rate:.01},{until:.66,rate:.02},{until:1,rate:.03}]}))}updateImpl(e,t,s){return this.applyBehaviors(e,t,s)}}),ge.register(new class extends N{constructor(){super(30,"burning_coal",16729344,{density:5,state:t,movable:!1,tags:[l,d],brushSize:0,emissionDensity:0}),this.addBehavior(new X({lifetime:1800,spreadChance:.1,burnsInto:"ash"})),this.addBehavior(new $({emitElement:"fire",emissionRate:.25,stages:[{until:.2,rate:.3},{until:.8,rate:.25},{until:1,rate:.1}],directions:[[0,-1],[-1,-1],[1,-1]]})),this.addBehavior(new $({emitElement:"smoke",emissionRate:.08,directions:[[0,-1]]})),this.addBehavior(new U({extinguishesTo:"coal",waterToSteamChance:.5,extinguishChance:1,waterSources:["water"]}))}updateImpl(e,t,s){return this.applyBehaviors(e,t,s)}}),ge.register(new class extends N{constructor(){super(13,"cloud",15790320,{density:0,state:i,dispersion:1,lifetime:2400,tags:[],brushSize:3,emissionDensity:.5}),this.atmosphereThreshold=.4}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;void 0===a.data.saturation&&(a.data.saturation=1),void 0===a.data.waterCapacity&&(a.data.waterCapacity=a.data.saturation),void 0===a.data.canRain&&(a.data.canRain=Math.random()<.4),void 0===a.data.rainCooldown&&(a.data.rainCooldown=0),void 0===a.data.cloudAge&&(a.data.cloudAge=0),a.data.cloudAge++;const n=t<Math.floor(s.height*this.atmosphereThreshold);if(Math.random()>.85&&a.data.saturation<20){const n=this.findNearbySteam(e,t,s);n&&(s.setElement(n[0],n[1],s.registry.get("empty")),a.data.saturation=Math.min(a.data.saturation+1,20),a.data.waterCapacity=Math.min(a.data.waterCapacity+1,20),this.updateCloudColor(a))}if(Math.random()>.9){const n=this.findAdjacentCloud(e,t,s);if(n){const[e,t]=n,i=s.getCell(e,t);i&&void 0!==i.data.saturation&&a.data.saturation+i.data.saturation<=15&&(a.data.saturation+=i.data.saturation,a.data.waterCapacity+=i.data.waterCapacity||i.data.saturation,s.setElement(e,t,s.registry.get("empty")),this.updateCloudColor(a))}}if(void 0===a.data.lightningCooldown&&(a.data.lightningCooldown=0),a.data.lightningCooldown>0)a.data.lightningCooldown--;else if(a.data.saturation>=12&&Math.random()<8e-4){const n=s.getElement(e,t+1);n&&"empty"===n.name&&(s.setElement(e,t+1,s.registry.get("electricity")),a.data.lightningCooldown=180+Math.floor(120*Math.random()))}const i=480+Math.floor(240*Math.random()),r=a.data.cloudAge>=i;if(a.data.rainCooldown>0)a.data.rainCooldown--;else if(r&&a.data.canRain)if(a.data.waterCapacity>0){const n=a.data.isSnowCloud?10:12;if(a.data.saturation>=n){const n=this.triggerRainEvent(e,t,s,a);if(a.data.saturation-=n,a.data.waterCapacity-=n,a.data.rainCooldown=60+Math.floor(60*Math.random()),this.updateCloudColor(a),a.data.saturation<=0)return s.setElement(e,t,s.registry.get("empty")),!0}else if(a.data.saturation>=8){const n=a.data.isSnowCloud?.02:.005;Math.random()<n&&(this.dropSingleRain(e,t,s)&&(a.data.saturation-=1,a.data.waterCapacity-=1),a.data.rainCooldown=30,this.updateCloudColor(a))}}else if(a.data.waterCapacity<=0&&Math.random()<.01)return s.setElement(e,t,s.registry.get("empty")),!0;if(n){const a=s.seasonData;let n=.4,i=Math.random()>.5?1:-1;if(a&&a.windVector&&(n+=.1*a.windStrength,i=a.windDirection>0?1:-1),Math.random()<n){if(s.isEmpty(e+i,t))return s.swap(e,t,e+i,t),!0;if(s.isEmpty(e-i,t))return s.swap(e,t,e-i,t),!0}return!!(Math.random()>.92&&s.isEmpty(e,t-1))&&(s.swap(e,t,e,t-1),!0)}{if(s.isEmpty(e,t-1))return s.swap(e,t,e,t-1),!0;const a=Math.random()>.5?1:-1;return s.isEmpty(e+a,t-1)?(s.swap(e,t,e+a,t-1),!0):!!s.isEmpty(e-a,t-1)&&(s.swap(e,t,e-a,t-1),!0)}}findNearbySteam(e,t,s){for(let a=-3;a<=3;a++)for(let n=-3;n<=3;n++){if(0===n&&0===a)continue;const i=s.getElement(e+n,t+a);if(i&&"steam"===i.name)return[e+n,t+a]}return null}findAdjacentCloud(e,t,s){const a=[[e-1,t],[e+1,t],[e,t-1],[e,t+1]];for(const[n,i]of a){const e=s.getElement(n,i);if(e&&"cloud"===e.name)return[n,i]}return null}triggerRainEvent(e,t,s,a){const n=!0===a.data.isSnowCloud,i=n?8+Math.floor(8*Math.random()):1+Math.floor(3*Math.random()),r=Math.min(i,a.data.waterCapacity),o=s.registry.get(n?"snow":"water");if(!o)return 0;let l=0;for(let d=1;d<=3&&l<r;d++)for(let a=-1;a<=1&&l<r;a++){const n=s.getCell(e+a,t+d);n&&0===n.element.id&&(s.setElement(e+a,t+d,o),l++)}return l}dropSingleRain(e,t,s){const a=s.getCell(e,t),n=a&&a.data&&!0===a.data.isSnowCloud,i=s.registry.get(n?"snow":"water");if(!i)return!1;const r=s.getCell(e,t+1);return!(!r||0!==r.element.id||(s.setElement(e,t+1,i),0))}updateCloudColor(e){const t=e.data.saturation;let s;s=t<=1?240:t<=5?208:t<=10?176:144,e.element.color=s<<16|s<<8|s}}),ge.register(new class extends N{constructor(){super(33,"steam_vent",5592405,{density:10,state:t,movable:!1,ignitionResistance:1,tags:[b],brushSize:1,emissionDensity:.8})}updateImpl(e,t,s){const a=s.getCell(e,t);if(!a)return!1;if(void 0===a.data.ventTimer&&(a.data.ventTimer=0,a.data.ventCycle=Math.floor(60*Math.random())+30,a.data.ventActive=!1,a.data.ventDuration=0),a.data.ventTimer++,!a.data.ventActive&&a.data.ventTimer>=a.data.ventCycle&&(a.data.ventActive=!0,a.data.ventDuration=Math.floor(40*Math.random())+20,a.data.ventTimer=0),a.data.ventActive){if(a.data.ventDuration--,Math.random()<.8){const a=s.getElement(e,t-1);if(a&&"empty"===a.name)return s.setElement(e,t-1,s.registry.get("steam")),!0}a.data.ventDuration<=0&&(a.data.ventActive=!1,a.data.ventCycle=Math.floor(60*Math.random())+30,a.data.ventTimer=0)}return!1}});class fe{constructor(){this.data={}}incrementTimer(e,t=1/0){return void 0===this.data[e]&&(this.data[e]=0),this.data[e]++,this.data[e]>=t}getTimer(e){return this.data[e]||0}resetTimer(e){this.data[e]=0}setTimer(e,t){this.data[e]=t}setState(e){this.data.state=e}getState(){return this.data.state}isState(e){return this.data.state===e}adjustTemperature(e){return void 0===this.data.temperature&&(this.data.temperature=0),this.data.temperature+=e,this.data.temperature}getTemperature(){return this.data.temperature||0}setTemperature(e){this.data.temperature=e}get(e,t=void 0){return void 0!==this.data[e]?this.data[e]:t}set(e,t){this.data[e]=t}has(e){return void 0!==this.data[e]}delete(e){delete this.data[e]}clear(){this.data={}}serialize(){return{...this.data}}deserialize(e){this.data={...e}}}class pe{static updateConstructions(e){for(const t of e.activeConstructions){const s=e.keyToCoord(t),a=e.getCell(s.x,s.y);a&&a.data._houseConstruction&&this.updateConstruction(a,s.x,s.y,e)}}static updateConstruction(e,t,s,a){const n=e.data._houseConstruction;if(n&&"object"==typeof n&&(n.buildTimer++,n.buildTimer%1==0))switch(n.buildPhase){case"ground_fill":this.fillGround(n,a);break;case"foundation":this.buildFoundation(n,a);break;case"floor1":this.buildFloor1(n,a);break;case"floor2":this.buildFloor2(n,a);break;case"roof":this.buildRoof(n,a);break;case"complete":delete e.data._houseConstruction,a.unregisterConstruction(t,s)}}static fillGround(e,s){const n=e.centerX,i=e.baseY;if(0===e.buildStep){let r=i;for(let e=-2;e<=2;e++){const o=n+e;for(let e=i;e<Math.min(i+10,s.height);e++){const n=s.getElement(o,e);if(n&&(n.state===t||n.state===a))break;e>r&&(r=e)}}return e.targetBaseY=r,void e.buildStep++}const r=e.targetBaseY,o=e.buildStep-1;if(o<5){const i=n-2+o;for(let e=r;e<s.height;e++){const n=s.getElement(i,e);if(n&&(n.state===t||n.state===a))break;!n||0!==n.id&&"liquid"!==n.state||s.setElement(i,e,s.registry.get("stone"))}e.buildStep++}else e.buildPhase="foundation",e.buildStep=0,e.baseY=r}static buildFoundation(e,t){const s=e.centerX,a=e.baseY,n=e.buildStep;if(n<5){const i=s-2+n;this.forcePlaceBlock(i,a,"stone",t),e.buildStep++}else e.buildPhase="floor1",e.buildStep=0,e.currentY=a-1}static buildFloor1(e,t){const s=e.centerX,a=e.currentY,n=e.buildStep;if(n<3){const i=a-n;this.forcePlaceBlock(s-2,i,"wood",t),e.buildStep++}else if(n<6){const i=a-(n-3);this.forcePlaceBlock(s+2,i,"wood",t),e.buildStep++}else if(n<11){const i=s-2+(n-6),r=a-3;this.forcePlaceBlock(i,r,"wood",t),e.buildStep++}else e.buildPhase="floor2",e.buildStep=0,e.currentY=a-3-1}static buildFloor2(e,t){const s=e.centerX,a=e.currentY,n=e.buildStep;if(n<3){const i=a-n,r=n===Math.floor(1.5)?"glass":"wood";this.forcePlaceBlock(s-2,i,r,t),e.buildStep++}else if(n<6){const i=a-(n-3),r=n-3===Math.floor(1.5)?"glass":"wood";this.forcePlaceBlock(s+2,i,r,t),e.buildStep++}else if(n<11){const i=s-2+(n-6),r=a-3;this.forcePlaceBlock(i,r,"wood",t),e.buildStep++}else e.buildPhase="roof",e.buildStep=0,e.roofBaseY=a-3-1}static buildRoof(e,t){const s=e.centerX,a=e.roofBaseY,n=e.buildStep,i=[[-2,2],[-1,1],[0]];if(n<5){let r=0;for(let o=0;o<i.length;o++)for(let l of i[o]){if(r===n){const n=s+l,i=a-o;return this.forcePlaceBlock(n,i,"stone",t),void e.buildStep++}r++}}else{t.houses||(t.houses=[]);const a=[{x:s-1,y:e.currentY-1},{x:s+1,y:e.currentY-1}],n=Math.random()<.3;if(t.houses.push({centerX:s,baseY:e.baseY,windows:a,lightsOn:!1,hasBuilder:!1,isLateNighter:n}),null!==e.builderX&&null!==e.builderY){const s=t.getCell(e.builderX,e.builderY);s&&"house_seed"===s.element.name&&delete s.data._constructionActive}e.buildPhase="complete"}}static forcePlaceBlock(e,t,s,a){if(!a.isInBounds(e,t))return!1;const n=a.getCell(e,t);if(!n)return!1;const i=n.data._houseConstruction;if(a.setElement(e,t,a.registry.get(s)),i){const s=a.getCell(e,t);s&&(s.data._houseConstruction=i)}return!0}}class ye{static previousTimeState=null;static builderSpawnFrameCounter=0;static updateHouseLights(e,t){if(!e.houses||0===e.houses.length)return;let s;if(this.builderSpawnFrameCounter++,this.builderSpawnFrameCounter>=60&&(this.builderSpawnFrameCounter=0,t>.3&&t<.6&&Math.random()<.003&&this.spawnBuilderFromHouse(e)),this.integrityCheckCounter||(this.integrityCheckCounter=0),this.integrityCheckCounter++,this.integrityCheckCounter>=60&&(this.integrityCheckCounter=0,this.checkAndRemoveDestroyedHouses(e)),s=t>=.3&&t<=.7?"day":t>.7&&t<.85?"evening":t>=.85||t<.2?"night":"morning",this.previousTimeState!==s){for(const t of e.houses)"day"===s?this.turnOffLights(t,e):"evening"===s?this.turnOnLights(t,e,!1):"morning"===s&&(t.isLateNighter||this.turnOffLights(t,e));this.previousTimeState=s}if("night"===s)for(const a of e.houses){const t=a.isLateNighter?.001:.006;Math.random()<t&&this.turnOffRandomLight(a,e)}}static turnOnLights(e,t,s=!1){const a=t.registry.get("light");if(a){e.lightColors||(e.lightColors=e.windows.map(()=>this.randomLightColor()));for(let s=0;s<e.windows.length;s++){const n=e.windows[s],i=t.getElement(n.x,n.y);if(i&&0===i.id){t.setElement(n.x,n.y,a);const i=t.getCell(n.x,n.y);i&&(i.data.lightColor=e.lightColors[s])}}e.lightsOn=!0}}static randomLightColor(){const e=[16777215,16775408,16774368,16771280,16765120,16767208,16769279,15790320];return e[Math.floor(Math.random()*e.length)]}static turnOffLights(e,t){for(const s of e.windows){const e=t.getElement(s.x,s.y);e&&"light"===e.name&&t.setElement(s.x,s.y,t.registry.get("empty"))}e.lightsOn=!1}static turnOffRandomLight(e,t){const s=e.windows.filter(e=>{const s=t.getElement(e.x,e.y);return s&&"light"===s.name});if(s.length>0){const a=e.isLateNighter?.6:.2,n=e.isLateNighter?.8:.3;if(Math.random()<a)return;if(1===s.length&&Math.random()<n)return;const i=s[Math.floor(Math.random()*s.length)];t.setElement(i.x,i.y,t.registry.get("empty"))}}static spawnBuilderFromHouse(e){if(!e.houses||0===e.houses.length)return;const t=e.houses[Math.floor(Math.random()*e.houses.length)];if(t.hasBuilder)return;const s=t.centerX;for(let a=t.baseY-10;a<t.baseY;a++){const n=e.getElement(s,a),i=e.getElement(s,a+1);if(n&&0===n.id&&i&&"stone"===i.name){const n=e.registry.get("house_seed");return void(n&&(e.setElement(s,a,n),t.hasBuilder=!0,setTimeout(()=>{t.hasBuilder=!1},18e4)))}}}static checkAndRemoveDestroyedHouses(e){e.houses&&0!==e.houses.length&&(e.houses=e.houses.filter(t=>{const s=[{x:t.centerX-2,y:t.baseY-1},{x:t.centerX-2,y:t.baseY-2},{x:t.centerX+2,y:t.baseY-1},{x:t.centerX+2,y:t.baseY-2},{x:t.centerX,y:t.baseY}];let a=0;const n=["wood","glass","stone"];for(const i of s){const t=e.getElement(i.x,i.y);t&&n.includes(t.name)&&a++}return!(a<2&&(this.turnOffLights(t,e),1))}))}}class we{constructor(e,t,s,a){this.width=Math.floor(e/s),this.height=Math.floor(t/s),this.pixelSize=s,this.registry=a,this.grid=[],this.particleCount=0,this.frameCount=0,this.boulderCache=new Map,this.activeCells=new Map,this.activeConstructions=new Set,this.neighborOffsets=[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1]];const n=this.registry.get("empty");for(let i=0;i<this.height;i++){this.grid[i]=[];for(let e=0;e<this.width;e++)this.grid[i][e]={element:n,lifetime:-1,updated:!1,state:new fe,data:{}}}}coordToKey(e,t){return t*this.width+e}keyToCoord(e){return{x:e%this.width,y:Math.floor(e/this.width)}}registerConstruction(e,t){const s=this.coordToKey(e,t);this.activeConstructions.add(s)}unregisterConstruction(e,t){const s=this.coordToKey(e,t);this.activeConstructions.delete(s)}getCell(e,t){return e<0||e>=this.width||t<0||t>=this.height?null:this.grid[t][e]}getElement(e,t){const s=this.getCell(e,t);return s?s.element:null}setElement(e,t,s,a=!1,n=null){if(e<0||e>=this.width||t<0||t>=this.height)return;if(!s)return;const i=this.grid[t][e],r=0===i.element.id,o=0===s.id,l=i.data.boulderId,d=this.coordToKey(e,t),h=`${e},${t}`;if(void 0!==l){const e=this.boulderCache.get(l);e&&(e.delete(h),0===e.size&&this.boulderCache.delete(l))}r&&!o&&(this.particleCount++,this.activeCells.set(d,{x:e,y:t})),!r&&o&&(this.particleCount--,this.activeCells.delete(d)),i.element=s,i.lifetime=s.defaultLifetime,i.updated=!1,a||(i.state=new fe,i.data={},null!==n&&(i.data.boulderId=n,this.boulderCache.has(n)||this.boulderCache.set(n,new Set),this.boulderCache.get(n).add(h)),s.initializeCell&&"function"==typeof s.initializeCell&&s.initializeCell(i.data))}isEmpty(e,t){const s=this.getElement(e,t);return s&&0===s.id}isInBounds(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height}canMoveTo(e,t,s,n){if(!this.isInBounds(s,n))return!1;const i=this.getElement(e,t),r=this.getElement(s,n);return!(!i||!r)&&(0===r.id||(i.state!==a||r.state!==a)&&i.density>r.density&&r.movable)}swap(e,t,s,a){if(!this.isInBounds(e,t)||!this.isInBounds(s,a))return;const n=this.grid[t][e],i=this.grid[a][s],r=this.coordToKey(e,t),o=this.coordToKey(s,a),l=0===n.element.id,d=0===i.element.id;!l&&d?(this.activeCells.delete(r),this.activeCells.set(o,{x:s,y:a})):l&&!d&&(this.activeCells.delete(o),this.activeCells.set(r,{x:e,y:t})),this.grid[t][e]=i,this.grid[a][s]=n,this.grid[a][s].updated=!0}update(){this.frameCount++;const e=this.registry.get("stone");e&&e.processedBoulders&&e.processedBoulders.clear();for(const[a,n]of this.activeCells){const e=this.grid[n.y]?.[n.x];e&&(e.updated=!1)}const t=new Map;for(const[a,n]of this.activeCells){const e=n.y,s=n.x;t.has(e)||t.set(e,[]),t.get(e).push(s)}const s=Array.from(t.keys()).sort((e,t)=>t-e);for(const a of s){const e=t.get(a);Math.random()>.5?e.sort((e,t)=>e-t):e.sort((e,t)=>t-e);for(const t of e){const e=this.grid[a][t];e.updated||0===e.element.id||(e.lifetime>0&&(e.lifetime--,0===e.lifetime)?this.setElement(t,a,this.registry.get("empty")):(e.element.update(t,a,this),this.frameCount%2==0&&!1!==e.element.canInteract&&this.checkInteractions(t,a)))}}pe.updateConstructions(this),void 0!==this.timeOfDay&&ye.updateHouseLights(this,this.timeOfDay)}setTimeOfDay(e){this.timeOfDay=e,this.dayNightCycle||(this.dayNightCycle={getTime:()=>this.timeOfDay})}setSeasonData(e){this.seasonData=e}checkInteractions(e,t){const s=this.getElement(e,t);if(s&&0!==s.id)for(const[a,n]of this.neighborOffsets){const i=e+a,r=t+n,o=this.getElement(i,r);if(o&&0!==o.id&&this.registry.checkInteraction(s,o,this,e,t,i,r))return}}getBoulderPixels(e){const t=this.boulderCache.get(e);if(!t)return[];const s=[];for(const a of t){const[e,t]=a.split(",").map(Number);s.push({x:e,y:t,cell:this.grid[t][e]})}return s}canBoulderMoveDown(e){const t=this.getBoulderPixels(e);if(0===t.length)return!1;const s=this.registry.get("stone");for(const{x:a,y:n}of t){const t=n+1;if(t>=this.height)return!1;const i=this.grid[t][a],r=i.element;if(0!==r.id&&i.data.boulderId!==e&&!("liquid"===r.state&&s.density>r.density))return!1}return!0}moveBoulderDown(e){const t=this.getBoulderPixels(e);t.sort((e,t)=>t.y-e.y);const s=this.registry.get("empty"),a=this.registry.get("stone"),n=this.boulderCache.get(e);for(const{x:i,y:r}of t){const t=this.grid[r][i],o=this.grid[r+1][i],l=o.element;o.data.boulderId!==e&&(0!==l.id&&"liquid"===l.state&&a.density>l.density?(this.grid[r+1][i]={element:t.element,lifetime:t.lifetime,updated:!0,data:{boulderId:e}},this.grid[r][i]={element:l,lifetime:o.lifetime,updated:!0,data:o.data}):(this.grid[r+1][i]={element:t.element,lifetime:t.lifetime,updated:!0,data:{boulderId:e}},this.grid[r][i]={element:s,lifetime:-1,updated:!1,data:{}}),n&&(n.delete(`${i},${r}`),n.add(`${i},${r+1}`)))}}}class be{constructor(e=W){this.config=e;const t="random"===e.START_SEASON?function(){const e=W.SEASONS;return e[Math.floor(Math.random()*e.length)]}():e.START_SEASON;this.currentSeason=t,this.seasonTime=0,this.seasonLength=W.DAY_LENGTH*W.MONTH_LENGTH*W.SEASON_LENGTH,this.seasonProgress=0,this.currentTemp=this.getSeasonalTemp(t,.5),this.targetTemp=this.currentTemp,this.isTransitioning=!1,this.transitionProgress=0}update(e=1){this.seasonTime+=e,this.seasonProgress=this.seasonTime/this.seasonLength,this.seasonTime>=this.seasonLength&&this.advanceSeason(),this.updateTemperature(e),this.isTransitioning&&(this.transitionProgress+=.01,this.transitionProgress>=1&&(this.isTransitioning=!1,this.transitionProgress=0))}advanceSeason(){this.currentSeason,this.currentSeason=function(e){const t=W.SEASONS,s=t.indexOf(e);return t[(s+1)%t.length]}(this.currentSeason),this.seasonTime=0,this.seasonProgress=0,this.isTransitioning=!0,this.transitionProgress=0,this.targetTemp=this.getSeasonalTemp(this.currentSeason,.5)}updateTemperature(e){this.targetTemp=this.getSeasonalTemp(this.currentSeason,this.seasonProgress);const t=this.targetTemp-this.currentTemp;this.currentTemp+=t*this.config.TEMP_TRANSITION_SPEED*e}getSeasonalTemp(e,t){const s=this.config.TEMPERATURE[e];if(!s)return.5;const{min:a,max:n}=s;return(a+n)/2+Math.sin(t*Math.PI)*(n-a)/2}getCurrentSeason(){return this.currentSeason}getTemperature(){return this.currentTemp}getSeasonProgress(){return this.seasonProgress}isSeasonTransitioning(){return this.isTransitioning}getTransitionProgress(){return this.transitionProgress}shouldFreeze(){return this.currentTemp<0}shouldMelt(){return this.currentTemp>.5}getLeafColor(e=this.currentSeason){const t=this.config.LEAF_COLORS[e];return t&&0!==t.length?t[Math.floor(Math.random()*t.length)]:this.config.LEAF_COLORS.summer[0]}getTreeGrowthMultiplier(){return this.config.TREE_GROWTH_MULTIPLIER[this.currentSeason]||1}getTreeDecayChance(){return this.config.TREE_DECAY_CHANCE[this.currentSeason]||0}getLeafFallRate(){return this.config.LEAF_FALL_RATE[this.currentSeason]||0}getCloudSpawnMultiplier(){return this.config.CLOUD_SPAWN_MULTIPLIER[this.currentSeason]||1}shouldSpawnSnowClouds(){return"winter"===this.currentSeason&&Math.random()<this.config.SNOW_CLOUD_CHANCE}getIceMeltMultiplier(){return this.config.ICE_MELT_MULTIPLIER[this.currentSeason]||1}shouldBirdsMigrate(){return"autumn"===this.currentSeason&&this.seasonProgress>this.config.MIGRATION_START}isWinter(){return"winter"===this.currentSeason}isEarlySpring(){return"spring"===this.currentSeason&&this.seasonProgress<.2}getSkyTint(){return this.config.SKY_TINT[this.currentSeason]||{r:1,g:1,b:1}}getSunTint(){return this.config.SUN_TINT[this.currentSeason]||{r:1,g:1,b:1}}getDebugInfo(){return{season:this.currentSeason,progress:`${(100*this.seasonProgress).toFixed(1)}%`,temperature:this.currentTemp.toFixed(2),transitioning:this.isTransitioning,freezing:this.shouldFreeze(),melting:this.shouldMelt()}}serialize(){return{currentSeason:this.currentSeason,seasonTime:this.seasonTime,currentTemp:this.currentTemp}}deserialize(e){e.currentSeason&&(this.currentSeason=e.currentSeason),void 0!==e.seasonTime&&(this.seasonTime=e.seasonTime,this.seasonProgress=this.seasonTime/this.seasonLength),void 0!==e.currentTemp&&(this.currentTemp=e.currentTemp,this.targetTemp=e.currentTemp)}}class Me{constructor(e=W,t){this.config=e,this.seasonManager=t,this.direction=Math.random()>.5?1:-1,this.strength=2*Math.random(),this.changeTimer=0,this.targetDirection=this.direction,this.targetStrength=this.strength}update(e=1){this.config.WIND_ENABLED&&(this.changeTimer-=e,this.changeTimer<=0&&(this.generateNewWind(),this.resetChangeTimer()),this.smoothTransition(e))}generateNewWind(){const e=this.seasonManager.getCurrentSeason(),t=this.config.WIND_PATTERNS[e]||{strength:1,variability:1};Math.random()<.3&&(this.targetDirection=-this.targetDirection);const s=t.strength,a=t.variability,n=2*(Math.random()-.5);this.targetStrength=s+n*a,this.targetStrength=Math.max(this.config.WIND_STRENGTH_RANGE.min,Math.min(this.config.WIND_STRENGTH_RANGE.max,this.targetStrength)),("autumn"===e||"winter"===e)&&Math.random()<.2&&(this.targetStrength=Math.min(this.config.WIND_STRENGTH_RANGE.max,this.targetStrength+1.5)),"summer"===e&&Math.random()<.4&&(this.targetStrength=0)}resetChangeTimer(){const e=this.config.WIND_CHANGE_INTERVAL,t=this.seasonManager.getCurrentSeason();this.changeTimer="autumn"===t?e*(.5+.5*Math.random()):"summer"===t?e*(1.5+.5*Math.random()):e*(.8+.4*Math.random())}smoothTransition(e){if(this.direction!==this.targetDirection){const t=.1*e;Math.abs(this.direction-this.targetDirection)<t?this.direction=this.targetDirection:this.direction+=Math.sign(this.targetDirection-this.direction)*t}const t=this.targetStrength-this.strength;this.strength+=.02*t*e}getWindDirection(){return this.direction}getWindStrength(){return this.strength}getWindVector(){return{x:this.direction*this.strength*.3,y:0}}getWindProbabilityBoost(){return Math.min(1,this.strength/3)}isWindy(){return this.strength>1.5}isCalm(){return this.strength<.5}isBlowingEast(){return this.direction>0}isBlowingWest(){return this.direction<0}getWindDescription(){const e=this.isBlowingEast()?"East":"West";let t="Calm";return this.strength>2.5?t="Strong Gale":this.strength>2?t="Strong":this.strength>1.5?t="Moderate":this.strength>1?t="Gentle":this.strength>.5&&(t="Light"),`${t} ${e}`}getDebugInfo(){return{direction:this.direction>0?"East":"West",strength:this.strength.toFixed(2),description:this.getWindDescription(),nextChange:Math.ceil(this.changeTimer/60)}}serialize(){return{direction:this.direction,strength:this.strength,changeTimer:this.changeTimer}}deserialize(e){void 0!==e.direction&&(this.direction=e.direction),void 0!==e.strength&&(this.strength=e.strength,this.targetStrength=e.strength),void 0!==e.changeTimer&&(this.changeTimer=e.changeTimer)}}class Ee{constructor(){this.sunRadius=25,this.moonRadius=18,this.moonPhases=["new","waxing_crescent","first_quarter","waxing_gibbous","full","waning_gibbous","third_quarter","waning_crescent"],this.currentMoonPhaseIndex=Math.floor(8*Math.random()),this.lastPhaseChangeDay=-1}update(e,t){e>=.25&&e<.3&&t!==this.lastPhaseChangeDay&&(this.currentMoonPhaseIndex=(this.currentMoonPhaseIndex+1)%8,this.lastPhaseChangeDay=t)}getMoonPhaseIndex(){return this.currentMoonPhaseIndex}getMoonPhaseName(){return this.moonPhases[this.currentMoonPhaseIndex]}getMoonPhaseNormalized(){return this.currentMoonPhaseIndex/8}getSunPosition(e,t,s){const a=(s-.25)/.5*Math.PI;return{x:e/2+Math.cos(Math.PI-a)*e*.5,y:t-(.2+.75*Math.sin(a))*t}}getMoonPosition(e,t,s){const a=((s+.5)%1-.25)/.5*Math.PI;return{x:e/2+Math.cos(Math.PI-a)*e*.5,y:t-(.2+.75*Math.sin(a))*t}}isSunVisible(e){return e>.2&&e<.8}isMoonVisible(e){return e<.3||e>.7}renderSun(e,t,s,a){const n=1-.5*s,i=this.tintColor(16776960,a),r=this.tintColor(16753920,a),o=this.tintColor(16747520,a),l=this.tintColor(16739125,a);e.fillStyle(i,1*n),e.fillCircle(t.x,t.y,this.sunRadius),e.fillStyle(r,.4*n),e.fillCircle(t.x,t.y,1.4*this.sunRadius),e.fillStyle(o,.2*n),e.fillCircle(t.x,t.y,1.8*this.sunRadius),e.fillStyle(l,.1*n),e.fillCircle(t.x,t.y,2.2*this.sunRadius)}tintColor(e,t){const s=e>>16&255,a=e>>8&255,n=255&e;return Math.min(255,Math.floor(s*t.r))<<16|Math.min(255,Math.floor(a*t.g))<<8|Math.min(255,Math.floor(n*t.b))}renderMoon(e,t){const s=this.getMoonPhaseNormalized(),a=this.moonRadius,n=s*Math.PI*2,i=-Math.cos(n),r=(i+1)/2;if(r>.3){const s=.04*r;e.fillStyle(10526896,s),e.fillCircle(t.x,t.y,1.4*a)}if(r<.05)e.fillStyle(4868682,.4),e.fillCircle(t.x,t.y,a);else if(r>=.98)e.fillStyle(16119285,1),e.fillCircle(t.x,t.y,a);else{const n=s<.5,r=i;if(e.fillStyle(15263976,1),e.beginPath(),n){e.arc(t.x,t.y,a,-Math.PI/2,Math.PI/2,!1);const s=30;for(let n=0;n<=s;n++){const i=Math.PI/2-n/s*Math.PI,o=t.y+a*Math.sin(i),l=t.x-a*r*Math.cos(i);e.lineTo(l,o)}}else{e.arc(t.x,t.y,a,-Math.PI/2,Math.PI/2,!0);const s=30;for(let n=0;n<=s;n++){const i=Math.PI/2-n/s*Math.PI,o=t.y+a*Math.sin(i),l=t.x+a*r*Math.cos(i);e.lineTo(l,o)}}e.closePath(),e.fillPath()}}serialize(){return{currentMoonPhaseIndex:this.currentMoonPhaseIndex,lastPhaseChangeDay:this.lastPhaseChangeDay}}deserialize(e){void 0!==e.currentMoonPhaseIndex&&(this.currentMoonPhaseIndex=e.currentMoonPhaseIndex),void 0!==e.lastPhaseChangeDay&&(this.lastPhaseChangeDay=e.lastPhaseChangeDay)}}class ve extends s.Scene{constructor(){super("GameScene"),this.selectedElement="sand",this.isDrawing=!1,this.elementRegistry=ge,this.nextBoulderId=1,this.playerX=null,this.playerY=null,this.buildMode=!0,this.keys={}}create(){const{width:e,height:t}=this.sys.game.config;this.pixelSize=4,this.pixelGrid=new we(e,t,this.pixelSize,this.elementRegistry),this.dayNightCycle={time:.35,baseSpeed:.001},this.timeControl={speedLevels:[.1,.25,.5,1,2,5,10,20,50,100],currentSpeedIndex:3,maxPhysicsSpeed:5},this.currentDay=0,this.celestialManager=new Ee,this.weatherSystem={cloudiness:Math.random(),cloudSpawnTimer:0,cloudCoverage:0,nextCloudDay:Math.random()},this.seasonManager=new be(W),this.windManager=new Me(W,this.seasonManager),this.skyGraphics=this.add.graphics(),this.celestialGraphics=this.add.graphics(),this.graphics=this.add.graphics(),this.lavaGlowGraphics=this.add.graphics(),this.lightGlowGraphics=this.add.graphics(),this.overlayGraphics=this.add.graphics();const s=this.celestialGraphics.postFX.addGlow(16768324,2,0,!1,.1,5);this.celestialGlow=s;const a=this.lightGlowGraphics.postFX.addGlow(16768409,3,1,!1,.1,6);this.lightGlow=a;const n=this.lavaGlowGraphics.postFX.addGlow(16737792,6,2,!1,.1,8);this.lavaGlow=n,this.input.on("pointerdown",this.startDrawing,this),this.input.on("pointerup",this.stopDrawing,this),this.input.on("pointermove",this.draw,this),this.setupElementSelector(),this.fpsText=document.getElementById("fps"),this.particlesText=document.getElementById("particles"),this.versionText=document.getElementById("version"),this.modeDisplay=document.getElementById("mode-display"),this.seasonDisplay=document.getElementById("season-display"),this.speedDisplay=document.getElementById("speed-display"),this.versionText.textContent="4.2.3",this.updateModeDisplay();const i=document.getElementById("speed-down"),r=document.getElementById("speed-up");i&&i.addEventListener("click",()=>this.decreaseTimeSpeed()),r&&r.addEventListener("click",()=>this.increaseTimeSpeed()),this.createBorders()}createBorders(){const e=this.elementRegistry.get("wall");if(e){for(let t=0;t<this.pixelGrid.width;t++)for(let s=0;s<3;s++)this.pixelGrid.setElement(t,this.pixelGrid.height-1-s,e);for(let t=0;t<this.pixelGrid.height;t++)for(let s=0;s<3;s++)this.pixelGrid.setElement(s,t,e),this.pixelGrid.setElement(this.pixelGrid.width-1-s,t,e)}}resetWorld(){const e=this.elementRegistry.get("empty");for(let t=0;t<this.pixelGrid.height;t++)for(let s=0;s<this.pixelGrid.width;s++)this.pixelGrid.setElement(s,t,e);this.createBorders(),this.buildMode=!0,this.updateModeDisplay(),this.playerX=null,this.playerY=null}setupElementSelector(){const e=document.getElementById("element-selector"),t=document.getElementById("global-tooltip"),s=document.getElementById("tooltip-name"),a=document.getElementById("tooltip-props"),n=document.getElementById("tooltip-key");this.elementConfigs={sand:{icon:"",color:"#c2b280"},water:{icon:"",color:"#4a90e2"},stone:{icon:"",color:"#666"},wall:{icon:"",color:"#444"},fire:{icon:"",color:"#ff6b35"},wood:{icon:"",color:"#8b4513"},oil:{icon:"",color:"#3d3d1a"},gunpowder:{icon:"",color:"#333"},fossil:{icon:"",color:"#8b7355"},fish:{icon:"",color:"#1a5f7a"},bird:{icon:"",color:"#ffffff"},tree_seed:{icon:"",color:"#654321"},ash:{icon:"",color:"#999"},ice:{icon:"",color:"#87ceeb"},glass:{icon:"",color:"#add8e6"},lava:{icon:"",color:"#ff4500"},acid:{icon:"",color:"#7fff00"},vine:{icon:"",color:"#228b22"},snow:{icon:"",color:"#ffffff"},slush:{icon:"",color:"#b0e0e6"},coal:{icon:"",color:"#1a1a1a"},coral:{icon:"",color:"#ff6b9d"},steam_vent:{icon:"",color:"#555555"},house_seed:{icon:"",color:"#8b4513"},eraser:{icon:"",color:"#ff3333"}},[{name:"fire",key:"1"},{name:"steam_vent",key:"2"},{name:"water",key:"3"},{name:"oil",key:"4"},{name:"lava",key:"5"},{name:"acid",key:"6"},{name:"slush",key:"Y"},{name:"sand",key:"7"},{name:"gunpowder",key:"8"},{name:"snow",key:"9"},{name:"stone",key:"0"},{name:"wood",key:"Q"},{name:"ice",key:"W"},{name:"glass",key:"E"},{name:"wall",key:"R"},{name:"coal",key:"T"},{name:"tree_seed",key:"U"},{name:"vine",key:"I"},{name:"fish",key:"O"},{name:"bird",key:"L"},{name:"coral",key:"P"},{name:"house_seed",key:"A"},{name:"eraser",key:"X"}].forEach(({name:i,key:r},o)=>{const l=this.elementRegistry.get(i);if(!l&&"eraser"!==i)return;const d=this.elementConfigs[i],h=document.createElement("button");h.className="element-btn","sand"===i&&h.classList.add("active"),h.dataset.element=i,h.dataset.key=r,h.style.background=d.color,h.textContent=d.icon;const c=document.createElement("div");c.className="keybind",c.textContent=r,h.appendChild(c);const m=e=>{if(s.textContent=i.replace(/_/g," "),l){const e=this.generateElementDescription(l);a.textContent=e||l.state||""}else a.textContent="";n.textContent=r;const o=h.getBoundingClientRect();t.style.display="block";const d=t.getBoundingClientRect().width;let c=o.left+o.width/2,m="translateX(-50%)";c-d/2<10?(c=o.left,m="translateX(0)"):c+d/2>window.innerWidth-10&&(c=o.right,m="translateX(-100%)"),t.style.left=`${c}px`,t.style.bottom=window.innerHeight-o.top+10+"px",t.style.transform=m},u=()=>{t.style.display="none"};h.addEventListener("mouseenter",m),h.addEventListener("mouseleave",u);const g=()=>{document.querySelectorAll(".element-btn").forEach(e=>e.classList.remove("active")),h.classList.add("active"),this.selectedElement=i,u()};let f=0;h.addEventListener("touchstart",e=>{e.preventDefault(),f=Date.now(),m()}),h.addEventListener("touchend",e=>{e.preventDefault(),Date.now()-f<300?g():u()}),h.addEventListener("touchcancel",u),h.addEventListener("click",g),e.appendChild(h)}),window.addEventListener("keydown",e=>{const t=e.key.toUpperCase();if("B"===t){this.buildMode=!this.buildMode,this.buildMode||null!==this.playerX||this.spawnPlayer(),this.updateModeDisplay();const t=document.getElementById("mode-indicator")||this.createModeIndicator();return t.textContent=this.buildMode?" Build Mode":" Explore Mode",t.style.display="block",setTimeout(()=>{t.style.display="none"},2e3),void e.preventDefault()}if("P"===t){const t=P.toggle();return document.getElementById("profiler-panel").style.display=t?"block":"none",void e.preventDefault()}if("["===t)return this.decreaseTimeSpeed(),void e.preventDefault();if("]"===t)return this.increaseTimeSpeed(),void e.preventDefault();if(!this.buildMode){if("ARROWLEFT"===t||"A"===t)return this.keys.left=!0,void e.preventDefault();if("ARROWRIGHT"===t||"D"===t)return this.keys.right=!0,void e.preventDefault();if("ARROWUP"===t||"W"===t||" "===t)return this.keys.jump=!0,void e.preventDefault()}const s=document.querySelector(`.element-btn[data-key="${t}"]`);s&&(s.click(),e.preventDefault())}),window.addEventListener("keyup",e=>{const t=e.key.toUpperCase();"ARROWLEFT"!==t&&"A"!==t||(this.keys.left=!1),"ARROWRIGHT"!==t&&"D"!==t||(this.keys.right=!1),"ARROWUP"!==t&&"W"!==t&&" "!==t||(this.keys.jump=!1)}),this.profilerPanel=document.getElementById("profiler-content")}createModeIndicator(){const e=document.createElement("div");return e.id="mode-indicator",e.style.cssText="\n            position: fixed;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(0,0,0,0.8);\n            color: white;\n            padding: 10px 20px;\n            border-radius: 8px;\n            font-size: 18px;\n            font-weight: bold;\n            z-index: 1000;\n            display: none;\n        ",document.body.appendChild(e),e}updateModeDisplay(){this.modeDisplay&&(this.buildMode?(this.modeDisplay.textContent=" Build",this.modeDisplay.style.color="#00ffff"):(this.modeDisplay.textContent=" Explore",this.modeDisplay.style.color="#00ff00"))}spawnPlayer(){const e=Math.floor(this.pixelGrid.width/2),t=Math.floor(.3*this.pixelGrid.height),s=this.elementRegistry.get("player");this.pixelGrid.setElement(e,t,s),this.playerX=e,this.playerY=t}getCurrentTimeSpeed(){return this.timeControl.speedLevels[this.timeControl.currentSpeedIndex]}increaseTimeSpeed(){this.timeControl.currentSpeedIndex<this.timeControl.speedLevels.length-1&&(this.timeControl.currentSpeedIndex++,this.showTimeSpeedIndicator())}decreaseTimeSpeed(){this.timeControl.currentSpeedIndex>0&&(this.timeControl.currentSpeedIndex--,this.showTimeSpeedIndicator())}showTimeSpeedIndicator(){const e=this.getCurrentTimeSpeed(),t=document.getElementById("mode-indicator")||this.createModeIndicator();let s;s=e<1?` ${e}x Speed`:1===e?" Normal Speed":` ${e}x Speed`,t.textContent=s,t.style.display="block",setTimeout(()=>{t.style.display="none"},2e3)}findPlayer(){if(null!==this.playerX&&null!==this.playerY)for(let e=-5;e<=5;e++)for(let t=-5;t<=5;t++){const s=this.playerX+t,a=this.playerY+e,n=this.pixelGrid.getElement(s,a);if(n&&"player"===n.name)return this.playerX=s,void(this.playerY=a)}}generateElementDescription(e){const t={bird:"Living creature  Flies through the air with bobbing gliding motion  Gets hungry and seeks food on ground  Sleeps at night on perches (trees, roofs, ground)  Wakes up at dawn  Flocks with other birds  Escapes when trapped indoors  Dies if starving  Burns to ash when ignited  Multiple color variants (white, gray)  SEASONAL: Migrates south in mid-autumn (flies upward and disappears)  Returns in early spring (spawns at top of map)",fish:"Living creature  Swims in water bodies  Gets hungry and seeks food at water surface  Dies after 5 seconds out of water  Falls through air when stranded  Swims in schools with other fish  Multiple color variants (orange, gold, red, black)  Burns to ash when exposed to fire",tree_seed:"Organic seed  Falls until landing on solid ground  Germinates after 2 seconds on ground  Grows into procedurally-generated tree with trunk and branches  Takes 80 frames per growth segment  Produces leaves at branch terminals  Spacing prevents overcrowding  Burns to ash  SEASONAL: Grows 2x faster in spring, normal in summer, 2x slower in autumn, stops completely in winter",house_seed:"Wandering builder  Falls until landing  Wanders horizontally seeking good building spot  Climbs over 1-block obstacles  Burrows through sand and soft materials  Validates location (needs clearance, solid ground, avoids water/trees)  Builds complete house with foundation, walls, windows, door, and roof  Steps aside during construction  Waits 10s cooldown then builds another house  Burns to ash",water:"Liquid, flows downward and spreads  Extinguishes fire (70% chance)  becomes steam  Turns lava into stone on contact (20% chance)  Sand becomes wet when submerged in water  Absorbed by trees  trees get wet and grow leaves 3x faster  Evaporates near heat  steam  Essential for fish survival  SEASONAL: Surface freezes to ice in winter when temperature < 0C (deep water stays liquid)",lava:"Liquid, flows slowly  Very hot - ignites flammable materials on contact  Turns into stone when touching water (20% chance)  Melts ice on contact  Glowing heat source  High density (sinks below most liquids)",sand:"Powder, falls and piles  Becomes wet sand when submerged in water or when water directly above  Wet sand is darker and dries slowly over time  Can be burrowed through by builders  Buildable material for foundations",fire:"Gas, rises  Heat source - ignites combustible materials (10% base chance)  Spreads to nearby flammables  Extinguished by water  Creates light  Lasts 40s then burns out  Very light (rises above everything)",steam:"Gas, rises rapidly  Created when water evaporates or touches fire  Rises to atmosphere and forms clouds  Clouds accumulate steam and eventually rain  Dissipates after 20s",cloud:"Gas, floats in upper atmosphere  Forms from accumulated steam  Drifts horizontally with wind  40% of clouds produce rain  Saturated clouds (dark gray) drop 1-3 water droplets  Highly saturated clouds generate lightning strikes  Absorbs nearby steam to grow  Can merge with adjacent clouds  Lasts 40s  Darkens sky when covering sun  SEASONAL: Drops snow instead of rain in winter  Drift speed/direction affected by seasonal wind patterns",stone:"Solid, immovable  Created when lava touches water  Building material  Very dense and stable  Resistant to most interactions  Burns slowly if exposed to sustained heat",wood:"Solid building material  Burns slowly  burning wood (takes 25s to fully burn)  Resistant to ignition (80% resistance)  Tree trunks and branches made of wood  Can be used for construction",burning_wood:"Solid, burning  Heat source - ignites nearby flammables  Spreads fire to combustibles (12% chance)  Burns for 25 seconds total  ash  Creates warmth and light",coal:"Solid fuel  Burns very slowly and hot  fire  Excellent long-lasting heat source  Found in fossil deposits  High ignition resistance  Dense material",ash:"Powder, falls lightly  Created when organic materials burn completely  Settles on ground  Disperses easily  Dissolves after 6 seconds  Very light and soft - can be burrowed through",ice:"Solid, frozen water  Melts near heat sources  water  Can be broken or pushed  Slippery surface  Colder than regular materials  SEASONAL: Melts 2x faster in summer, 10x slower in winter",gunpowder:"Explosive powder, falls  Extremely flammable (ignites instantly on contact with heat)  Explodes in 3-cell radius when ignited  Explosion creates fire at center, ignites nearby gunpowder (chain reaction), destroys combustibles, pushes particles away 2-4 cells  Becomes wet and inert when submerged  wet gunpowder  Burns to fire",wet_gunpowder:"Wet powder, falls  Inert - cannot ignite or explode while wet  Dries very slowly over time (0.05% per frame)  gunpowder  Created when gunpowder touches water",oil:"Liquid, flows  Highly flammable - ignites easily  Burns intensely when ignited  fire  Floats on water (lower density)  Spreads across surfaces  Evaporates slowly",acid:"Liquid, flows  Corrosive - dissolves organic materials on contact  Melts through certain substances  Dangerous to living creatures  Bright green color",glass:"Solid, transparent  Created by heating sand to extreme temperatures  Fragile - shatters under pressure  Transparent/translucent material  Non-flammable",vine:"Organic plant  Grows and spreads along surfaces  Climbs upward on walls  Burns when exposed to fire  ash  Creates natural coverage  Living plant material",snow:"Powder, falls lightly  Forms slush when touching water (40% chance)  Melts near heat  water  Accumulates on surfaces  Very light and disperses easily  Cold material  Settles in piles  Drifts down gently",slush:"Thick liquid mixture of snow and water  Flows slowly and viscously  Forms when snow contacts water  Melts near heat  water  Freezes back to ice when exposed to cold air (not touching water)  Heavier than ice but lighter than water  Very thick and sludgy  Coastal/winter material",coral:"Organic solid  Grows underwater in colonies  Requires water to survive  Dies if exposed to air  Colorful reef-building material  Burns when exposed to fire",steam_vent:"Solid structure  Continuously produces steam  Natural heat source  Creates rising steam plumes  Contributes to cloud formation  Permanent fixture",fossil:"Solid organic remains  Ancient preserved material  Can contain coal deposits  Combustible under extreme heat  Historical remnant",electricity:"Energy, travels rapidly  Created by lightning from storm clouds  Follows conductive paths  Ignites flammables instantly  Dissipates quickly  Dangerous to living creatures",leaf:"Organic plant matter  Grows at tree branch terminals  Falls slowly when detached  Burns easily  ash  Soft material - can be burrowed through  Part of tree canopy  SEASONAL: Bright green in spring, deep green in summer, yellow/orange/red in autumn (0.2% fall rate), brown in winter (0.5% fall rate  bare trees)",tree_trunk:"Solid wood  Main structural trunk of trees  Absorbs water from above  gets wet  dries out slowly  Burns  burning wood  Strong building material  Part of tree structure  SEASONAL: Regrows leaves faster in spring (0.01% regrowth rate), occasional decay in autumn/winter (0.001-0.002%  ash)  WATERED: Wet trees (wetness > 20) have 3x leaf growth rate",tree_branch:"Solid wood  Tree branches extending from trunk  Absorbs water from above  gets wet  dries out slowly  Burns  burning wood  Supports leaves  Part of tree structure  SEASONAL: Regrows leaves in spring, may decay and fall off in autumn/winter (0.001-0.002%  movable wood)  WATERED: Wet branches (wetness > 20) have 3x leaf growth rate",wet_sand:"Wet powder, falls slowly  Darker than dry sand  Created when sand submerged or water directly above  Dries slowly over time  sand  Clumps together more than dry sand  Coastal/beach material",smoke:"Gas, rises  Created by burning materials  Rises into atmosphere  Visual indicator of fire  Dissipates after 10s  No direct interactions",player:"You!  Controlled character in explore mode  Use arrow keys or A/D to move left/right  Press B to toggle between build and explore modes  Affected by gravity and physics  Can interact with elements",empty:"Nothing - empty space  Draw here to place elements  Eraser removes elements leaving empty space",eraser:"Tool - removes elements and creates empty space  Use to clear unwanted materials  Large brush size for quick cleanup"};if(t[e.name])return t[e.name];const s=[];"liquid"===e.state?s.push("liquid, flows"):"powder"===e.state?s.push("powder, falls"):"solid"===e.state?s.push("solid"):"gas"===e.state&&s.push("gas, rises");const a=[];return Array.isArray(e.tags)&&(e.tags.includes("combustible")&&a.push("burns"),e.tags.includes("heat_source")&&a.push("heat source")),a.length>0&&s.push(a.join(", ")),s.join("  ")||"Unknown element"}startDrawing(e){this.buildMode&&(this.isDrawing=!0,this.draw(e))}stopDrawing(){this.isDrawing=!1}draw(e){if(!this.isDrawing)return;const t=Math.floor(e.x/this.pixelSize),s=Math.floor(e.y/this.pixelSize),a="eraser"===this.selectedElement?this.elementRegistry.get("empty"):this.elementRegistry.get(this.selectedElement);if(!a)return;const n=a.brushSize,i=a.emissionDensity;for(let r=-n;r<=n;r++)for(let e=-n;e<=n;e++)if(e*e+r*r<=n*n&&Math.random()<i){const n=t+e,i=s+r,o=2;if(n<o||n>=this.pixelGrid.width-o||i<o||i>=this.pixelGrid.height-o)continue;const l=this.pixelGrid.getElement(n,i);if(l&&"player"===l.name)continue;this.pixelGrid.setElement(n,i,a,!1,null)}}update(){P.start("frame:total");const e=this.getCurrentTimeSpeed(),t=this.dayNightCycle.time;if(this.dayNightCycle.time=(this.dayNightCycle.time+this.dayNightCycle.baseSpeed*e)%1,t>this.dayNightCycle.time&&this.currentDay++,this.celestialManager.update(this.dayNightCycle.time,this.currentDay),this.seasonManager.update(e),this.windManager.update(e),this.pixelGrid.setSeasonData({season:this.seasonManager.getCurrentSeason(),seasonProgress:this.seasonManager.getSeasonProgress(),temperature:this.seasonManager.getTemperature(),windVector:this.windManager.getWindVector(),windDirection:this.windManager.getWindDirection(),windStrength:this.windManager.getWindStrength()}),this.seasonManager.isEarlySpring()&&!this.birdsReturned&&(this.spawnSpringBirds(),this.birdsReturned=!0),"spring"!==this.seasonManager.getCurrentSeason()&&(this.birdsReturned=!1),this.dayNightCycle.time>this.weatherSystem.nextCloudDay&&this.dayNightCycle.time<this.weatherSystem.nextCloudDay+.01&&(this.weatherSystem.cloudiness=Math.random(),this.weatherSystem.nextCloudDay=(this.weatherSystem.nextCloudDay+1)%1),this.dayNightCycle.time>=.25&&this.dayNightCycle.time<=.75&&this.updateCloudSystem(),!this.buildMode&&null!==this.playerX&&null!==this.playerY){const e=this.pixelGrid.getElement(this.playerX,this.playerY);e&&"player"===e.name&&(this.movementTimer||(this.movementTimer=0),this.movementTimer++,this.movementTimer%3==0&&(this.keys.left&&e.handleMovement(this.playerX,this.playerY,this.pixelGrid,"left")&&this.playerX--,this.keys.right&&e.handleMovement(this.playerX,this.playerY,this.pixelGrid,"right")&&this.playerX++),this.keys.jump&&!this.lastKeyJump?(e.handleMovement(this.playerX,this.playerY,this.pixelGrid,"jump"),this.lastKeyJump=!0):this.keys.jump||(this.lastKeyJump=!1))}P.start("physics:update"),this.pixelGrid.setTimeOfDay(this.dayNightCycle.time);const s=Math.min(e,this.timeControl.maxPhysicsSpeed),a=Math.floor(s),n=s-a;for(let d=0;d<a;d++)this.pixelGrid.update();n>0&&Math.random()<n&&this.pixelGrid.update(),P.end("physics:update"),this.buildMode||this.findPlayer(),P.start("render:total"),this.render(),P.end("render:total"),this.fpsText.textContent=Math.round(this.game.loop.actualFps),this.particlesText.textContent=this.pixelGrid.particleCount;const i=this.seasonManager.getCurrentSeason(),r=i.charAt(0).toUpperCase()+i.slice(1);this.seasonDisplay.textContent=`${{spring:"",summer:"",autumn:"",winter:""}[i]} ${r}`;const o=this.getCurrentTimeSpeed();let l="";o<1?l="":o>10?l="":o>1&&(l=""),this.speedDisplay.textContent=`${l} ${o}x`,P.enabled&&this.updateProfilerPanel(),P.end("frame:total")}updateCloudSystem(){const e=this.pixelGrid,t=this.elementRegistry.get("cloud");if(!t)return;let s=0;const a=Math.floor(.4*e.height);for(let l=0;l<a;l++)for(let t=0;t<e.width;t++){const a=e.getElement(t,l);a&&"cloud"===a.name&&s++}const n=e.width*a*.02;this.weatherSystem.cloudCoverage=Math.min(s/n,1),this.weatherSystem.cloudSpawnTimer++;const i=this.weatherSystem.cloudiness,r=this.seasonManager.getCloudSpawnMultiplier();let o;if(o=i>.7?(60+60*Math.random())/r:i>.4?(120+180*Math.random())/r:(300+300*Math.random())/r,this.weatherSystem.cloudSpawnTimer>o&&this.weatherSystem.cloudCoverage<.8){this.weatherSystem.cloudSpawnTimer=0;const s=Math.floor(Math.random()*e.width),n=Math.floor(Math.random()*a),i=e.getElement(s,n);if(i&&0===i.id&&(e.setElement(s,n,t),this.seasonManager.shouldSpawnSnowClouds())){const t=e.getCell(s,n);t&&t.data&&(t.data.isSnowCloud=!0)}}}spawnSpringBirds(){const e=this.pixelGrid,t=this.elementRegistry.get("bird");if(!t)return;const s=5+Math.floor(6*Math.random());for(let a=0;a<s;a++){const s=Math.floor(Math.random()*e.width),a=10+Math.floor(10*Math.random());e.isEmpty(s,a)&&e.setElement(s,a,t)}}render(){const{width:e,height:t}=this.sys.game.config,s=this.dayNightCycle.time;P.start("render:sky"),this.renderSky(e,t,s),P.end("render:sky"),P.start("render:celestial"),this.renderCelestialBodies(e,t,s),P.end("render:celestial"),P.start("render:particles"),this.graphics.clear(),this.lavaGlowGraphics.clear(),this.lightGlowGraphics.clear();const a=this.getLightingColor(s),n=new Map,i=[],r=[];for(const[o,l]of this.pixelGrid.activeCells){const e=this.pixelGrid.grid[l.y]?.[l.x];if(e&&0!==e.element.id){const t=e.data.fishColor||e.data.birdColor||e.data.lightColor||e.data.leafColor||e.element.color,s="light"===e.element.name,o=s?t:this.applyLighting(t,a),d=!0===e.data.isLavaSurface;s?r.push({coords:l,color:o}):d?i.push({coords:l,color:o}):(n.has(o)||n.set(o,[]),n.get(o).push(l))}}for(const[o,l]of n){this.graphics.fillStyle(o,1);for(const e of l)this.graphics.fillRect(e.x*this.pixelSize,e.y*this.pixelSize,this.pixelSize,this.pixelSize)}if(i.length>0){const e=new Map;for(const t of i)e.has(t.color)||e.set(t.color,[]),e.get(t.color).push(t.coords);for(const[t,s]of e){this.lavaGlowGraphics.fillStyle(t,1);for(const e of s)this.lavaGlowGraphics.fillRect(e.x*this.pixelSize,e.y*this.pixelSize,this.pixelSize,this.pixelSize)}}if(r.length>0){const e=new Map;for(const t of r)e.has(t.color)||e.set(t.color,[]),e.get(t.color).push(t.coords);for(const[t,s]of e){this.lightGlowGraphics.fillStyle(t,1);for(const e of s)this.lightGlowGraphics.fillRect(e.x*this.pixelSize,e.y*this.pixelSize,this.pixelSize,this.pixelSize)}}P.end("render:particles"),P.start("render:border"),this.renderWorldBorder(),P.end("render:border"),P.start("render:atmosphere"),this.renderAtmosphere(e,t,s),P.end("render:atmosphere")}renderWorldBorder(){const e=2*this.pixelSize,{width:t,height:s}=this.sys.game.config;this.borderGraphics||(this.borderGraphics=this.add.graphics(),this.borderGraphics.setDepth(1e3)),this.borderGraphics.clear(),this.borderGraphics.lineStyle(e,4210752,1);const a=e/2;this.borderGraphics.strokeRect(a,a,t-e,s-e),this.borderGraphics.lineStyle(this.pixelSize,2105376,.5),this.borderGraphics.strokeRect(a+this.pixelSize,a+this.pixelSize,t-e-2*this.pixelSize,s-e-2*this.pixelSize)}renderSky(e,t,s){let a;if(this.skyGraphics.clear(),s<.2)a={top:51,bottom:85};else if(s<.3){const e=(s-.2)/.1;a={top:this.lerpColor(51,16739125,e),bottom:this.lerpColor(85,16753920,e)}}else if(s<.4){const e=(s-.3)/.1;a={top:this.lerpColor(16739125,8900331,e),bottom:this.lerpColor(16753920,8900331,e)}}else if(s<.65)a={top:8900331,bottom:8900331};else if(s<.75){const e=(s-.65)/.1;a={top:this.lerpColor(8900331,16739125,e),bottom:this.lerpColor(8900331,16729344,e)}}else if(s<.85){const e=(s-.75)/.1;a={top:this.lerpColor(16739125,51,e),bottom:this.lerpColor(16729344,85,e)}}else a={top:51,bottom:85};const n=this.weatherSystem.cloudCoverage;if(n>.1&&s>=.25&&s<=.75){const e=.4*n,t=8421504;a.top=this.lerpColor(a.top,t,e),a.bottom=this.lerpColor(a.bottom,t,e)}const i=this.seasonManager.getCurrentSeason(),r=W.SKY_TINT[i];r&&(a.top=this.tintColor(a.top,r),a.bottom=this.tintColor(a.bottom,r)),this.skyGraphics.fillGradientStyle(a.top,a.top,a.bottom,a.bottom,1),this.skyGraphics.fillRect(0,0,e,t)}renderCelestialBodies(e,t,s){this.celestialGraphics.clear();let a=2;s>.3&&s<.7&&(a=2+8*(1-Math.abs(s-.5)/.2)),this.celestialGlow.outerStrength=a;const n=this.celestialManager.getSunPosition(e,t,s),i=this.celestialManager.getMoonPosition(e,t,s);if(this.celestialManager.isSunVisible(s)){const e=this.weatherSystem.cloudCoverage,t=this.seasonManager.getCurrentSeason(),s=W.SUN_TINT[t]||{r:1,g:1,b:1};this.celestialManager.renderSun(this.celestialGraphics,n,e,s)}this.celestialManager.isMoonVisible(s)&&this.celestialManager.renderMoon(this.celestialGraphics,i)}renderAtmosphere(e,t,s){this.overlayGraphics.clear();const a=.15*t;let n,i,r,o;if(s<.2||s>.85)n=657978,i=.6;else if(s<.3){const e=(s-.2)/.1;n=this.lerpColor(657978,16747586,e),i=.6}else if(s<.4){const e=(s-.3)/.1;n=this.lerpColor(16747586,8900331,e),i=.5}else if(s<.65)n=8900331,i=.4;else if(s<.75){const e=(s-.65)/.1;n=this.lerpColor(8900331,16739125,e),i=.5}else if(s<.85){const e=(s-.75)/.1;n=this.lerpColor(16739125,657978,e),i=.6}else n=657978,i=.6;this.overlayGraphics.fillGradientStyle(n,n,n,n,i,i,0,0),this.overlayGraphics.fillRect(0,0,e,a),s<.2||s>.85?(r=51,o=.2):s<.3?(r=16739125,o=.15*(1-(s-.2)/.1)):s<.65?o=0:s<.75?(r=16739125,o=(s-.65)/.1*.15):(r=51,o=(s-.75)/.1*.2),o>0&&(this.overlayGraphics.fillStyle(r,o),this.overlayGraphics.fillRect(0,0,e,t))}getLightingColor(e){if(e<.2||e>.85)return{r:.5,g:.5,b:.7};if(e<.3){const t=(e-.2)/.1;return{r:.5+.5*t,g:.5+.5*t,b:.7+.3*t}}if(e<.65)return{r:1,g:1,b:1};if(e<.75){const t=(e-.65)/.1;return{r:1-.15*t,g:1-.2*t,b:1-.2*t}}{const t=(e-.75)/.1;return{r:.85-.35*t,g:.8-.3*t,b:.8-.1*t}}}applyLighting(e,t){const s=(e>>16&255)*t.r,a=(e>>8&255)*t.g,n=(255&e)*t.b;return Math.floor(s)<<16|Math.floor(a)<<8|Math.floor(n)}updateProfilerPanel(){if(!this.profilerPanel)return;const e=P.getMetrics();P.getBottlenecks(10);const t=e=>{const t=e>10?"critical":e>5?"warn":"";return{value:e.toFixed(3),cssClass:t}};let s="";s+='<div class="section">',s+="<h3>Frame Timing</h3>";const a=t(e["frame:total"]?.avg||0),n=t(e["physics:update"]?.avg||0),i=t(e["render:total"]?.avg||0);s+=`<div class="metric ${a.cssClass}">\n            <span class="metric-name">Total Frame</span>\n            <span class="metric-value">${a.value}ms</span>\n        </div>`,s+=`<div class="metric ${n.cssClass}">\n            <span class="metric-name"> Physics Update</span>\n            <span class="metric-value">${n.value}ms</span>\n        </div>`,s+=`<div class="metric ${i.cssClass}">\n            <span class="metric-name"> Render Total</span>\n            <span class="metric-value">${i.value}ms</span>\n        </div>`,s+="</div>",s+='<div class="section">',s+="<h3>Render Breakdown</h3>";const r=t(e["render:sky"]?.avg||0),o=t(e["render:celestial"]?.avg||0),l=t(e["render:particles"]?.avg||0),d=t(e["render:atmosphere"]?.avg||0);s+=`<div class="metric">\n            <span class="metric-name">Sky</span>\n            <span class="metric-value">${r.value}ms</span>\n        </div>`,s+=`<div class="metric">\n            <span class="metric-name">Celestial</span>\n            <span class="metric-value">${o.value}ms</span>\n        </div>`,s+=`<div class="metric ${l.cssClass}">\n            <span class="metric-name">Particles</span>\n            <span class="metric-value">${l.value}ms</span>\n        </div>`,s+=`<div class="metric">\n            <span class="metric-name">Atmosphere</span>\n            <span class="metric-value">${d.value}ms</span>\n        </div>`,s+="</div>";const h=Object.entries(e).filter(([e])=>e.startsWith("element:")).sort((e,t)=>t[1].avg-e[1].avg);h.length>0&&(s+='<div class="section">',s+="<h3>Element Updates (Top 5)</h3>",h.slice(0,5).forEach(([e,a])=>{const n=e.replace("element:",""),i=t(a.avg);s+=`<div class="metric ${i.cssClass}">\n                    <span class="metric-name">${n}</span>\n                    <span class="metric-value">${i.value}ms</span>\n                </div>`}),s+="</div>"),s+='<div class="section">',s+="<h3>System Info</h3>",s+=`<div class="metric">\n            <span class="metric-name">Active Cells</span>\n            <span class="metric-value">${this.pixelGrid.activeCells.size}</span>\n        </div>`,s+='<div class="metric">\n            <span class="metric-name">Target FPS</span>\n            <span class="metric-value">60</span>\n        </div>';const c=e["frame:total"]?.avg||0,m=t(16.67-c);s+=`<div class="metric ${m.cssClass}">\n            <span class="metric-name">Frame Budget</span>\n            <span class="metric-value">${m.value}ms</span>\n        </div>`,s+="</div>",this.profilerPanel.innerHTML=s}lerpColor(e,t,s){const a=e>>16&255,n=e>>8&255,i=255&e,r=t>>16&255,o=t>>8&255,l=255&t;return Math.floor(a+(r-a)*s)<<16|Math.floor(n+(o-n)*s)<<8|Math.floor(i+(l-i)*s)}tintColor(e,t){const s=e>>16&255,a=e>>8&255,n=255&e;return Math.min(255,Math.floor(s*t.r))<<16|Math.min(255,Math.floor(a*t.g))<<8|Math.min(255,Math.floor(n*t.b))}}const Ce={type:s.AUTO,width:Math.min(window.innerWidth,800),height:Math.min(window.innerHeight,600),parent:"game-container",backgroundColor:"#000000",scene:ve,render:{pixelArt:!0,antialias:!1},fps:{target:60,forceSetTimeOut:!1},resolution:Math.min(window.devicePixelRatio||1,2)};window.__pixelboxGame&&window.__pixelboxGame.destroy(!0),window.__pixelboxGame=new s.Game(Ce)}}});
