================================================================================
PIXELBOX PERFORMANCE BOTTLENECK HIERARCHY
================================================================================

FRAME TIME BUDGET: 16.67ms @ 60 fps
CURRENT USAGE: ~100% (causes drops to 30 fps)

================================================================================
BREAKDOWN BY IMPACT
================================================================================

       60 fps (16.67ms per frame)
            |
            v
    [100% CPU BUDGET USED]
       /    |    \
      /     |     \
     v      v      v
[40K] [70K] [15K]
Inter-  Fish  Str
action  AI   Pars
Check        ing
|     |      |
|     |      +-- 15,000 ops/frame (death by 1000 cuts)
|     |          
|     +-- 70,000 ops @ 100 fish
|        + Food seeking: O(100)
|        + School behavior: O(49)
|        + Surface finding: O(600)
|        + Reproduction checks: ongoing
|
+-- 40,000 checks/frame
    5,000 cells × 8 neighbors
    uncached, every frame


        Additional bottlenecks:

    [5K]     [4.9K]    [400]    [200+]
    Water    Plants    Clouds   Memory
    Depth    Water     Steam    Alloc
    Check    Check     Scan     (GC)
      |        |         |        |
      +-- O(h) per cell  +-- GC stalls
         @ 70% freq         10-15 fps


================================================================================
CUMULATIVE FPS IMPACT (Stacking)
================================================================================

Starting point: Baseline 60 fps
          |
          v
    Interaction checks (-15 fps)
    [60 → 45 fps]
          |
          v
    Fish AI @ 100 fish (-15 fps)
    [45 → 30 fps]
          |
          v
    String parsing (-5 fps)
    [30 → 25 fps]
          |
          v
    Water leveling (-5 fps)
    [25 → 20 fps]
          |
          v
    Plant checks (-5 fps)
    [20 → 15 fps]
          |
          v
    Memory allocation / GC (-5 fps)
    [15 → 10 fps]


Current typical scenario: 30-45 fps (depends on population)


================================================================================
BOTTLENECK DEPENDENCY GRAPH
================================================================================

                    Game Frame
                         |
                         v
                    PixelGrid.update()
                    /    |        \
                   /     |         \
                  v      v          v
            Element   String      Interaction
            Updates  Parsing      Checking
             /  |  \   (3x)      (8 neighbors)
            /   |   \    |            |
          Fish Plant Cloud ...        +---> InteractionManager
          (complex AI)                       (priority system)
           |    |     |
           |    |     +-- findNearbySteam() [O(49)]
           |    |
           |    +-- hasWater check [O(49)]
           |
           +-- countNearbyFish() [O(r²)]
           +-- findNearbyFood() [O(n)]
           +-- analyzeSchool() [O(n)]
           +-- findSurfaceLevel() [O(h)]

                         |
                         v
                   GameScene.render()
                    /         \
                   v           v
            String Parsing   Color Batching
            (1x per cell)    (Map allocation)
                |                |
                +-- applyLighting()
                     (5000 calls)


================================================================================
HOTSPOT LOCATION HEAT MAP
================================================================================

FILE: src/PixelGrid.js
  ├─ Lines 171, 181 ......... String parsing [HIGH]
  ├─ Lines 225-244 ......... Interaction checking [CRITICAL]
  ├─ Line 220 .............. checkInteractions() call [CRITICAL]
  ├─ Line 179 .............. Map allocation [MEDIUM]
  └─ Lines 159-223 ......... Update loop [CRITICAL]

FILE: src/elements/FishElement.js
  ├─ Line 92 ............... countNearbyFish() call [CRITICAL]
  ├─ Line 128 .............. findSurfaceLevel() [CRITICAL]
  ├─ Line 154 .............. findNearbyFood() [CRITICAL]
  ├─ Line 214 .............. analyzeSchool() [HIGH]
  ├─ Line 175 .............. Reproduction check [MEDIUM]
  └─ Lines 331-343 ......... countNearbyFish() impl [CRITICAL]

FILE: src/behaviors/MovementBehaviors.js
  ├─ Lines 165-187 ......... measureLiquidDepth() [HIGH]
  ├─ Line 111 .............. waterLeveling() call [HIGH]
  └─ Lines 144-146 ......... 3x depth checks [HIGH]

FILE: src/elements/PlantElement.js
  ├─ Lines 54-66 ........... Water proximity check [MEDIUM]
  └─ Line 75 ............... Growth spreading [MEDIUM]

FILE: src/elements/CloudElement.js
  ├─ Lines 54-64 ........... Steam absorption [MEDIUM]
  └─ Lines 180-193 ......... findNearbySteam() [MEDIUM]

FILE: src/main.js
  ├─ Line 558 .............. String parsing [HIGH]
  ├─ Line 555 .............. Map allocation [MEDIUM]
  └─ Lines 550-587 ......... Rendering [MEDIUM]


================================================================================
CRITICAL PATH ANALYSIS
================================================================================

Per-frame execution order and impact:

1. GameScene.update() [Start of frame]
   ├─ Day/night cycle update [negligible]
   ├─ Player movement [negligible]
   └─ PixelGrid.update() [CRITICAL: 85% of frame time]
       ├─ String parsing × 2 [3-5% frame time]
       ├─ Map creation [1% frame time]
       ├─ Array sorting [1% frame time]
       └─ FOR EACH active cell (5,000+):
           ├─ cell.element.update() [40% frame time]
           │  ├─ Fish: countNearbyFish() [O(r²)]
           │  │         findSurfaceLevel() [O(h)]
           │  │         findNearbyFood() [O(n)]
           │  │         analyzeSchool() [O(n)]
           │  ├─ Plant: water proximity [O(r²)]
           │  ├─ Cloud: steam search [O(r²)]
           │  └─ Water: depth measurement [O(h)]
           │
           └─ checkInteractions() [40% frame time]
              └─ FOR EACH of 8 neighbors:
                 └─ registry.checkInteraction()

2. GameScene.render() [After physics update]
   ├─ Sky/celestial rendering [negligible]
   └─ Particle rendering [5-10% frame time]
      ├─ String parsing [2% frame time]
      ├─ Map allocation [1% frame time]
      ├─ Color batching [1% frame time]
      └─ FOR EACH active cell (5,000+):
         └─ applyLighting() + fillRect()

3. Frame complete
   └─ Garbage collection (periodic) [-10 to -15 fps stutter]


================================================================================
FIX PRIORITY ROADMAP
================================================================================

IMMEDIATE (Week 1):
  Priority 1: Cache coordinates in activeCells
     Impact: +5 fps (eliminate 15,000 string operations)
     Effort: Low (1-2 hours)
     Risk: Low

  Priority 2: Reduce interaction check frequency
     Impact: +10 fps (cut 40,000 checks to 20,000)
     Effort: Low (1 hour)
     Risk: Low (interaction fidelity acceptable at 2-frame checks)

  Priority 3: Fish AI quick optimization
     Impact: +5 fps (cache, reduce radius)
     Effort: Low (2-3 hours)
     Risk: Low

MEDIUM TERM (Week 2-3):
  Priority 4: Spatial hashing for neighbors
     Impact: +8 fps (constant-time lookups)
     Effort: Medium (4-6 hours)
     Risk: Medium (requires refactoring)

  Priority 5: Water depth caching
     Impact: +5 fps (eliminate O(h) scans)
     Effort: Medium (3-4 hours)
     Risk: Low

  Priority 6: Object pooling
     Impact: +3 fps (GC pressure reduction)
     Effort: Medium (4-5 hours)
     Risk: Low

LONG TERM (Week 4+):
  Priority 7: Spatial partitioning
     Impact: +5 fps (dense population handling)
     Effort: High (8-10 hours)
     Risk: Medium

  Priority 8: Deferred interaction system
     Impact: +2 fps (batch processing)
     Effort: High (10+ hours)
     Risk: High (architectural change)


TOTAL POTENTIAL IMPROVEMENT: +43 fps
TARGET ACHIEVED: 60 fps stable


================================================================================
END DIAGRAM
================================================================================
