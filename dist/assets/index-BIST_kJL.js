var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);function a(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}import{P as s}from"./phaser-Dy6k5FA_.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const n="empty",i="solid",r="powder",o="liquid",l="gas",d=3,h="combustible",c="heat_source",m="very_hot",u="freezing",g="oxidizer",f="explosive",p="corrosive",y="dissolves",w="evaporates",b="condenses",M="solidifies_lava",v="organic",E="mineral",C="conductive",S="extinguishes_fire",T=1,x=2,I=4,D=6,k=7,R=8,_=10,B=14,P=22,N=23;class L{constructor(){this.interactions=[],this.registerDefaultInteractions()}registerInteraction(e){const t={...e,priority:void 0!==e.priority?e.priority:10};this.interactions.push(t),this.interactions.sort((e,t)=>e.priority-t.priority)}registerDefaultInteractions(){this.registerInteraction({name:"lava_water_solidification",priority:0,check:(e,t)=>e.hasTag(M)&&"lava"===t.name||t.hasTag(M)&&"lava"===e.name,apply:(e,t,a,s,n,i,r,o)=>{const[l,d,h,c]=e.hasTag(M)?[s,n,i,r]:[i,r,s,n];return Math.random()<.7?(a.setElement(h,c,o.get("stone")),a.setElement(l,d,o.get("steam"))):a.setElement(l,d,o.get("steam")),!0}}),this.registerInteraction({name:"ignition",priority:5,check:(e,t)=>e.hasTag(c)&&t.hasTag(h)||t.hasTag(c)&&e.hasTag(h),apply:(e,t,a,s,n,i,r,o)=>{const[l,d,c]=e.hasTag(h)?[s,n,e]:[i,r,t],m=.1*(1-(c.ignitionResistance||0));if(Math.random()<m){const e=c.burnsInto?o.get(c.burnsInto):o.get("fire");return a.setElement(l,d,e),!0}return!1}}),this.registerInteraction({name:"fire_extinguishing",priority:7,check:(e,t)=>e.hasTag(S)&&"fire"===t.name||t.hasTag(S)&&"fire"===e.name,apply:(e,t,a,s,n,i,r,o)=>{const[l,d]="fire"===e.name?[s,n]:[i,r],[h,c]="fire"===e.name?[i,r]:[s,n];return Math.random()<.9&&(a.setElement(l,d,Math.random()<.3?o.get("steam"):o.get("empty")),Math.random()<.5&&a.setElement(h,c,o.get("steam")),!0)}}),this.registerInteraction({name:"evaporation",priority:10,check:(e,t)=>e.hasTag(w)&&t.hasTag(c)||t.hasTag(w)&&e.hasTag(c),apply:(e,t,a,s,n,i,r,o)=>{const[l,d,h]=e.hasTag(w)?[s,n,e]:[i,r,t];if(Math.random()>.9&&h.evaporatesInto){const t=o.get(h.evaporatesInto);a.setElement(l,d,t);const[m,u]=e.hasTag(c)?[s,n]:[i,r];return Math.random()>.5&&a.setElement(m,u,o.get("empty")),!0}return!1}}),this.registerInteraction({name:"oxidation",check:(e,t)=>e.hasTag(g)&&t.hasTag(c)||t.hasTag(g)&&e.hasTag(c),apply:(e,t,a,s,n,i,r,o)=>{if(Math.random()>.95){const[t,l]=e.hasTag(g)?[s,n]:[i,r];return a.setElement(t,l,o.get("fire")),!0}return!1}}),this.registerInteraction({name:"wet_sand_formation",check:(e,t)=>"water"===e.name&&"sand"===t.name||"sand"===e.name&&"water"===t.name,apply:(e,t,a,s,n,i,r,o)=>{const[l,d,h,c]="sand"===e.name?[s,n,i,r]:[i,r,s,n],m=a.getElement(l,d-1),u=h===l&&c===d-1,g=[m,a.getElement(l,d+1),a.getElement(l-1,d),a.getElement(l+1,d)].filter(e=>e&&"water"===e.name).length,f=g>=3,p=!m||0===m.id;let y=0,w=0;if(u)y=.5,w=.01;else if(f)y=.2,w=.01;else{if(!(g>=1)||p)return!1;y=.15,w=.005}if(Math.random()<y){const e=o.get("wet_sand");if(e)return a.setElement(l,d,e),u&&Math.random()<w&&a.setElement(h,c,o.get("empty")),!0}return!1}}),this.registerInteraction({name:"steam_ice_condensation",priority:8,check:(e,t)=>"steam"===e.name&&"ice"===t.name||"steam"===t.name&&"ice"===e.name,apply:(e,t,a,s,n,i,r,o)=>{const[l,d]="steam"===e.name?[s,n]:[i,r];return Math.random()<.3&&(a.setElement(l,d,o.get("water")),!0)}}),this.registerInteraction({name:"oil_water_separation",priority:15,check:(e,t)=>"oil"===e.name&&"water"===t.name||"oil"===t.name&&"water"===e.name,apply:(e,t,a,s,n,i,r)=>{const[o,l]="oil"===e.name?[s,n]:[i,r],[d,h]="oil"===e.name?[i,r]:[s,n];return l>h&&Math.random()<.2&&(a.swap(o,l,d,h),!0)}}),this.registerInteraction({name:"steam_condensation",priority:16,check:(e,t)=>{const a=["stone","wood","sand","wet_sand","glass","obsidian"];return"steam"===e.name&&a.includes(t.name)||"steam"===t.name&&a.includes(e.name)},apply:(e,t,a,s,n,i,r,o)=>{const[l,d]="steam"===e.name?[s,n]:[i,r],h={stone:.1,obsidian:.12,glass:.08,wet_sand:.06,sand:.05,wood:.03}["steam"===e.name?t.name:e.name]||.05;if(Math.random()<h){const e=o.get("water");if(e)return a.setElement(l,d,e),!0}return!1}})}checkInteraction(e,t,a,s,n,i,r,o){var l,d;if(0===e.id||0===t.id)return!1;const h=e.tags&&e.tags.size>0,c=t.tags&&t.tags.size>0;if(!(h||c||e.onInteract||t.onInteract))return!1;if(null==(l=e.onInteract)?void 0:l.call(e,t,a,s,n,i,r))return!0;if(null==(d=t.onInteract)?void 0:d.call(t,e,a,i,r,s,n))return!0;if(!h&&!c)return!1;for(const m of this.interactions)if(m.check(e,t)&&m.apply(e,t,a,s,n,i,r,o))return!0;return!1}}const A=new class{constructor(){this.enabled=!1,this.metrics=new Map,this.frameSamples=60,this.currentFrame=0}enable(){this.enabled=!0}disable(){this.enabled=!1}toggle(){return this.enabled=!this.enabled,this.enabled}start(e){this.enabled&&performance.mark("".concat(e,"-start"))}end(e){if(!this.enabled)return;const t="".concat(e,"-end"),a="".concat(e,"-measure");performance.mark(t);try{performance.measure(a,"".concat(e,"-start"),t);const s=performance.getEntriesByName(a)[0];s&&this.record(e,s.duration),performance.clearMarks("".concat(e,"-start")),performance.clearMarks(t),performance.clearMeasures(a)}catch(s){}}record(e,t){this.metrics.has(e)||this.metrics.set(e,{total:0,count:0,min:1/0,max:0,samples:[]});const a=this.metrics.get(e);a.total+=t,a.count++,a.min=Math.min(a.min,t),a.max=Math.max(a.max,t),a.samples.push(t),a.samples.length>this.frameSamples&&a.samples.shift()}getAverage(e){const t=this.metrics.get(e);if(!t||0===t.samples.length)return 0;return t.samples.reduce((e,t)=>e+t,0)/t.samples.length}getMetrics(){const e={};for(const[t,a]of this.metrics.entries())if(a.samples.length>0){const s=a.samples.reduce((e,t)=>e+t,0);e[t]={avg:s/a.samples.length,min:a.min,max:a.max,count:a.count}}return e}getBottlenecks(e=5){const t=this.getMetrics();return Object.entries(t).sort((e,t)=>t[1].avg-e[1].avg).slice(0,e)}reset(){this.metrics.clear(),this.currentFrame=0}wrap(e,t){return this.enabled?(...a)=>{this.start(e);const s=t(...a);return this.end(e),s}:t}profileElementType(e,t){return(a,s,n)=>{this.start("element:".concat(e));const i=t.call(this,a,s,n);return this.end("element:".concat(e)),i}}};class G{constructor(e,t,a,s={}){this.id=e,this.name=t,this.color=a,this.density=s.density||0,this.state=s.state||"empty",this.temperature=s.temperature||0,this.dispersion=s.dispersion||0,this.movable=!1!==s.movable,this.defaultLifetime=s.lifetime||-1,this.tags=new Set(s.tags||[]),this.ignitionResistance=s.ignitionResistance||0,this.burnRate=s.burnRate||1,this.brushSize=void 0!==s.brushSize?s.brushSize:5,this.emissionDensity=void 0!==s.emissionDensity?s.emissionDensity:1,this.canInteract=!1!==s.canInteract,this.burnsInto=s.burnsInto||null,this.evaporatesInto=s.evaporatesInto||null,this.condensesInto=s.condensesInto||null,this.meltInto=s.meltInto||null,this.behaviors=[]}hasTag(e){return this.tags.has(e)}addBehavior(e){return this.behaviors.push(e),this}applyBehaviors(e,t,a){const s=a.getCell(e,t);if(!s)return!1;for(const n of this.behaviors){if(n.apply(e,t,a,s))return!0}return!1}update(e,t,a){if(A.enabled){A.start("element:".concat(this.name));const s=this.updateImpl(e,t,a);return A.end("element:".concat(this.name)),s}return this.updateImpl(e,t,a)}updateImpl(e,t,a){return!!this.applyBehaviors(e,t,a)||!!this.movement&&this.movement.apply(e,t,a)}onInteract(e,t,a,s,n,i){return null}}class F{constructor(e={}){this.fallSpeed=e.fallSpeed||1,this.slideAngle=!1!==e.slideAngle,this.slideStability=e.slideStability||.85}apply(e,t,a){const s=a.getCell(e,t);if(s&&(void 0!==s.data.velocityX||void 0!==s.data.velocityY)){if(this.applyVelocity(e,t,a,s))return!0}if(a.canMoveTo(e,t,e,t+1))return a.swap(e,t,e,t+1),!0;if(this.slideAngle){const s=Math.random()>.5?-1:1,n=!!a.isEmpty(e+s,t+2)||Math.random()>this.slideStability;if(n&&a.canMoveTo(e,t,e+s,t+1))return a.swap(e,t,e+s,t+1),!0;if(n&&a.canMoveTo(e,t,e-s,t+1))return a.swap(e,t,e-s,t+1),!0}return!1}applyVelocity(e,t,a,s){let n=s.data.velocityX||0,i=s.data.velocityY||0;if(n*=.92,i*=.92,i+=.15,Math.abs(n)<.3&&Math.abs(i)<.3)return delete s.data.velocityX,delete s.data.velocityY,!1;const r=e+Math.round(n),o=t+Math.round(i),l=a.getElement(e,t);if(a.isInBounds(r,o)){const s=a.getElement(r,o);if(s&&(0===s.id||s.movable&&s.density<l.density)){a.swap(e,t,r,o);const s=a.getCell(r,o);return s&&(s.data.velocityX=n,s.data.velocityY=i),!0}}return Math.abs(n)>Math.abs(i)?n*=-.3:i*=-.4,s.data.velocityX=n,s.data.velocityY=i,!1}}class z{constructor(e={}){this.fallSpeed=e.fallSpeed||4,this.dispersionRate=e.dispersionRate||2,this.viscosity=e.viscosity||0,this.levelingEnabled=!1!==e.levelingEnabled,this.avoidElements=e.avoidElements||[]}apply(e,t,a){const s=a.getCell(e,t);if(a.getElement(e,t),s&&(void 0!==s.data.velocityX||void 0!==s.data.velocityY)){if(this.applyVelocity(e,t,a,s))return!0}let n=0;const i=Math.max(1,this.fallSpeed-this.viscosity);for(;n<i;){const s=t+n+1;if(!a.canMoveTo(e,t+n,e,s))break;const i=a.getElement(e,s);if(i&&this.avoidElements.includes(i.name))break;n++}if(n>0)return a.swap(e,t,e,t+n),!0;const r=Math.random()>.5?1:-1;if(a.canMoveTo(e,t,e+r,t+1)){const s=a.getElement(e+r,t+1);if(!s||!this.avoidElements.includes(s.name))return a.swap(e,t,e+r,t+1),!0}if(a.canMoveTo(e,t,e-r,t+1)){const s=a.getElement(e-r,t+1);if(!s||!this.avoidElements.includes(s.name))return a.swap(e,t,e-r,t+1),!0}if(this.levelingEnabled&&a.frameCount%2==0&&Math.random()>.2){if(this.waterLeveling(e,t,a))return!0}if(this.dispersionRate>0){const s=Math.random()>.5?1:-1;for(let n=1;n<=this.dispersionRate;n++){const i=e+s*n;let r=!0;for(let n=e+s;s>0?n<=i:n>=i;n+=s){const e=a.getElement(n,t);if(e&&0!==e.id&&"liquid"!==e.state){r=!1;break}}if(r&&a.canMoveTo(e,t,i,t)){const s=a.getElement(i,t);if(!s||!this.avoidElements.includes(s.name))return a.swap(e,t,i,t),!0}}}return!1}waterLeveling(e,t,a){const s=a.getElement(e,t),n=this.measureLiquidDepth(e-1,t,a,s.state),i=this.measureLiquidDepth(e+1,t,a,s.state),r=this.measureLiquidDepth(e,t+1,a,s.state);return n<r-1&&a.canMoveTo(e,t,e-1,t)?(a.swap(e,t,e-1,t),!0):!!(i<r-1&&a.canMoveTo(e,t,e+1,t))&&(a.swap(e,t,e+1,t),!0)}measureLiquidDepth(e,t,a,s){const n=a.getElement(e,t);if(!n||n.state!==s)return 0;const i=a.getCell(e,t);if(!i)return 0;if(void 0!==i.data.cachedDepth&&void 0!==i.data.cachedDepthFrame&&a.frameCount-i.data.cachedDepthFrame<10)return i.data.cachedDepth;let r=0,o=t;for(;o<a.height&&r<3;){const t=a.getElement(e,o);if(!t||t.state!==s)break;r++,o++}return i.data.cachedDepth=r,i.data.cachedDepthFrame=a.frameCount,r}applyVelocity(e,t,a,s){let n=s.data.velocityX||0,i=s.data.velocityY||0;if(n*=.92,i*=.92,i+=.15,Math.abs(n)<.3&&Math.abs(i)<.3)return delete s.data.velocityX,delete s.data.velocityY,!1;const r=e+Math.round(n),o=t+Math.round(i),l=a.getElement(e,t);if(a.isInBounds(r,o)){const s=a.getElement(r,o);if(s&&(0===s.id||s.movable&&s.density<l.density)){a.swap(e,t,r,o);const s=a.getCell(r,o);return s&&(s.data.velocityX=n,s.data.velocityY=i),!0}}return Math.abs(n)>Math.abs(i)?n*=-.3:i*=-.4,s.data.velocityX=n,s.data.velocityY=i,!1}}class O{constructor(e={}){this.riseSpeed=void 0!==e.riseSpeed?e.riseSpeed:.7,this.spreadRate=void 0!==e.spreadRate?e.spreadRate:.2,this.dissipation=e.dissipation||!1,this.dissipationRate=e.dissipationRate||.001}apply(e,t,a){if(this.dissipation&&Math.random()<this.dissipationRate)return a.setElement(e,t,a.registry.get("empty")),!0;if(Math.random()<this.riseSpeed){if(a.isEmpty(e,t-1))return a.swap(e,t,e,t-1),!0;const s=Math.random()>.5?1:-1;if(a.isEmpty(e+s,t-1))return a.swap(e,t,e+s,t-1),!0;if(a.isEmpty(e-s,t-1))return a.swap(e,t,e-s,t-1),!0}if(Math.random()<this.spreadRate){const s=Math.random()>.5?1:-1;if(a.isEmpty(e+s,t))return a.swap(e,t,e+s,t),!0}return!1}}class W{constructor(e={}){this.pushDownChance=e.pushDownChance||.92,this.glassifyBelowChance=e.glassifyBelowChance||.08,this.glassifySideChance=e.glassifySideChance||.03,this.pushSideChance=e.pushSideChance||.15,this.dryWetSandChance=e.dryWetSandChance||.6}apply(e,t,a){const s=a.getElement(e,t+1);if(s&&"wet_sand"===s.name)return Math.random()<this.dryWetSandChance&&(a.setElement(e,t+1,a.registry.get("sand")),!0);if(s&&"sand"===s.name)return Math.random()<this.pushDownChance?(a.swap(e,t,e,t+1),!0):(a.setElement(e,t+1,a.registry.get("glass")),!0);const n=[[e-1,t],[e+1,t]];for(const[i,r]of n){const t=a.getElement(i,r);if(t&&"sand"===t.name){if(Math.random()<this.pushSideChance){const t=i<e?-1:1,s=a.getElement(i+t,r);return s&&0===s.id?(a.swap(i,r,i+t,r),!0):(a.setElement(i,r,a.registry.get("glass")),!0)}if(Math.random()<this.glassifySideChance)return a.setElement(i,r,a.registry.get("glass")),!0}}return!1}}class Y{constructor(e={}){this.obsidianSideChance=e.obsidianSideChance||.3,this.evaporateWaterChance=e.evaporateWaterChance||.2}apply(e,t,a){const s=[[e-1,t],[e+1,t]];for(const[i,r]of s){const s=a.getElement(i,r);if(s&&"water"===s.name){if(Math.random()<this.obsidianSideChance){a.setElement(i,r,a.registry.get("obsidian"));const s=a.getCell(i,r);s&&(s.data.temperature=100),a.setElement(e,t,a.registry.get("obsidian"));const n=a.getCell(e,t);return n&&(n.data.temperature=100),!0}if(Math.random()<this.evaporateWaterChance)return a.setElement(i,r,a.registry.get("steam")),!0}}const n=[[e-1,t-1],[e+1,t-1]];for(const[i,r]of n){const s=a.getElement(i,r);if(s&&"water"===s.name&&Math.random()<.1){a.setElement(i,r,a.registry.get("obsidian"));const s=a.getCell(i,r);s&&(s.data.temperature=100),a.setElement(e,t,a.registry.get("obsidian"));const n=a.getCell(e,t);return n&&(n.data.temperature=100),!0}}return!1}}class H{constructor(e={}){this.obsidianCoolRate=e.obsidianCoolRate||5,this.obsidianCoolThreshold=e.obsidianCoolThreshold||20,this.obsidianCrustChance=e.obsidianCrustChance||.4,this.hotObsidianEvaporateChance=e.hotObsidianEvaporateChance||.3}apply(e,t,a){const s=[[e-1,t],[e+1,t],[e,t-1]];for(const[n,i]of s){const s=a.getElement(n,i);if(s&&"obsidian"===s.name){const s=a.getCell(n,i);if(void 0===s.data.temperature)continue;const r=i===t-1?this.obsidianCoolRate:.5*this.obsidianCoolRate;if(s.data.temperature-=r,i===t-1){if(s.data.temperature<=this.obsidianCoolThreshold){if(Math.random()<this.obsidianCrustChance){a.setElement(e,t,a.registry.get("stone"));const s=a.getCell(e,t);return s&&(s.data.isCrust=!0),!0}return!1}if(Math.random()<this.hotObsidianEvaporateChance)return a.setElement(e,t,a.registry.get("steam")),!0}else if(s.data.temperature>50&&Math.random()<.2)return a.setElement(e,t,a.registry.get("steam")),!0}}return!1}}const X={DAY_LENGTH:1e3,MONTH_LENGTH:1,SEASON_LENGTH:3,SEASONS:["spring","summer","autumn","winter"],START_SEASON:"random",TEMPERATURE:{spring:{min:.3,max:.6},summer:{min:.7,max:1},autumn:{min:.3,max:.5},winter:{min:-.5,max:.2}},TEMP_TRANSITION_SPEED:.001,WIND_ENABLED:!0,WIND_CHANGE_INTERVAL:600,WIND_STRENGTH_RANGE:{min:0,max:3},WIND_PATTERNS:{spring:{strength:1.5,variability:.8},summer:{strength:.5,variability:.3},autumn:{strength:2.5,variability:1.2},winter:{strength:2,variability:.5}},TREE_GROWTH_MULTIPLIER:{spring:.5,summer:1,autumn:2,winter:999},TREE_DECAY_CHANCE:{spring:0,summer:0,autumn:1e-5,winter:2e-5},LEAF_FALL_RATE:{spring:0,summer:0,autumn:.002,winter:.005},LEAF_REGROWTH_CHANCE:1e-4,LEAVES_PER_BRANCH:3,LEAF_COLORS:{spring:[9498256,10025880,10145074],summer:[2263842,3050327,3978097],autumn:[16766720,16753920,16747520,16737095,16729344,14423100],winter:[9139029]},SURFACE_FREEZE_CHANCE:.001,FREEZE_DEPTH:2,ICE_MELT_MULTIPLIER:{spring:1.5,summer:3,autumn:1,winter:0},WATER_EVAPORATION_MULTIPLIER:{spring:2,summer:50,autumn:1,winter:.1},LEAF_DECAY_MULTIPLIER:{spring:5,summer:1,autumn:.5,winter:.2},SPRING_CLEANUP_THRESHOLD:.4,CLOUD_SPAWN_MULTIPLIER:{spring:1.5,summer:.5,autumn:1.2,winter:4},SNOW_CLOUD_CHANCE:.8,MIGRATION_START:.5,BIRD_SPAWN_SPRING:5,SKY_TINT:{spring:{r:1,g:1.05,b:1.1},summer:{r:1.1,g:1.1,b:1.15},autumn:{r:1.15,g:1,b:.9},winter:{r:.9,g:.95,b:1}},SUN_TINT:{spring:{r:1,g:1,b:.9},summer:{r:1.1,g:1.1,b:1},autumn:{r:1.05,g:.95,b:.85},winter:{r:.95,g:.95,b:.9}}};class q{constructor(e={}){this.freezeChance=e.freezeChance||X.SURFACE_FREEZE_CHANCE,this.freezeDepth=e.freezeDepth||X.FREEZE_DEPTH}apply(e,t,a){const s=a.seasonData;if(!s)return!1;if(s.temperature>=0)return!1;const n=a.getElement(e,t-1);if(!n||0!==n.id)return!1;let i=0;for(let l=-1;l>=-this.freezeDepth;l--){const s=a.getElement(e,t+l);if(!s||0!==s.id)break;i++}const r=1/(i+1),o=this.freezeChance*r;return Math.random()<o&&(a.setElement(e,t,a.registry.get("ice")),!0)}}class V{constructor(e={}){this.baseMeltChance=e.baseMeltChance||.05}apply(e,t,a){const s=a.seasonData;return s?(s.temperature,"winter"===s.season?this.checkAdjacentHeat(e,t,a,.1*this.baseMeltChance):"summer"===s.season?this.checkAdjacentHeat(e,t,a,3*this.baseMeltChance):"spring"===s.season?this.checkAdjacentHeat(e,t,a,1.5*this.baseMeltChance):this.checkAdjacentHeat(e,t,a,this.baseMeltChance)):this.checkAdjacentHeat(e,t,a,this.baseMeltChance)}checkAdjacentHeat(e,t,a,s){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]];for(const[i,r]of n){const n=a.getElement(i,r);if(n&&n.hasTag&&n.hasTag("heat_source")&&Math.random()<s)return a.setElement(e,t,a.registry.get("water")),!0}return!1}}class U{constructor(e={}){this.lifetime=e.lifetime||3e3,this.spreadChance=e.spreadChance||.15,this.spreadIntensity=e.spreadIntensity||1,this.burnsInto=e.burnsInto||"ash"}apply(e,t,a,s){void 0===s.data.burnProgress&&(s.data.burnProgress=0,s.data.lifetime=this.lifetime),s.data.burnProgress++;const n=s.data.burnProgress/this.lifetime;if(s.data.burnProgress>=this.lifetime)return a.setElement(e,t,a.registry.get(this.burnsInto)),!0;const i=n<.66?1:.3,r=this.spreadChance*i;if(Math.random()<r){const s=[[e-1,t],[e+1,t],[e,t-1],[e,t+1]];s.sort(()=>Math.random()-.5);for(const[e,t]of s){const s=a.getElement(e,t);if(s&&s.hasTag&&s.hasTag(h)){const n=s.burnsInto?a.registry.get(s.burnsInto):a.registry.get("fire");return a.setElement(e,t,n),!0}}}return!1}}class j{constructor(e={}){this.emitElement=e.emitElement||"fire",this.emissionRate=e.emissionRate||.15,this.stages=e.stages||null,this.directions=e.directions||[[0,-1]],this.requiresEmpty=!1!==e.requiresEmpty}apply(e,t,a,s){let n=this.emissionRate;if(this.stages&&void 0!==s.data.burnProgress&&s.data.lifetime){const e=s.data.burnProgress/s.data.lifetime;for(const t of this.stages)if(e<t.until){n=t.rate;break}}if(Math.random()<n)for(const[i,r]of this.directions){const s=e+i,n=t+r;if((!this.requiresEmpty||a.isEmpty(s,n))&&(!this.requiresEmpty||a.isEmpty(s,n)))return a.setElement(s,n,a.registry.get(this.emitElement)),!0}return!1}}class K{constructor(e={}){this.ignitionChance=e.ignitionChance||.2,this.range=e.range||1,this.checkDiagonals=!1!==e.checkDiagonals}apply(e,t,a){const s=[];this.range>=1&&s.push([e-1,t],[e+1,t],[e,t-1],[e,t+1]),this.checkDiagonals&&this.range>=1&&s.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]),this.range>=2&&s.push([e,t-2],[e,t+2],[e-2,t],[e+2,t]),s.sort(()=>Math.random()-.5);for(const[n,i]of s){const e=a.getElement(n,i);if(e&&e.hasTag&&e.hasTag(h)){const t=1-(e.ignitionResistance||0),s=this.ignitionChance*t;if(Math.random()<s){const t=e.burnsInto?a.registry.get(e.burnsInto):a.registry.get("fire");return a.setElement(n,i,t),!0}}}return!1}}class Z{constructor(e={}){this.detectionRange=e.detectionRange||1,this.ignitionChance=e.ignitionChance||.5,this.transformInto=e.transformInto||"fire",this.checkInterval=e.checkInterval||1}apply(e,t,a,s){if(void 0===s.data.ignitionCheckFrame&&(s.data.ignitionCheckFrame=0),s.data.ignitionCheckFrame++,s.data.ignitionCheckFrame<this.checkInterval)return!1;s.data.ignitionCheckFrame=0;for(let n=-this.detectionRange;n<=this.detectionRange;n++)for(let s=-this.detectionRange;s<=this.detectionRange;s++){if(0===s&&0===n)continue;const i=a.getElement(e+s,t+n);if(i&&i.hasTag&&i.hasTag(c)&&Math.random()<this.ignitionChance)return a.setElement(e,t,a.registry.get(this.transformInto)),!0}return!1}}class J{constructor(e={}){this.extinguishesTo=e.extinguishesTo||"ash",this.waterToSteamChance=e.waterToSteamChance||.5,this.extinguishChance=e.extinguishChance||1,this.waterSources=e.waterSources||["water"]}apply(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of s){const s=a.getElement(n,i);if(s&&this.waterSources.includes(s.name)&&Math.random()<this.extinguishChance)return a.setElement(e,t,a.registry.get(this.extinguishesTo)),Math.random()<this.waterToSteamChance&&a.setElement(n,i,a.registry.get("steam")),!0}return!1}}const Q=()=>5+8*Math.random(),$=1,ee=()=>3+Math.floor(2*Math.random()),te=2,ae=()=>.5+.25*Math.random(),se=25*Math.PI/180,ne=50*Math.PI/180,ie=20*Math.PI/180,re=.3,oe=1,le=120,de=80,he=2,ce=3;class me{constructor(e={}){this.transformInto=e.transformInto||"water",this.transformChance=e.transformChance||.05,this.requiredTag=e.requiredTag||c,this.checkDiagonals=!1!==e.checkDiagonals}apply(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];this.checkDiagonals&&s.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]);for(const[n,i]of s){const s=a.getElement(n,i);if(s&&s.hasTag&&s.hasTag(this.requiredTag)&&Math.random()<this.transformChance)return a.setElement(e,t,a.registry.get(this.transformInto)),!0}return!1}}class ue{constructor(e={}){this.meltingRules=e.meltingRules||[],this.checkBelow=!1!==e.checkBelow,this.checkDiagonals=e.checkDiagonals||!1,this.checkCardinal=e.checkCardinal||!1}apply(e,t,a){const s=[];this.checkBelow&&s.push([e,t+1]),this.checkDiagonals&&s.push([e-1,t+1],[e+1,t+1]),this.checkCardinal&&s.push([e-1,t],[e+1,t],[e,t-1]);for(const[n,i]of s){const e=a.getElement(n,i);if(e)for(const t of this.meltingRules)if(e.name===t.target){const e=void 0!==t.chance?t.chance:1;if(Math.random()<e){let e=t.result;return Array.isArray(t.result)&&(e=t.result[Math.floor(Math.random()*t.result.length)]),a.setElement(n,i,a.registry.get(e)),!0}}}return!1}}class ge{constructor(e={}){this.targetElement=e.targetElement||"water",this.freezeInto=e.freezeInto||"ice",this.freezeChance=e.freezeChance||.03,this.checkDiagonals=!1!==e.checkDiagonals}apply(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];this.checkDiagonals&&s.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]);for(const[n,i]of s){const e=a.getElement(n,i);if(e&&e.name===this.targetElement&&Math.random()<this.freezeChance)return a.setElement(n,i,a.registry.get(this.freezeInto)),!0}return!1}}class fe{constructor(e={}){this.corrosionRules=e.corrosionRules||[],this.checkDiagonals=e.checkDiagonals||!1,this.emitByproduct=e.emitByproduct||null,this.byproductChance=e.byproductChance||.5,this.selfDilutionChance=e.selfDilutionChance||0,this.selfDilutionResult=e.selfDilutionResult||"water"}apply(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];this.checkDiagonals&&s.push([e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]);for(const[n,i]of s){const s=a.getElement(n,i);if(s)for(const r of this.corrosionRules){let o=!1;if(r.tag&&s.hasTag&&s.hasTag(r.tag)&&(o=!0),r.target&&s.name===r.target&&(o=!0),o&&Math.random()<r.chance){const s=r.result||"empty";return a.setElement(n,i,a.registry.get(s)),this.emitByproduct&&Math.random()<this.byproductChance&&a.isEmpty(n,i-1)&&a.setElement(n,i-1,a.registry.get(this.emitByproduct)),this.selfDilutionChance>0&&Math.random()<this.selfDilutionChance&&a.setElement(e,t,a.registry.get(this.selfDilutionResult)),!0}}}return!1}}class pe{constructor(e={}){this.wetForm=e.wetForm,this.dryForm=e.dryForm,this.waterSources=e.waterSources||["water","wet_sand"],this.wettingChance=e.wettingChance||1,this.dryingChance=e.dryingChance||5e-4,this.requiresExposure=e.requiresExposure||!1}apply(e,t,a,s){const n=a.getElement(e,t);if(!n)return!1;const i=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let r=!1;for(const[o,l]of i){const e=a.getElement(o,l);if(e&&this.waterSources.includes(e.name)){r=!0;break}}if(s.data.isTouchingWater=r,n.name===this.dryForm&&r&&Math.random()<this.wettingChance)return a.setElement(e,t,a.registry.get(this.wetForm)),!0;if(n.name===this.wetForm&&!r){if(this.requiresExposure){const s=a.getElement(e,t-1);if(!s||0!==s.id)return!1}if(Math.random()<this.dryingChance)return a.setElement(e,t,a.registry.get(this.dryForm)),!0}return!1}}const ye=new class{constructor(){this.elements=new Map,this.interactionManager=new L}register(e){this.elements.set(e.name,e),this.elements.set(e.id,e)}get(e){return this.elements.get(e)}getById(e){return this.elements.get(e)}getByName(e){return this.elements.get(e)}checkInteraction(e,t,a,s,n,i,r){return this.interactionManager.checkInteraction(e,t,a,s,n,i,r,this)}registerInteraction(e){this.interactionManager.registerInteraction(e)}getAllElements(){const e=[];for(const[t,a]of this.elements.entries())"string"==typeof t&&e.push(a);return e}};ye.register(new class extends G{constructor(){super(0,"empty",0,{density:0,state:n,movable:!1,tags:[]})}}),ye.register(new class extends G{constructor(){super(20,"player",65535,{density:3,state:i,movable:!1,ignitionResistance:1,tags:[],brushSize:0})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;s.data.initialized||(s.data.initialized=!0,s.data.velocityY=0,s.data.isOnGround=!1);const n=a.getElement(e,t+1);if(!n||"empty"!==n.name&&"water"!==n.name)s.data.velocityY=0,s.data.isOnGround=!0;else if(s.data.velocityY=Math.min(s.data.velocityY+.3,2),s.data.velocityY<0){const n=t-Math.ceil(Math.abs(s.data.velocityY)),i=a.getElement(e,n);if(i&&("empty"===i.name||"water"===i.name))return a.swap(e,t,e,n),s.data.isOnGround=!1,!0;s.data.velocityY=0}else if(s.data.velocityY>0){const n=Math.floor(s.data.velocityY);if(n>0){const i=t+n,r=a.getElement(e,i);if(r&&("empty"===r.name||"water"===r.name))return a.swap(e,t,e,i),s.data.isOnGround=!1,!0;{const n=a.getElement(e,t+1);if(n&&("empty"===n.name||"water"===n.name))return a.swap(e,t,e,t+1),s.data.isOnGround=!1,!0}}}return!1}handleMovement(e,t,a,s){if(!a.getCell(e,t))return!1;switch(s){case"left":return this.moveHorizontal(e,t,a,-1);case"right":return this.moveHorizontal(e,t,a,1);case"jump":return this.jump(e,t,a);default:return!1}}moveHorizontal(e,t,a,s){const n=e+s,i=a.getElement(n,t);if(i&&("empty"===i.name||"water"===i.name))return a.swap(e,t,n,t),!0;const r=a.getElement(n,t-1);return!(!r||"empty"!==r.name&&"water"!==r.name)&&(a.swap(e,t,n,t-1),!0)}jump(e,t,a){const s=a.getCell(e,t);if(!s||!s.data.isOnGround)return!1;s.data.velocityY=-2.5,s.data.isOnGround=!1;const n=a.getElement(e,t-1);return!(!n||"empty"!==n.name&&"water"!==n.name)&&(a.swap(e,t,e,t-1),!0)}}),ye.register(new class extends G{constructor(){super(I,"fire",16737792,{density:0,state:l,temperature:d,dispersion:2,lifetime:60,tags:new Set([c]),brushSize:2,emissionDensity:.5}),this.movement=new O({riseSpeed:.7,spreadRate:.2,dissipation:!1})}updateImpl(e,t,a){return this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(R,"smoke",5592405,{density:0,state:l,dispersion:3,lifetime:300,tags:new Set}),this.atmosphereThreshold=.4,this.movement=new O({riseSpeed:.6,spreadRate:.4,dissipation:!1}),this.atmosphereMovement=new O({riseSpeed:.15,spreadRate:.7,dissipation:!1})}updateImpl(e,t,a){if(!a.getCell(e,t))return!1;return t<Math.floor(a.height*this.atmosphereThreshold)?this.atmosphereMovement.apply(e,t,a):this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(D,"steam",13421772,{density:0,state:l,dispersion:2,lifetime:240,condensesInto:"cloud",tags:new Set([b])}),this.atmosphereThreshold=.4,this.movement=new O({riseSpeed:.8,spreadRate:.15,dissipation:!1})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;const n=t<=Math.floor(a.height*this.atmosphereThreshold);if(n){const n=this.countNearbySteam(e,t,a);if(n>=3){const s=a.registry.get("cloud");if(s){a.setElement(e,t,s);const i=a.getCell(e,t);return i&&(i.data.saturation=Math.min(n,5)),!0}}if(void 0===s.data.atmosphereTime&&(s.data.atmosphereTime=0,s.data.condensationDelay=360+Math.floor(240*Math.random())),s.data.atmosphereTime++,s.data.atmosphereTime>=s.data.condensationDelay){const s=a.registry.get("cloud");if(s){a.setElement(e,t,s);const n=a.getCell(e,t);return n&&(n.data.saturation=1),!0}}}else void 0!==s.data.atmosphereTime&&(delete s.data.atmosphereTime,delete s.data.condensationDelay);if(n){if(Math.random()>.5){const s=Math.random()>.5?1:-1;if(a.isEmpty(e+s,t))return a.swap(e,t,e+s,t),!0}return!1}return this.movement.apply(e,t,a)}countNearbySteam(e,t,a){let s=0;for(let n=-2;n<=2;n++)for(let i=-2;i<=2;i++){if(0===i&&0===n)continue;const r=a.getElement(e+i,t+n);r&&"steam"===r.name&&s++}return s}}),ye.register(new class extends G{constructor(){super(35,"electricity",16776960,{density:0,state:l,movable:!0,tags:[c],brushSize:0,emissionDensity:.3})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(void 0===s.data.lifetime&&(s.data.lifetime=5+Math.floor(10*Math.random()),s.data.hasConducted=!1),s.data.lifetime--,s.data.lifetime<=0)return a.setElement(e,t,a.registry.get("empty")),!0;if(!s.data.hasConducted){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[e,t]of n){const n=a.getElement(e,t);if(n&&n.hasTag&&n.hasTag(C)&&Math.random()<.4)return a.setElement(e,t,a.registry.get("electricity")),s.data.hasConducted=!0,!0;if(n&&n.hasTag&&n.hasTag(h)&&Math.random()<.5){const s=n.burnsInto?a.registry.get(n.burnsInto):a.registry.get("fire");return a.setElement(e,t,s),!0}}}if(Math.random()<.7){const s=a.getElement(e,t+1);if(s&&("empty"===s.name||s.hasTag&&s.hasTag(C)))return s.hasTag&&s.hasTag(C)?a.setElement(e,t+1,a.registry.get("electricity")):a.swap(e,t,e,t+1),!0;if(Math.random()<.3){const s=Math.random()>.5?1:-1,n=a.getElement(e+s,t+1);if(n&&"empty"===n.name)return a.swap(e,t,e+s,t+1),!0}}return!1}}),ye.register(new class extends G{constructor(){super(x,"water",39423,{density:2,state:o,dispersion:3,evaporatesInto:"steam",tags:new Set([w,M,S,C]),brushSize:5,emissionDensity:1}),this.addBehavior(new q),this.addBehavior(new H({obsidianCoolRate:5,obsidianCoolThreshold:20,obsidianCrustChance:.4,hotObsidianEvaporateChance:.3})),this.movement=new z({fallSpeed:4,dispersionRate:3,viscosity:0,levelingEnabled:!0})}updateImpl(e,t,a){if(this.applyBehaviors(e,t,a))return!0;const s=a.getElement(e,t-1);if(s&&0===s.id){if(this.isAtSurface(e,t,a)){const s=a.seasonData;let n=1;if(s){n={spring:2,summer:50,autumn:1,winter:.1}[s.season]||1,s.temperature>.7&&(n*=1.5)}const i=1e-4*n;if(Math.random()<i)return a.setElement(e,t,a.registry.get("steam")),!0}}const n=a.getElement(e,t+1);if(n&&"wet_sand"===n.name){const s=a.getElement(e,t+2);if(s&&0===s.id&&Math.random()>.93)return a.swap(e,t,e,t+2),!0}return this.movement.apply(e,t,a)}isAtSurface(e,t,a){const s=a.getElement(e,t-1);if(!s||0!==s.id)return!1;const n=a.getElement(e,t+1);if(!n||0===n.id){const s=a.getElement(e-1,t+1),i=a.getElement(e+1,t+1);return n&&0!==n.id||s&&"water"===s.name||i&&"water"===i.name}return!0}}),ye.register(new class extends G{constructor(){super(k,"oil",4013338,{density:1.5,state:o,dispersion:2,ignitionResistance:.2,tags:new Set([h]),burnsInto:"fire",brushSize:5,emissionDensity:1}),this.addBehavior(new Z({detectionRange:1,ignitionChance:.5,transformInto:"fire",checkInterval:20})),this.movement=new z({fallSpeed:2,dispersionRate:1,viscosity:1,levelingEnabled:!1})}onInteract(e,t,a,s,n,i){if(e.hasTag(c)){const e=Math.random();if(e>.6){if(t.isEmpty(a,s-1))return t.setElement(a,s-1,t.registry.get("fire")),!0;const e=Math.random()>.5?1:-1;if(t.isEmpty(a+e,s))return t.setElement(a+e,s,t.registry.get("fire")),!0}return!(e>.8)||(t.setElement(a,s,t.registry.get("fire")),t.isEmpty(a,s-1)&&t.setElement(a,s-1,t.registry.get("smoke")),!0)}return null}updateImpl(e,t,a){return!!this.applyBehaviors(e,t,a)||this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(P,"lava",16729344,{density:8,state:o,movable:!0,tags:new Set([c,m]),brushSize:3,emissionDensity:.7,lifetime:-1}),this.addBehavior(new K({ignitionChance:.2,range:1,checkDiagonals:!1})),this.addBehavior(new W({pushDownChance:.92,glassifyBelowChance:.08,glassifySideChance:.03,pushSideChance:.15,dryWetSandChance:.6})),this.addBehavior(new Y({obsidianSideChance:.3,evaporateWaterChance:.2})),this.addBehavior(new ue({meltingRules:[{target:"ice",result:"steam",chance:.3},{target:"salt",result:"smoke",chance:.1}],checkBelow:!0,checkDiagonals:!0,checkCardinal:!0})),this.addBehavior(new j({emitElement:"smoke",emissionRate:.02,directions:[[0,-1]]})),this.movement=new z({fallSpeed:2,dispersionRate:1,viscosity:2,levelingEnabled:!1})}updateImpl(e,t,a){var s,n,i,r,o,l,d,h,c;const m=a.getCell(e,t),u=t>0&&0===(null==(i=null==(n=null==(s=a.grid[t-1])?void 0:s[e])?void 0:n.element)?void 0:i.id),g=0===e||e===a.width-1||"lava"===(null==(l=null==(o=null==(r=a.grid[t])?void 0:r[e-1])?void 0:o.element)?void 0:l.name)||"lava"===(null==(c=null==(h=null==(d=a.grid[t])?void 0:d[e+1])?void 0:h.element)?void 0:c.name);m&&(m.data.isLavaSurface=u&&g);return!!this.applyBehaviors(e,t,a)||this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(N,"acid",8388352,{density:1.2,state:o,movable:!0,tags:new Set([p]),brushSize:2,emissionDensity:.6}),this.addBehavior(new fe({corrosionRules:[{tag:v,chance:.15,result:"smoke"},{tag:E,chance:.1,result:"smoke"},{target:"fish",chance:.15,result:"smoke"},{target:"ash",chance:.15,result:"smoke"}],emitByproduct:"smoke",byproductChance:.05,selfDilutionChance:.05,selfDilutionResult:"water",checkDiagonals:!1})),this.movement=new z({fallSpeed:3,dispersionRate:1,viscosity:0,levelingEnabled:!1})}updateImpl(e,t,a){if(this.applyBehaviors(e,t,a))return!0;const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of s){const s=a.getElement(n,i);if(s&&"lava"===s.name&&Math.random()<.3){if(a.setElement(e,t,a.registry.get("steam")),Math.random()<.5){const s=a.getElement(e,t-1);s&&0===s.id&&a.setElement(e,t-1,a.registry.get("smoke"))}return!0}if(s&&"fire"===s.name&&Math.random()<.2)return a.setElement(e,t,a.registry.get("steam")),!0}for(const[n,i]of s){const s=a.getElement(n,i);if(s&&"water"===s.name&&Math.random()<.05)return a.setElement(e,t,a.registry.get("water")),!0}return this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(32,"slush",11591910,{density:1.9,state:o,movable:!0,tags:new Set([u]),brushSize:3,emissionDensity:.7}),this.addBehavior(new me({transformInto:"water",transformChance:.1,requiredTag:c,checkDiagonals:!0})),this.movement=new z({fallSpeed:2,dispersionRate:1,viscosity:.7,levelingEnabled:!0})}updateImpl(e,t,a){if(this.applyBehaviors(e,t,a))return!0;const s=a.seasonData;if(s){const n=s.season,i=s.seasonProgress||0;let r=0;if("spring"===n?r=5e-4+.001*i:"summer"===n&&(r=.015),r>0&&Math.random()<r)return a.setElement(e,t,a.registry.get("water")),!0}const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let i=!1,r=!1;for(const[o,l]of n){const e=a.getElement(o,l);e&&"water"===e.name&&(i=!0),e&&0!==e.id||(r=!0)}return r&&!i&&Math.random()<.002?(a.setElement(e,t,a.registry.get("ice")),!0):this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(T,"sand",14329120,{density:3,state:r,dispersion:1,tags:new Set([E]),brushSize:5,emissionDensity:1}),this.movement=new F({fallSpeed:1,slideAngle:!0,slideStability:.85})}updateImpl(e,t,a){const s=a.getElement(e,t-1),n=a.getElement(e,t+1);return s&&"water"===s.name&&n&&(0===n.id||"sand"===n.name)&&Math.random()<.5?(a.swap(e,t-1,e,t),!0):this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(18,"wet_sand",9139029,{density:9,state:r,dispersion:0,tags:[],lifetime:-1,brushSize:5,emissionDensity:1})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.exposureTime&&(s.data.exposureTime=0);const n=a.getElement(e,t-1);!n||n.id;const i=n&&"water"===n.name,r=a.getElement(e,t+1),o=a.getElement(e-1,t),l=a.getElement(e+1,t);if(n&&"water"===n.name||r&&"water"===r.name||o&&"water"===o.name||l&&"water"===l.name||i)s.data.exposureTime=0;else{const i=[n,r,o,l];let d=0;for(const e of i)e&&0!==e.id&&"sand"!==e.name||d++;if(d>=4){if(s.data.exposureTime++,s.data.exposureTime>240)return a.setElement(e,t,a.registry.get("sand")),!0}else if(d>=3){if(s.data.exposureTime++,s.data.exposureTime>360)return a.setElement(e,t,a.registry.get("sand")),!0}else if(d>=2){if(s.data.exposureTime++,s.data.exposureTime>900)return a.setElement(e,t,a.registry.get("sand")),!0}else if(d>=1){if(s.data.exposureTime++,s.data.exposureTime>2400)return a.setElement(e,t,a.registry.get("sand")),!0}else s.data.exposureTime=0}if(i&&r&&0===r.id&&Math.random()<.7)return a.swap(e,t-1,e,t+1),!0;if(r&&"water"===r.name)return a.swap(e,t,e,t+1),!0;if(r&&0===r.id)return a.swap(e,t,e,t+1),!0;const d=Math.random()>.5?-1:1,h=a.getElement(e+d,t+1);if(h&&(0===h.id||"water"===h.name))return a.swap(e,t,e+d,t+1),!0;const c=a.getElement(e-d,t+1);return!(!c||0!==c.id&&"water"!==c.name)&&(a.swap(e,t,e-d,t+1),!0)}}),ye.register(new class extends G{constructor(){super(B,"gunpowder",3355443,{density:3,state:r,dispersion:1,ignitionResistance:0,burnsInto:"fire",tags:new Set([h,f]),brushSize:4,emissionDensity:1}),this.addBehavior(new pe({dryForm:"gunpowder",wetForm:"wet_gunpowder",waterSources:["water","wet_sand"],wettingChance:1,dryingChance:5e-4})),this.movement=new F({fallSpeed:1,slideAngle:!0,slideStability:.85})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(void 0!==s.data.velocityX||void 0!==s.data.velocityY){if(this.applyVelocity(e,t,a,s))return!0}return!!this.applyBehaviors(e,t,a)||this.movement.apply(e,t,a)}applyVelocity(e,t,a,s){let n=s.data.velocityX||0,i=s.data.velocityY||0;if(n*=.92,i*=.92,i+=.15,Math.abs(n)<.3&&Math.abs(i)<.3)return delete s.data.velocityX,delete s.data.velocityY,!1;const r=e+Math.round(n),o=t+Math.round(i);if(a.isInBounds(r,o)){const s=a.getCell(r,o).element;if(s&&(0===s.id||s.movable&&s.density<this.density)){a.swap(e,t,r,o);const s=a.getCell(r,o);return s&&(s.data.velocityX=n,s.data.velocityY=i),!0}}return Math.abs(n)>Math.abs(i)?n*=-.3:i*=-.4,s.data.velocityX=n,s.data.velocityY=i,!1}onInteract(e,t,a,s,n,i){return e.hasTag(c)?(this.explode(a,s,t),!0):null}explode(e,t,a){const s=a.registry.get("fire"),n=a.registry.get("smoke"),i=[];for(let r=-4;r<=4;r++)for(let s=-4;s<=4;s++){const n=Math.sqrt(s*s+r*r);if(n<=4){const o=e+s,l=t+r;a.isInBounds(o,l)&&i.push({x:o,y:l,dist:n,dx:s,dy:r})}}i.sort((e,t)=>e.dist-t.dist);for(const r of i){const e=a.getElement(r.x,r.y);if(!e)continue;const t=Math.pow(1-r.dist/4,1.5);if(r.dist<1.5)a.setElement(r.x,r.y,s);else if("gunpowder"===e.name&&r.dist<3.2)setTimeout(()=>{var e;"gunpowder"===(null==(e=a.getElement(r.x,r.y))?void 0:e.name)&&this.explode(r.x,r.y,a)},50*Math.random()+10);else if(e.hasTag(h)&&Math.random()<.8*t)a.setElement(r.x,r.y,s);else{if(e.movable&&t>.2){const s=a.getCell(r.x,r.y);if(s){const a=Math.atan2(r.dy,r.dx),n=.7,i=Math.abs(Math.cos(a)),o=Math.abs(Math.sin(a)),l=8*t;let d,h;r.dy<0?(d=Math.sign(r.dx)*l*i*(1-n),h=-l*n):(d=Math.sign(r.dx)*l*i*.5,h=-l*(n+.3*o));const c=Math.max(.5,3/(e.density+1));d*=c,h*=c,s.data.velocityX=d,s.data.velocityY=h}}r.dist>2&&r.dist<3.5&&0===e.id&&Math.random()<.6&&a.setElement(r.x,r.y,n)}}}}),ye.register(new class extends G{constructor(){super(19,"wet_gunpowder",2763290,{density:4,state:r,movable:!0,ignitionResistance:.8,burnsInto:"fire",tags:[h],brushSize:0,emissionDensity:0}),this.addBehavior(new pe({dryForm:"gunpowder",wetForm:"wet_gunpowder",waterSources:["water","wet_sand"],wettingChance:1,dryingChance:5e-4})),this.movement=new F({fallSpeed:1,slideAngle:!0,slideStability:.85})}updateImpl(e,t,a){return!!this.applyBehaviors(e,t,a)||this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(_,"ash",10066329,{density:1,state:r,dispersion:1,tags:new Set([y]),lifetime:360}),this.movement=new F({fallSpeed:1,slideAngle:!0,slideStability:.9})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;const n=a.getElement(e,t+1);return n&&"water"===n.name?(s.lifetime>0&&(s.lifetime-=2),Math.random()>.7&&(a.swap(e,t,e,t+1),!0)):this.movement.apply(e,t,a)}}),ye.register(new class extends G{constructor(){super(31,"snow",16777215,{density:1,state:r,movable:!0,tags:[u],brushSize:3,emissionDensity:.6}),this.addBehavior(new me({transformInto:"water",transformChance:.15,requiredTag:c,checkDiagonals:!0}))}updateImpl(e,t,a){if(this.applyBehaviors(e,t,a))return!0;const s=a.seasonData;if(s){const n=s.season,i=s.seasonProgress||0;let r=0;if("spring"===n?r=1e-4+2e-4*i:"summer"===n&&(r=.005),r>0&&Math.random()<r)return a.setElement(e,t,a.registry.get("water")),!0}const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[o,l]of n){const s=a.getElement(o,l);if(s&&"water"===s.name&&Math.random()<.4)return a.setElement(e,t,a.registry.get("slush")),!0}if(Math.random()>.3)return!1;const i=a.getElement(e,t+1);if(i&&"water"===i.name)return a.setElement(e,t,a.registry.get("slush")),!0;if(a.canMoveTo(e,t,e,t+1))return a.swap(e,t,e,t+1),!0;const r=Math.random()>.5?-1:1;return!!(Math.random()>.5&&a.canMoveTo(e,t,e+r,t+1))&&(a.swap(e,t,e+r,t+1),!0)}}),ye.register(new class extends G{constructor(){super(3,"stone",8421504,{density:10,state:i,movable:!0,tags:[],brushSize:1,emissionDensity:1}),this.processedBoulders=new Set}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;const n=s.data.boulderId;return void 0!==n?this.updateBoulder(e,t,a,n):this.updateIndividual(e,t,a)}updateBoulder(e,t,a,s){return!this.processedBoulders.has(s)&&(this.processedBoulders.add(s),!!a.canBoulderMoveDown(s)&&(a.moveBoulderDown(s),!0))}updateIndividual(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(s.data.isCrust)return!1;const n=a.getCell(e,t+1);if(!n)return!1;const i=n.element;return(0===i.id||"liquid"===i.state&&this.density>i.density)&&(a.swap(e,t,e,t+1),!0)}}),ye.register(new class extends G{constructor(){super(5,"wood",9127187,{density:5,state:i,movable:!1,ignitionResistance:.65,burnsInto:"burning_wood",tags:[h,v],brushSize:1,emissionDensity:1})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let i=0;for(const[r,o]of n){const e=a.getElement(r,o);!e||"stone"!==e.name&&"sand"!==e.name||i++}if(i>=4){if(s.data.burialTime||(s.data.burialTime=0),s.data.burialTime++,s.data.burialTime>1200&&Math.random()>.99){const s=a.registry.get("fossil");if(s)return a.setElement(e,t,s),!0}}else{s.data.burialTime=0;for(const[s,i]of n){const n=a.getElement(s,i);if(n&&("sand"===n.name||"water"===n.name)){const s=a.registry.get("tree_trunk");if(s){a.setElement(e,t,s);const n=a.getCell(e,t);n&&(n.data.growthStage=0,n.data.growthTimer=0,n.data.canGrow=!0)}return!0}}}return!1}}),ye.register(new class extends G{constructor(){super(18,"ice",8900331,{density:1.8,state:i,movable:!0,tags:new Set([u]),brushSize:1,emissionDensity:.8}),this.addBehavior(new V({baseMeltChance:.05})),this.addBehavior(new ge({targetElement:"water",freezeInto:"ice",freezeChance:5e-4,checkDiagonals:!1}))}updateImpl(e,t,a){if(this.applyBehaviors(e,t,a))return!0;const s=a.seasonData;if(s){const n=s.season,i=s.seasonProgress||0;let r=0;if("spring"===n?r=2e-4+6e-4*i:"summer"===n&&(r=.01),r>0&&Math.random()<r)return a.setElement(e,t,a.registry.get("water")),!0}const n=a.getElement(e,t+1),i=a.getElement(e,t-1);return n&&0===n.id||n&&"water"===n.name&&i&&"ice"===i.name&&Math.random()<.3?(a.swap(e,t,e,t+1),!0):(!n||"water"!==n.name)&&(!!(n&&"liquid"===n.state&&n.density<this.density)&&(a.swap(e,t,e,t+1),!0))}}),ye.register(new class extends G{constructor(){super(21,"glass",11393254,{density:5,state:i,movable:!1,tags:[h],ignitionResistance:.9,burnsInto:"empty",brushSize:1,emissionDensity:.8,canInteract:!1})}updateImpl(e,t,a){return!1}}),ye.register(new class extends G{constructor(){super(18,"wall",4473924,{density:10,state:i,movable:!1,tags:[],brushSize:1,emissionDensity:1,canInteract:!1})}}),ye.register(new class extends G{constructor(){super(32,"obsidian",657940,{density:10,state:i,movable:!0,ignitionResistance:1,tags:[E],brushSize:2,emissionDensity:.8})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0!==s.data.temperature&&s.data.temperature>0&&Math.random()<.001&&(s.data.temperature-=1,s.data.temperature>70?s.element.color=1706516:s.data.temperature>40?s.element.color=1182228:s.element.color=657940);const n=a.getElement(e,t+1);return!!n&&((0===n.id||"liquid"===n.state&&this.density>n.density)&&(a.swap(e,t,e,t+1),!0))}}),ye.register(new class extends G{constructor(){super(29,"coal",1710618,{density:5,state:i,movable:!0,ignitionResistance:.7,burnsInto:"burning_coal",tags:[h],brushSize:2,emissionDensity:.7})}updateImpl(e,t,a){const s=a.getElement(e,t+1);return(s&&0===s.id||!!(s&&"liquid"===s.state&&this.density>s.density))&&(a.swap(e,t,e,t+1),!0)}}),ye.register(new class extends G{constructor(){super(15,"fossil",9139029,{density:8,state:i,movable:!1,ignitionResistance:1,tags:[v],brushSize:1,emissionDensity:1})}updateImpl(e,t,a){if(Math.random()>.9999){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[s[e],s[t]]=[s[t],s[e]]}for(const[e,t]of s)if(a.isEmpty(e,t)){const s=a.registry.get("oil");if(s)return a.setElement(e,t,s),!0}}return!1}}),ye.register(new class extends G{constructor(){super(50,"light",16774368,{density:0,state:i,movable:!1,tags:[],brushSize:0,emissionDensity:1,glowing:!0})}updateImpl(e,t,a){return!1}}),ye.register(new class extends G{constructor(){super(10,"tree_seed",6636321,{density:3,state:i,movable:!1,ignitionResistance:0,burnsInto:"ash",tags:[v,h],brushSize:0,emissionDensity:1})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(!!a.isEmpty(e,t+1)){if(a.canMoveTo(e,t,e,t+1))return a.swap(e,t,e,t+1),!0;const s=Math.random()>.5?1:-1;if(a.canMoveTo(e,t,e+s,t+1))return a.swap(e,t,e+s,t+1),!0;if(a.canMoveTo(e,t,e-s,t+1))return a.swap(e,t,e-s,t+1),!0}const n=a.getElement(e,t+1);if(!n||!["sand","wet_sand","stone","wall","wood","tree_trunk","tree_branch","fossil","ash"].includes(n.name))return s.data.treeStructure&&(delete s.data.treeStructure,delete s.data.growthTimer,delete s.data.growthFrameCounter),!1;if(void 0===s.data.growthTimer&&(s.data.growthTimer=0,s.data.checkedConditions=!1),s.data.growthTimer++,s.data.growthTimer<le)return!1;if(!s.data.checkedConditions){const n=12,i=this.hasNearbyTree(e,t,a,n),r=Math.random()<.03;if(i&&!r)return Math.random()<.002&&a.setElement(e,t,a.registry.get("ash")),!1;s.data.checkedConditions=!0}if(!s.data.treeStructure)return s.data.treeStructure=this.generateFractalTree(e,t),s.data.growthFrameCounter=0,!1;const i=a.seasonData,r=i?i.season:"summer",o=de*({spring:.5,summer:1,autumn:2,winter:999}[r]||1);return s.data.growthFrameCounter++,!(s.data.growthFrameCounter<o)&&(s.data.growthFrameCounter=0,this.growTreeGradually(e,t,a,s))}hasNearbyTree(e,t,a,s){for(let n=-s;n<=s;n++)for(let i=-s;i<=s;i++){if(0===i&&0===n)continue;const s=a.getElement(e+i,t+n);if(s&&("tree_trunk"===s.name||"tree_branch"===s.name))return!0}return!1}generateFractalTree(e,t){const a=this.generateFractalTreeRecursive(e,t,-Math.PI/2,Q(),$,0,ee());return{segments:a,totalSegments:a.length,currentSegmentIndex:0,isComplete:!1}}generateFractalTreeRecursive(e,t,a,s,n,i,r){const o=[];if(i>=r||s<te)return o;const l=e+s*Math.cos(a),d=t+s*Math.sin(a);o.push({x1:e,y1:t,x2:l,y2:d,thickness:n,depth:i,angle:a,length:s,type:i<=1?"tree_trunk":"tree_branch"});const h=ae(),c=se+Math.random()*(ne-se);for(let m=0;m<2;m++){if(Math.random()<re)continue;let e=a+(0===m?-c:c);e+=(Math.random()-.5)*ie;const t=this.generateFractalTreeRecursive(l,d,e,s*h,1,i+1,r);o.push(...t)}return o}growTreeGradually(e,t,a,s){const n=s.data.treeStructure;if(!n.isComplete){for(let e=0;e<oe;e++){if(n.currentSegmentIndex>=n.segments.length){n.isComplete=!0;break}const e=n.segments[n.currentSegmentIndex];this.drawLineSegment(e.x1,e.y1,e.x2,e.y2,e.thickness,e.type,a),n.currentSegmentIndex++}return!0}return!(!n.isComplete||s.data.leavesSpawned)&&(this.spawnFractalLeaves(n,a),s.data.leavesSpawned=!0,!0)}drawLineSegment(e,t,a,s,n,i,r){const o=this.bresenhamLine(Math.round(e),Math.round(t),Math.round(a),Math.round(s)),l=r.registry.get(i);for(const{x:d,y:h}of o)if(1===n)r.isEmpty(d,h)&&r.setElement(d,h,l);else if(2===n)for(let e=0;e<2;e++)for(let t=0;t<2;t++)r.isEmpty(d+e,h+t)&&r.setElement(d+e,h+t,l);else{const e=Math.floor(n/2);for(let t=-e;t<=e;t++)for(let a=-e;a<=e;a++)Math.abs(t)+Math.abs(a)<=e&&r.isEmpty(d+t,h+a)&&r.setElement(d+t,h+a,l)}}bresenhamLine(e,t,a,s){const n=[],i=Math.abs(a-e),r=Math.abs(s-t),o=e<a?1:-1,l=t<s?1:-1;let d=i-r,h=e,c=t;for(;n.push({x:h,y:c}),h!==a||c!==s;){const e=2*d;e>-r&&(d-=r,h+=o),e<i&&(d+=i,c+=l)}return n}spawnFractalLeaves(e,t){const a=t.registry.get("leaf"),s=e.segments.filter(e=>e.depth>=he);for(const n of s){const e=Math.round(n.x2),s=Math.round(n.y2),i=2+Math.floor(Math.random()*ce),r=[[e,s],[e-1,s],[e+1,s],[e,s-1],[e,s+1],[e-1,s-1],[e+1,s-1],[e-1,s+1],[e+1,s+1]];r.sort(()=>Math.random()-.5);for(let n=0;n<Math.min(i,r.length);n++){const[e,s]=r[n];t.isEmpty(e,s)&&t.setElement(e,s,a)}}}}),ye.register(new class extends G{constructor(){super(11,"tree_trunk",7029795,{density:6,state:i,movable:!1,ignitionResistance:.75,burnsInto:"burning_wood",tags:[h,v]})}updateImpl(e,t,a){const s=a.seasonData,n=s?s.season:"summer",i=a.getCell(e,t);if(!i)return!1;i.data||(i.data={});const r=a.getElement(e,t-1);if(r&&"water"===r.name&&(i.data.wetness||(i.data.wetness=0),i.data.wetness<100&&Math.random()<.08&&(i.data.wetness=Math.min(100,i.data.wetness+10),a.setElement(e,t-1,a.registry.get("empty")))),i.data.wetness>0&&(i.data.wetness-=.1,i.data.wetness<0&&(i.data.wetness=0)),s&&("winter"===n||"autumn"===n)){const s="winter"===n?2e-5:1e-5;if(Math.random()<s)return a.setElement(e,t,a.registry.get("ash")),!0}let o="spring"===n?.001:1e-4;if(i.data.wetness>20&&(o*=3),Math.random()<o){const s=a.registry.get("leaf");if(!s)return!1;let n=!1;for(let i=-2;i<=2;i++){for(let s=-2;s<=2;s++){const r=a.getElement(e+s,t+i);if(r&&"leaf"===r.name){n=!0;break}}if(n)break}if(!n){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];n.sort(()=>Math.random()-.5);for(const[e,t]of n)if(a.isEmpty(e,t))return a.setElement(e,t,s),!0}}return!1}}),ye.register(new class extends G{constructor(){super(12,"tree_branch",9132604,{density:5,state:i,movable:!1,ignitionResistance:.7,burnsInto:"burning_wood",tags:[h,v]})}updateImpl(e,t,a){const s=a.seasonData,n=s?s.season:"summer",i=a.getCell(e,t);if(!i)return!1;i.data||(i.data={});const r=a.getElement(e,t-1);if(r&&"water"===r.name&&(i.data.wetness||(i.data.wetness=0),i.data.wetness<100&&Math.random()<.08&&(i.data.wetness=Math.min(100,i.data.wetness+10),a.setElement(e,t-1,a.registry.get("empty")))),i.data.wetness>0&&(i.data.wetness-=.1,i.data.wetness<0&&(i.data.wetness=0)),s&&("autumn"===n||"winter"===n)){const s="winter"===n?2e-5:1e-5;if(Math.random()<s){const s=a.registry.get("wood");if(s){a.setElement(e,t,s);const n=a.getCell(e,t);n&&(n.element.movable=!0)}return!0}}let o="spring"===n?.001:5e-4;if(i.data.wetness>20&&(o*=3),Math.random()<o){const s=a.registry.get("leaf");if(!s)return!1;let n=!1;for(let i=-2;i<=2;i++){for(let s=-2;s<=2;s++){const r=a.getElement(e+s,t+i);if(r&&"leaf"===r.name){n=!0;break}}if(n)break}if(!n){const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];n.sort(()=>Math.random()-.5);for(const[e,t]of n)if(a.isEmpty(e,t))return a.setElement(e,t,s),!0}}return!1}}),ye.register(new class extends G{constructor(){super(13,"leaf",3329330,{density:.5,state:i,movable:!0,ignitionResistance:.5,burnsInto:"fire",tags:[h,v]})}initializeCell(e){e.age=0}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;const n=a.seasonData,i=n?n.season:"summer";if(!s.data.leafColor&&n){const e={spring:[9498256,10025880,10145074],summer:[2263842,3050327,3978097],autumn:[16766720,16753920,16747520,16737095,16729344,14423100],winter:[9139029]},t=e[i]||e.summer;s.data.leafColor=t[Math.floor(Math.random()*t.length)]}const r=this.checkSupport(e,t,a);if(r&&n)if("autumn"===i){const e=.002;Math.random()<e&&(s.data.detached=!0)}else if("winter"===i){const e=.005;Math.random()<e&&(s.data.detached=!0)}if(!r||s.data.detached){const r=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[s,n]of r){const i=a.getElement(s,n);if(i&&"water"===i.name)return a.setElement(e,t,a.registry.get("water")),!0}s.data.age++;let o=1,l=!1;if(n){o={spring:5,summer:1,autumn:.5,winter:.2}[i]||1,"spring"===i&&n.seasonProgress>.4&&(l=!0,n.seasonProgress>.6&&(o*=3))}if(s.data.age>300){const e=Math.min((s.data.age-300)/600,1),t=s.data.leafColor||2263842,a=t>>16&255,n=t>>8&255,i=255&t,r=139,o=69,l=19,d=Math.floor(a+(r-a)*e),h=Math.floor(n+(o-n)*e),c=Math.floor(i+(l-i)*e);s.data.leafColor=d<<16|h<<8|c}if(l&&s.data.age>300){const s=.02*o;if(Math.random()<s)return a.setElement(e,t,a.registry.get("empty")),!0}const d=Math.floor(900/o);if(s.data.age>d){const s=.05*o;if(Math.random()<s){if(l)a.setElement(e,t,a.registry.get("empty"));else{const s=a.registry.get("ash");s?a.setElement(e,t,s):a.setElement(e,t,a.registry.get("empty"))}return!0}}if(Math.random()>.97){if(a.isEmpty(e,t+1))return a.swap(e,t,e,t+1),!0;const s=Math.random()>.5?1:-1;if(a.isEmpty(e+s,t+1))return a.swap(e,t,e+s,t+1),!0}}else s.data.age=0,s.data.detached=!1;if(r&&Math.random()>.999){const s=Math.random()>.5?1:-1;if(a.isEmpty(e+s,t))return a.swap(e,t,e+s,t),!0}if(r&&Math.random()>.9999){const s=a.registry.get("leaf");if(!s)return!1;const n=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];let i=0,r=[];for(const[e,t]of n){const s=a.getElement(e,t);s&&"leaf"===s.name?i++:a.isEmpty(e,t)&&r.push([e,t])}if(i<2&&r.length>0){const[e,t]=r[Math.floor(Math.random()*r.length)];return a.setElement(e,t,s),!0}}return!1}checkSupport(e,t,a){const s=new Set,n=[[e,t,0]];for(s.add("".concat(e,",").concat(t));n.length>0;){const[e,t,i]=n.shift();if(i>8)continue;const r=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[o,l]of r){const e="".concat(o,",").concat(l);if(s.has(e))continue;s.add(e);const t=a.getElement(o,l);if(!t)continue;const r=t.name;if("tree_trunk"===r||"tree_branch"===r||"wood"===r||"burning_wood"===r)return!0;"leaf"===r&&n.push([o,l,i+1])}}return!1}}),ye.register(new class extends G{constructor(){super(24,"vine",2263842,{density:2,state:i,movable:!1,ignitionResistance:.75,burnsInto:"burning_wood",tags:[h,v],brushSize:1,emissionDensity:.5})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.growthStage&&(s.data.growthStage=0,s.data.hasLanded=!1,s.data.swayTimer=Math.floor(60*Math.random()),s.data.age=0,s.data.branchLength=0,s.data.vineId=Math.random(),s.data.health=100),s.data.age++;if(!((a.frameCount+(11*e+7*t)%4)%4==0)&&s.data.age>10)return!1;if(this.isInWater(e,t,a)){if(Math.random()<.001&&(s.data.health-=1),s.data.health<=0)return a.setElement(e,t,a.registry.get("empty")),!0;Math.random()>.98&&s.data.growthStage++;const n=this.countNearbyVines(e,t,a);if(n>10)return Math.random()<.005&&(s.data.health-=5),!1;if(s.data.growthStage>=4&&n<8&&Math.random()>.997){const n=this.calculateBranchLength(e,t,a);if(n>=6+Math.floor(6*Math.random()))return!1;const i=[];i.push([e,t-1],[e,t-1],[e,t-1],[e,t-1]),i.push([e-1,t-1],[e+1,t-1]),i.sort(()=>Math.random()-.5);for(const[e,t]of i){const i=a.getElement(e,t);if(i&&"water"===i.name){if(this.hasNearbySupport(e,t,a)){a.setElement(e,t,a.registry.get("vine"));const i=a.getCell(e,t);return i&&(i.data.vineId=s.data.vineId,i.data.branchLength=n+1,i.data.health=80+Math.floor(20*Math.random())),!0}}}}return!1}if(!s.data.hasLanded){const n=a.getElement(e,t+1);if(n&&0!==n.id)s.data.hasLanded=!0;else if(a.canMoveTo(e,t,e,t+1))return a.swap(e,t,e,t+1),!0}const n=a.getElement(e,t+1);if(!(n&&(["sand","wet_sand","stone","wood","fossil","salt","wall","vine","obsidian"].includes(n.name)||n.state===i)))return Math.random()>.95&&(a.setElement(e,t,a.registry.get("empty")),!0);if(Math.random()<8e-4&&(s.data.health-=1),s.data.health<=0)return a.setElement(e,t,a.registry.get("empty")),!0;Math.random()>.98&&s.data.growthStage++;const r=this.countNearbyVines(e,t,a);if(r>12)return Math.random()<.003&&(s.data.health-=5),!1;if(s.data.growthStage>=5&&r<10&&Math.random()>.996){const n=this.calculateBranchLength(e,t,a);if(n>=5+Math.floor(5*Math.random()))return!1;a.getElement(e,t-1);const i=[];i.push([e,t-1],[e,t-1],[e,t-1]),i.push([e-1,t],[e+1,t]),Math.random()>.7&&i.push([e-1,t-1],[e+1,t-1]),i.sort(()=>Math.random()-.5);for(const[e,r]of i){const i=a.getElement(e,r);if(i&&0===i.id){if(this.hasNearbySupport(e,r,a)){a.setElement(e,r,a.registry.get("vine"));const i=a.getCell(e,r);return i&&(i.data.vineId=s.data.vineId,i.data.branchLength=n+1,i.data.health=80+Math.floor(20*Math.random()),r===t&&(i.data.hasLanded=!0)),!0}}}}return!1}countNearbyVines(e,t,a){let s=0;for(let n=-4;n<=4;n++)for(let i=-4;i<=4;i++){if(0===i&&0===n)continue;const r=a.getElement(e+i,t+n);r&&"vine"===r.name&&s++}return s}calculateBranchLength(e,t,a){const s=new Set,n=[[e,t,0]];for(;n.length>0&&s.size<40;){const[e,t,r]=n.shift(),o="".concat(e,",").concat(t);if(s.has(o))continue;s.add(o);const l=a.getElement(e,t);if(l&&"vine"!==l.name&&l.state===i)return r;if(l&&"vine"!==l.name&&"water"===l.name){const s=a.getElement(e,t+1);if(s&&s.state===i)return r}l&&"vine"===l.name&&r<12&&(n.push([e-1,t,r+1]),n.push([e+1,t,r+1]),n.push([e,t-1,r+1]),n.push([e,t+1,r+1]))}return 0}hasNearbySupport(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]];for(const[n,r]of s){const e=a.getElement(n,r);if(e&&(e.state===i||"vine"===e.name))return!0}return!1}isInWater(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of s){const e=a.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}}),ye.register(new class extends G{constructor(){super(31,"grass_seed",10145074,{density:1.5,state:i,movable:!0,tags:[v],brushSize:0,emissionDensity:1}),this.movement=new F({fallSpeed:1,slideAngle:!0,slideStability:.7})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.germTimer&&(s.data.germTimer=0);const n=a.getElement(e,t+1);if(!(n&&["sand","wet_sand","stone","wood","fossil","salt"].includes(n.name)))return this.movement.apply(e,t,a);if(s.data.germTimer++,s.data.germTimer>=30){let s=!1;for(let i=-2;i<=2;i++){for(let n=-2;n<=2;n++){const r=a.getElement(e+n,t+i);if(r&&"water"===r.name){s=!0;break}}if(s)break}const n=s?.05:.01;if(Math.random()<n)return a.setElement(e,t,a.registry.get("plant")),!0}return!1}}),ye.register(new class extends G{constructor(){super(17,"fish",16747586,{density:2.5,state:i,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[v,h],brushSize:0,emissionDensity:.2}),this.colorVariants=[16747586,16766720,16729156,2763306]}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(!s.data.swimDirection){s.data.swimDirection=Math.random()>.5?1:-1,s.data.swimTimer=0,s.data.outOfWaterTime=0,s.data.hunger=0,s.data.seekingFood=!1,s.data.restTimer=0,s.data.age=0,s.data.surfaceTimer=0,s.data.feedingStartTime=null,s.data.feedingCooldown=0,s.data.cachedSurfaceY=null,s.data.cachedFoodLocation=null,s.data.cachedNearbyFishCount=0,s.data.cacheFrame=0;const e=this.colorVariants[Math.floor(Math.random()*this.colorVariants.length)];s.data.fishColor=e}s.data.age++;const n=(a.frameCount+(e+t)%5)%5==0;if(!this.isInWater(e,t,a)){if(s.data.outOfWaterTime++,s.data.outOfWaterTime>300)return a.setElement(e,t,a.registry.get("ash")),!0;const n=a.getElement(e,t+1);if(n&&"empty"===n.name)return a.swap(e,t,e,t+1),!0;if(Math.random()>.95){const s=e+(Math.random()>.5?1:-1);if(a.isEmpty(s,t))return a.swap(e,t,s,t),!0}return!1}s.data.outOfWaterTime=0;let i=s.data.cachedNearbyFishCount;n&&(i=this.countNearbyFish(e,t,a,3),s.data.cachedNearbyFishCount=i);const r=i>4;if(s.data.feedingCooldown>0&&s.data.feedingCooldown--,null!==s.data.feedingStartTime){s.data.age-s.data.feedingStartTime>=420&&(s.data.feedingCooldown=1250,s.data.feedingStartTime=null,s.data.seekingFood=!1)}s.data.hunger=Math.min(100,s.data.hunger+.015);const o=s.data.hunger>=70;this.isNearCoral(e,t,a)&&s.data.hunger>0&&(s.data.hunger=Math.max(0,s.data.hunger-.007));let l=s.data.cachedSurfaceY;n&&(l=this.findSurfaceLevel(e,t,a),s.data.cachedSurfaceY=l);if(null!==l&&t<=l+10&&s.data.hunger<30?s.data.surfaceTimer++:s.data.surfaceTimer=0,s.data.surfaceTimer>900&&Math.random()>.3){const s=a.getElement(e,t+1);if(s&&"water"===s.name)return a.swap(e,t,e,t+1),!0}if(s.data.hunger>20&&0===s.data.feedingCooldown){let d=s.data.cachedFoodLocation;if(n&&(d=this.findNearbyFood(e,t,a),!d&&s.data.hunger>40&&(d=this.findNearbyCoral(e,t,a)),s.data.cachedFoodLocation=d),d){const[n,l]=d;if(null===s.data.feedingStartTime&&(s.data.feedingStartTime=s.data.age),Math.abs(n-e)<=1&&Math.abs(l-t)<=1){const d=a.getElement(n,l);if(d&&"coral"===d.name)return s.data.seekingFood=!1,s.data.cachedFoodLocation=null,s.data.feedingStartTime=null,!1;if(d&&("leaf"===d.name||"ash"===d.name||"tree_seed"===d.name)){a.setElement(n,l,a.registry.get("empty")),s.data.hunger=Math.max(0,s.data.hunger-70),s.data.seekingFood=!1,s.data.cachedFoodLocation=null;return s.data.hunger<20&&!r&&!o&&i<3&&Math.random()<.05&&this.layEgg(e,t,a),!0}}else if(s.data.seekingFood=!0,this.swimToward(e,t,n,l,a))return!0}else if(s.data.feedingStartTime=null,s.data.seekingFood=!1,s.data.hunger>60&&null!==l&&l<t-2&&Math.random()>.2){const s=a.getElement(e,t-1);if(s&&"water"===s.name)return a.swap(e,t,e,t-1),!0}}else s.data.seekingFood=!1;if(!s.data.seekingFood){const n=this.analyzeSchool(e,t,a);if(n.nearbyFish>0){const i=this.calculateSchoolDirection(e,t,n);if(Math.random()>.9&&i){const[n,r]=i,o=a.getElement(n,r);if(o&&"water"===o.name)return a.swap(e,t,n,r),s.data.swimDirection=Math.sign(n-e)||s.data.swimDirection,!0}}}if(s.data.swimTimer++,s.data.feedingCooldown>0||s.data.hunger<30){if(void 0===s.data.targetDepth||Math.random()>.99)if(null!==l){const e=a.height-l,t=Math.max(e-5,0);s.data.targetDepth=l+Math.floor(Math.random()*t)}else s.data.targetDepth=t;if(void 0!==s.data.targetDepth){const n=s.data.targetDepth-t;if(Math.abs(n)>2&&Math.random()>.6){const s=n>0?1:-1,i=a.getElement(e,t+s);if(i&&"water"===i.name)return a.swap(e,t,e,t+s),!0}}}if(s.data.restTimer>0){if(s.data.restTimer--,Math.random()>.85){const s=Math.random()>.5?1:-1,n=a.getElement(e+s,t);n&&"water"===n.name&&a.swap(e,t,e+s,t)}return!1}if(Math.random()>.985)return s.data.restTimer=30+Math.floor(60*Math.random()),!1;if(s.data.swimTimer>60&&Math.random()>.97&&(s.data.swimDirection*=-1,s.data.swimTimer=0),Math.random()>.7){const n=s.data.swimDirection;if(Math.random()>.3){const s=e+n,i=a.getElement(s,t);if(i&&"water"===i.name)return a.swap(e,t,s,t),!0;const r=Math.random()>.5?1:-1,o=a.getElement(s,t+r);if(o&&"water"===o.name)return a.swap(e,t,s,t+r),!0}if(Math.random()>.5){let s=0;for(let o=t+1;o<a.height;o++){const n=a.getElement(e,o);if(!n||"water"!==n.name){s=o-t-1;break}if(o-t>10){s=10;break}}let n=.5;s<=3?n=.85:s<=6&&(n=.7);const i=t+(Math.random()<n?-1:1),r=a.getElement(e,i);if(r&&"water"===r.name)return a.swap(e,t,e,i),!0}}return!1}countNearbyFish(e,t,a,s){let n=0;for(let i=-s;i<=s;i++)for(let r=-s;r<=s;r++){if(0===r&&0===i)continue;const s=a.getElement(e+r,t+i);s&&"fish"===s.name&&n++}return n}findSurfaceLevel(e,t,a){for(let s=t;s>=0;s--){const t=a.getElement(e,s);if(!t||"water"!==t.name)return s+1}return null}analyzeSchool(e,t,a){let s=0,n=0,i=0,r=0;for(let o=-3;o<=3;o++)for(let l=-3;l<=3;l++){if(0===l&&0===o)continue;const d=a.getElement(e+l,t+o);if(d&&"fish"===d.name){s++,n+=e+l,i+=t+o;const d=a.getCell(e+l,t+o);d&&d.data.swimDirection&&(r+=d.data.swimDirection)}}return s>0&&(n=Math.floor(n/s),i=Math.floor(i/s),r/=s),{nearbyFish:s,centerX:n,centerY:i,avgDirection:r}}calculateSchoolDirection(e,t,a){let s=e,n=t;const i=a.centerX-e,r=a.centerY-t,o=Math.sqrt(i*i+r*r);return o<3?(s=e-Math.sign(i),n=t-Math.sign(r)):o>5?(s=e+Math.sign(i),n=t+Math.sign(r)):(s=e+Math.sign(a.avgDirection||i),n=t),s=Math.max(e-1,Math.min(e+1,s)),n=Math.max(t-1,Math.min(t+1,n)),[s,n]}isInWater(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of s){const e=a.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}findNearbyFood(e,t,a){for(let s=-7;s<=7;s++)for(let n=-7;n<=7;n++){const i=a.getElement(e+n,t+s);if(i&&("leaf"===i.name||"ash"===i.name||"tree_seed"===i.name))return[e+n,t+s]}return null}swimToward(e,t,a,s,n){const i=a-e,r=s-t;if(Math.abs(r)>0&&Math.random()>.1){const a=r>0?1:-1,s=n.getElement(e,t+a);if(s&&"water"===s.name)return n.swap(e,t,e,t+a),!0}if(Math.abs(i)>0&&Math.random()>.1){const a=i>0?1:-1,s=n.getElement(e+a,t);if(s&&"water"===s.name)return n.swap(e,t,e+a,t),!0}if(Math.abs(i)>0&&Math.abs(r)>0){const a=i>0?1:-1,s=r>0?1:-1,o=n.getElement(e+a,t+s);if(o&&"water"===o.name)return n.swap(e,t,e+a,t+s),!0}return!1}layEgg(e,t,a){const s=[[0,1],[0,2],[-1,1],[1,1],[0,-1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1]];s.sort(()=>Math.random()-.5);for(const[n,i]of s){const s=e+n,r=t+i,o=a.getElement(s,r);if(o&&"water"===o.name)return a.setElement(s,r,a.registry.get("fish_egg")),!0}return!1}reproduce(e,t,a){const s=[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1],[0,-2],[0,2],[-2,0],[2,0]];s.sort(()=>Math.random()-.5);for(const[n,i]of s){const s=e+n,r=t+i,o=a.getElement(s,r);if(o&&"water"===o.name)return a.setElement(s,r,a.registry.get("fish")),!0}return!1}isNearCoral(e,t,a){for(let s=-3;s<=3;s++)for(let n=-3;n<=3;n++){const i=a.getElement(e+n,t+s);if(i&&"coral"===i.name)return!0}return!1}findNearbyCoral(e,t,a){for(let s=-8;s<=8;s++)for(let n=-8;n<=8;n++){const i=a.getElement(e+n,t+s);if(i&&"coral"===i.name)return[e+n,t+s]}return null}}),ye.register(new class extends G{constructor(){super(30,"fish_egg",9662683,{density:3,state:i,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[v,h],brushSize:0,emissionDensity:0})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.incubationTime&&(s.data.incubationTime=0,s.data.outOfWaterTime=0);if(!this.isInWater(e,t,a)){if(s.data.outOfWaterTime++,s.data.outOfWaterTime>180)return a.setElement(e,t,a.registry.get("ash")),!0;const n=a.getElement(e,t+1);return!(!n||"empty"!==n.name)&&(a.swap(e,t,e,t+1),!0)}if(s.data.outOfWaterTime=0,s.data.incubationTime++,s.data.incubationTime>600){return this.countNearbyFish(e,t,a,8)>6?(a.setElement(e,t,a.registry.get("ash")),!0):(a.setElement(e,t,a.registry.get("fish")),!0)}if(Math.random()>.8){const s=a.getElement(e,t+1);if(s&&"water"===s.name)return a.swap(e,t,e,t+1),!0}return!1}isInWater(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of s){const e=a.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}countNearbyFish(e,t,a,s){let n=0;for(let i=-s;i<=s;i++)for(let r=-s;r<=s;r++){if(0===r&&0===i)continue;const s=a.getElement(e+r,t+i);s&&"fish"===s.name&&n++}return n}}),ye.register(new class extends G{constructor(){super(42,"bird",16777215,{density:1.5,state:i,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[v,h],brushSize:0,emissionDensity:.2}),this.colorVariants=[16777215,16119285,15790320,15263976]}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;const n=a.dayNightCycle?a.dayNightCycle.getTime():.5,i=n>=.85||n<.2,r=n>=.2&&n<.3;if(!s.data.flyDirection){s.data.flyDirection=Math.random()>.5?1:-1,s.data.flyTimer=0,s.data.hunger=0,s.data.age=0,s.data.feedingCooldown=0,s.data.perchTimer=0,s.data.isPerching=!1,s.data.isSleeping=!1,s.data.altitude=t,s.data.glidePhase=0,s.data.cachedTreeLocation=null,s.data.cachedNearbyBirdCount=0,s.data.cacheFrame=0;const e=this.colorVariants[Math.floor(Math.random()*this.colorVariants.length)];s.data.birdColor=e}s.data.age++;const o=(a.frameCount+(e+t)%5)%5==0;s.data.feedingCooldown>0&&s.data.feedingCooldown--,s.data.hunger=Math.min(100,s.data.hunger+.015);let l=s.data.cachedNearbyBirdCount;o&&(l=this.countNearbyBirds(e,t,a,3),s.data.cachedNearbyBirdCount=l);const d=l>4,h=s.data.hunger>=70,c=a.seasonData,m=c?c.season:"summer",u=c?c.seasonProgress:0;if(c&&("autumn"===m&&u>.5&&(s.data.migrating=!0),s.data.migrating)){const s=a.getElement(e,t-1);if(s&&"empty"===s.name)return a.swap(e,t,e,t-1),!0;if(t<10)return a.setElement(e,t,a.registry.get("empty")),!0;const n=Math.random()>.5?1:-1;return!!a.isEmpty(e+n,t-1)&&(a.swap(e,t,e+n,t-1),!0)}if(i&&!s.data.isSleeping){if(this.canPerchAt(e,t,a))return s.data.isSleeping=!0,s.data.isPerching=!0,!1;{const s=this.findNearbyPerchSpot(e,t,a);if(s){const[n,i]=s;if(this.flyToward(e,t,n,i,a))return!0}else{const s=a.getElement(e,t+1);if(s&&"empty"===s.name)return a.swap(e,t,e,t+1),!0}}}if(r&&s.data.isSleeping&&(s.data.isSleeping=!1,s.data.isPerching=!1,s.data.perchTimer=0),s.data.isSleeping)return!1;if(s.data.isPerching){s.data.perchTimer++;const n=120+Math.floor(120*Math.random());if(!(s.data.perchTimer>n)){if(Math.random()>.98){const s=e+(Math.random()>.5?1:-1);if(this.canPerchAt(s,t,a))return a.swap(e,t,s,t),!0}return!1}s.data.isPerching=!1,s.data.perchTimer=0}const g=this.isEnclosed(e,t,a);if(g){const s=t+-1,n=a.getElement(e,s);if(n&&"empty"===n.name)return a.swap(e,t,e,s),!0;const i=Math.random()>.5?1:-1,r=a.getElement(e+i,s);if(r&&"empty"===r.name)return a.swap(e,t,e+i,s),!0}if(s.data.hunger>50&&0===s.data.feedingCooldown){if(this.checkAdjacentSolid(e,t,a)){s.data.hunger=Math.max(0,s.data.hunger-50),s.data.feedingCooldown=600;return s.data.hunger<20&&!d&&!h&&l<3&&Math.random()<.05&&this.layEgg(e,t,a),!1}}if(!g&&!s.data.isPerching&&Math.random()>.995&&o){let n=s.data.cachedTreeLocation;if(o&&(n=this.findNearbyTree(e,t,a),s.data.cachedTreeLocation=n),n){const[i,r]=n;if(Math.abs(i-e)<=1&&r===t-1)return s.data.isPerching=!0,s.data.perchTimer=0,s.data.cachedTreeLocation=null,!1;if(this.flyToward(e,t,i,r-1,a))return!0}}s.data.flyTimer++,s.data.glidePhase+=.05;const f=e<15,p=e>a.width-15,y=t<15,w=t>a.height-15;if(f&&-1===s.data.flyDirection?s.data.flyDirection=1:p&&1===s.data.flyDirection&&(s.data.flyDirection=-1),y?s.data.altitude=Math.max(s.data.altitude,Math.floor(.5*a.height)):w&&(s.data.altitude=Math.min(s.data.altitude,Math.floor(.6*a.height))),o&&Math.random()>.98){const e=Math.floor(.4*a.height),t=Math.floor(.7*a.height);s.data.altitude=e+Math.floor(Math.random()*(t-e))}if(s.data.flyTimer>60&&Math.random()>.97&&(s.data.flyDirection*=-1,s.data.flyTimer=0),Math.random()>.3){const n=.5*Math.sin(s.data.glidePhase),i=s.data.altitude-t;let r=.25;if(i<-5?r=.1:i>5&&(r=.7),n>.2&&(r-=.1),n<-.2&&(r+=.1),Math.random()>.5){const s=t+(Math.random()<r?1:-1),n=a.getElement(e,s);if(n&&"empty"===n.name&&!this.isDangerousNearby(e,s,a))return a.swap(e,t,e,s),!0}if(Math.random()>.2){const n=e+s.data.flyDirection,i=a.getElement(n,t);if(i&&"empty"===i.name&&!this.isDangerousNearby(n,t,a))return a.swap(e,t,n,t),!0;const r=Math.random()>.5?1:-1,o=a.getElement(n,t+r);if(o&&"empty"===o.name&&!this.isDangerousNearby(n,t+r,a))return a.swap(e,t,n,t+r),!0}}return!1}countNearbyBirds(e,t,a,s){let n=0;for(let i=-s;i<=s;i++)for(let r=-s;r<=s;r++){if(0===r&&0===i)continue;const s=a.getElement(e+r,t+i);s&&"bird"===s.name&&n++}return n}findNearbyTree(e,t,a){for(let s=-7;s<=7;s++)for(let n=-7;n<=7;n++){const i=a.getElement(e+n,t+s);if(i&&("tree_trunk"===i.name||"tree_branch"===i.name)){const i=a.getElement(e+n,t+s-1);if(i&&"empty"===i.name)return[e+n,t+s]}}return null}isDangerousNearby(e,t,a){for(let s=-1;s<=1;s++)for(let n=-1;n<=1;n++){const i=a.getElement(e+n,t+s);if(i&&("lava"===i.name||"fire"===i.name))return!0}return!1}flyToward(e,t,a,s,n){const i=a-e,r=s-t;if(Math.abs(r)>0&&Math.random()>.1){const a=r>0?1:-1,s=n.getElement(e,t+a);if(s&&"empty"===s.name&&!this.isDangerousNearby(e,t+a,n))return n.swap(e,t,e,t+a),!0}if(Math.abs(i)>0&&Math.random()>.1){const a=i>0?1:-1,s=n.getElement(e+a,t);if(s&&"empty"===s.name&&!this.isDangerousNearby(e+a,t,n))return n.swap(e,t,e+a,t),!0}if(Math.abs(i)>0&&Math.abs(r)>0){const a=i>0?1:-1,s=r>0?1:-1,o=n.getElement(e+a,t+s);if(o&&"empty"===o.name&&!this.isDangerousNearby(e+a,t+s,n))return n.swap(e,t,e+a,t+s),!0}return!1}layEgg(e,t,a){const s=[[0,1],[0,2],[-1,1],[1,1],[-1,0],[1,0],[-1,-1],[1,-1]];s.sort(()=>Math.random()-.5);for(const[n,i]of s){const s=e+n,r=t+i,o=a.getElement(s,r);if(o&&"empty"===o.name)return a.setElement(s,r,a.registry.get("bird_egg")),!0}return!1}canPerchAt(e,t,a){const s=a.getElement(e,t+1);if(!s)return!1;return["tree_trunk","tree_branch","wood","stone","wall","sand","wet_sand"].includes(s.name)}isEnclosed(e,t,a){let s=0;for(let n=-2;n<=2;n++)for(let i=-2;i<=2;i++){if(0===i&&0===n)continue;const r=a.getElement(e+i,t+n);r&&"empty"!==r.name&&"lava"!==r.name&&"fire"!==r.name&&"bird"!==r.name&&"fish"!==r.name&&s++}return s>16}checkAdjacentSolid(e,t,a){const s=[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];for(const[n,i]of s){const s=a.getElement(e+n,t+i);if(s&&"empty"!==s.name&&"lava"!==s.name&&"fire"!==s.name&&"water"!==s.name&&"acid"!==s.name&&"bird"!==s.name&&"fish"!==s.name)return!0}return!1}findNearbyPerchSpot(e,t,a){for(let s=10;s>=-10;s--)for(let n=-10;n<=10;n++){const i=t+s,r=e+n,o=a.getElement(r,i);if(o&&"empty"===o.name){const e=a.getElement(r,i+1);if(e&&"empty"!==e.name&&"lava"!==e.name&&"fire"!==e.name&&"water"!==e.name&&"acid"!==e.name)return[r,i]}}return null}}),ye.register(new class extends G{constructor(){super(43,"bird_egg",15787660,{density:3,state:i,movable:!0,ignitionResistance:0,burnsInto:"ash",tags:[v,h],brushSize:0,emissionDensity:0})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.incubationTime&&(s.data.incubationTime=0,s.data.onGround=!1);if(!this.isOnSolidSurface(e,t,a)){const s=a.getElement(e,t+1);return!(!s||"empty"!==s.name)&&(a.swap(e,t,e,t+1),!0)}if(s.data.onGround=!0,s.data.incubationTime++,s.data.incubationTime>600){return this.countNearbyBirds(e,t,a,8)>6?(a.setElement(e,t,a.registry.get("ash")),!0):(a.setElement(e,t,a.registry.get("bird")),!0)}return!1}isOnSolidSurface(e,t,a){const s=a.getElement(e,t+1);if(!s)return!1;return["tree_trunk","tree_branch","wood","stone","wall","sand","wet_sand","ash","fossil","coal","obsidian","glass","ice","leaf"].includes(s.name)}countNearbyBirds(e,t,a,s){let n=0;for(let i=-s;i<=s;i++)for(let r=-s;r<=s;r++){if(0===r&&0===i)continue;const s=a.getElement(e+r,t+i);s&&"bird"===s.name&&n++}return n}}),ye.register(new class extends G{constructor(){super(34,"coral",16739229,{density:8,state:i,movable:!1,ignitionResistance:.9,burnsInto:"ash",tags:[v,h],brushSize:1,emissionDensity:.5})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.growthStage&&(s.data.growthStage=0,s.data.outOfWaterTime=0,s.data.age=0,s.data.branchLength=0,s.data.coralId=Math.random(),s.data.health=100),s.data.age++;if(!((a.frameCount+(7*e+13*t)%5)%5==0)&&s.data.age>10)return!1;if(this.isInWater(e,t,a)){if(s.data.outOfWaterTime=0,Math.random()<.001&&(s.data.health-=1),s.data.health<=0)return a.setElement(e,t,a.registry.get("stone")),!0;Math.random()>.97&&s.data.growthStage++;const n=this.countNearbyCoral(e,t,a);if(n>12)return Math.random()<.005&&(s.data.health-=5),!1;if(s.data.growthStage>=5&&n<10&&Math.random()>.995){const n=this.calculateBranchLength(e,t,a);if(n>=5+Math.floor(5*Math.random()))return!1;const i=[];i.push([e-1,t],[e+1,t],[e-1,t],[e+1,t]),i.push([e,t+1],[e-1,t+1],[e+1,t+1]),Math.random()>.8&&i.push([e,t-1]),i.sort(()=>Math.random()-.5);for(const[e,t]of i){const i=a.getElement(e,t);if(i&&"water"===i.name){if(this.hasNearbySupport(e,t,a)){const i=a.registry.get("coral");a.setElement(e,t,i);const r=a.getCell(e,t);return r&&(r.data.coralId=s.data.coralId,r.data.branchLength=n+1,r.data.health=80+Math.floor(20*Math.random())),!0}}}}}else if(s.data.outOfWaterTime++,s.data.outOfWaterTime>300)return a.setElement(e,t,a.registry.get("stone")),!0;return!1}countNearbyCoral(e,t,a){let s=0;for(let n=-5;n<=5;n++)for(let i=-5;i<=5;i++){if(0===i&&0===n)continue;const r=a.getElement(e+i,t+n);r&&"coral"===r.name&&s++}return s}calculateBranchLength(e,t,a){const s=new Set,n=[[e,t,0]];for(;n.length>0&&s.size<50;){const[e,t,r]=n.shift(),o="".concat(e,",").concat(t);if(s.has(o))continue;s.add(o);const l=a.getElement(e,t);if(l&&"coral"!==l.name&&l.state===i)return r;l&&"coral"===l.name&&r<15&&(n.push([e-1,t,r+1]),n.push([e+1,t,r+1]),n.push([e,t-1,r+1]),n.push([e,t+1,r+1]))}return 0}hasNearbySupport(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]];for(const[n,r]of s){const e=a.getElement(n,r);if(e&&(e.state===i||"coral"===e.name))return!0}return!1}isInWater(e,t,a){const s=[[e,t-1],[e,t+1],[e-1,t],[e+1,t]];for(const[n,i]of s){const e=a.getElement(n,i);if(e&&"water"===e.name)return!0}return!1}}),ye.register(new class extends G{constructor(){super(41,"house_seed",16766720,{density:5,state:i,tags:[h],ignitionResistance:.5,burnsInto:"ash",brushSize:1,emissionDensity:.1})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(s.data._houseConstruction){if(s.data._constructionActive)return!1;if(s.data.buildCooldown||(s.data.buildCooldown=600),s.data.buildCooldown>0)return s.data.buildCooldown--,!1;delete s.data._houseConstruction,delete s.data.buildCooldown,s.data.initiated=!1,s.data.settled=!1,s.data.wanderAttempts=0}s.data.initiated||(s.data.initiated=!0,s.data.settled=!1,s.data.wanderAttempts=0,s.data.maxWanderAttempts=100,s.data.wanderDirection=Math.random()>.5?1:-1);const n=a.getElement(e,t+1);if(n&&(0===n.id||"liquid"===n.state))return a.swap(e,t,e,t+1),s.data.settled=!1,!0;if(n&&0!==n.id&&"liquid"!==n.state){const n=Math.random()>.5?1:-1,i=a.getElement(e+n,t+1),r=a.getElement(e+n,t);if(i&&r&&(0===i.id||"liquid"===i.state)&&(0===r.id||"liquid"===r.state))return a.swap(e,t,e+n,t+1),s.data.settled=!1,!0}if(!s.data.settled&&n&&(n.state===i||n.state===r))return s.data.settled=!0,s.data.buildDelay=5,!1;if(s.data.settled&&void 0!==s.data.buildDelay){if(s.data.buildDelay>0)return s.data.buildDelay--,!1;if(this.isGoodBuildingSpot(e,t,a))return this.handleBuilding(s,e,t,a);{if(s.data.wanderAttempts++,s.data.wanderAttempts>=s.data.maxWanderAttempts)return a.setElement(e,t,a.registry.get("ash")),!0;s.data.settled=!1,s.data.buildDelay=void 0;const n=s.data.wanderDirection,i=a.getElement(e+n,t),o=a.getElement(e+n,t+1),l=a.getElement(e+n,t-1);if(i&&0===i.id&&o&&0!==o.id)return a.swap(e,t,e+n,t),!0;if(i&&0!==i.id&&l&&0===l.id){const s=a.getElement(e+n,t-1);if(s&&0===s.id)return a.swap(e,t,e+n,t-1),!0}return i&&i.state===r?(a.setElement(e+n,t,a.registry.get("empty")),a.swap(e,t,e+n,t),!0):!i||"ash"!==i.name&&"leaf"!==i.name?(s.data.wanderDirection*=-1,!1):(a.setElement(e+n,t,a.registry.get("empty")),a.swap(e,t,e+n,t),!0)}}return!1}isGoodBuildingSpot(e,t,a){let s=0;for(let i=-1;i<=3;i++){const s=a.getElement(e,t+i);if(s&&"water"===s.name)return!1}for(let i=-1;i<10;i++)for(let n=-2;n<=2;n++){if(0===n&&i>=-1&&i<=3)continue;const r=a.getElement(e+n,t+i);r&&"water"===r.name&&s++}if(s>2)return!1;const n=["tree_trunk","tree_branch","leaf"];for(let i=-1;i<10;i++)for(let s=-2;s<=2;s++){const r=a.getElement(e+s,t+i);if(r&&n.includes(r.name))return!1}let o=0;for(let d=-2;d<=2;d++){const s=a.getElement(e+d,t+1);!s||s.state!==i&&s.state!==r||o++}if(o<3)return!1;let l=!0;for(let r=1;r<=5;r++){const s=a.getElement(e,t-r);if(s&&0!==s.id&&s.state===i){l=!1;break}}return!!l}handleBuilding(e,t,a,s){const n=a+1;if(!s.isInBounds(t,n))return!1;if(!s.getElement(t,n))return!1;const i=s.registry.get("stone");if(!i)return!1;s.setElement(t,n,i);const r=s.getCell(t,n);if(!r)return!1;r.data._houseConstruction={centerX:t,baseY:n,buildPhase:"ground_fill",buildStep:0,buildTimer:0,builderX:null,builderY:null},s.registerConstruction(t,n);const o=t+3*(Math.random()>.5?1:-1),l=s.getElement(o,a);let d=t,h=a;l&&0===l.id&&(s.swap(t,a,o,a),d=o),r.data._houseConstruction.builderX=d,r.data._houseConstruction.builderY=h;const c=s.getCell(d,h);return c&&(c.data._houseConstruction=!0,c.data._constructionActive=!0),!0}}),ye.register(new class extends G{constructor(){super(9,"burning_wood",16729344,{density:5,state:i,movable:!1,lifetime:1500,ignitionResistance:.95,burnsInto:"fire",tags:[c,h]}),this.addBehavior(new U({lifetime:1500,spreadChance:.12,spreadIntensity:1,burnsInto:"ash"})),this.addBehavior(new j({emitElement:"fire",emissionRate:.15,directions:[[0,-1]],stages:[{until:.33,rate:.15},{until:.66,rate:.2},{until:1,rate:.07}]})),this.addBehavior(new j({emitElement:"smoke",emissionRate:.01,directions:[[-1,-1],[1,-1]],stages:[{until:.33,rate:.01},{until:.66,rate:.02},{until:1,rate:.03}]}))}updateImpl(e,t,a){return this.applyBehaviors(e,t,a)}}),ye.register(new class extends G{constructor(){super(30,"burning_coal",16729344,{density:5,state:i,movable:!1,tags:[c,m],brushSize:0,emissionDensity:0}),this.addBehavior(new U({lifetime:1800,spreadChance:.1,burnsInto:"ash"})),this.addBehavior(new j({emitElement:"fire",emissionRate:.25,stages:[{until:.2,rate:.3},{until:.8,rate:.25},{until:1,rate:.1}],directions:[[0,-1],[-1,-1],[1,-1]]})),this.addBehavior(new j({emitElement:"smoke",emissionRate:.08,directions:[[0,-1]]})),this.addBehavior(new J({extinguishesTo:"coal",waterToSteamChance:.5,extinguishChance:1,waterSources:["water"]}))}updateImpl(e,t,a){return this.applyBehaviors(e,t,a)}}),ye.register(new class extends G{constructor(){super(13,"cloud",15790320,{density:0,state:l,dispersion:1,lifetime:2400,tags:[],brushSize:3,emissionDensity:.5}),this.atmosphereThreshold=.4}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;void 0===s.data.saturation&&(s.data.saturation=1),void 0===s.data.waterCapacity&&(s.data.waterCapacity=s.data.saturation),void 0===s.data.canRain&&(s.data.canRain=Math.random()<.4),void 0===s.data.rainCooldown&&(s.data.rainCooldown=0),void 0===s.data.cloudAge&&(s.data.cloudAge=0),s.data.cloudAge++;const n=t<Math.floor(a.height*this.atmosphereThreshold);if(Math.random()>.85&&s.data.saturation<20){const n=this.findNearbySteam(e,t,a);n&&(a.setElement(n[0],n[1],a.registry.get("empty")),s.data.saturation=Math.min(s.data.saturation+1,20),s.data.waterCapacity=Math.min(s.data.waterCapacity+1,20),this.updateCloudColor(s))}if(Math.random()>.9){const n=this.findAdjacentCloud(e,t,a);if(n){const[e,t]=n,i=a.getCell(e,t);if(i&&void 0!==i.data.saturation){s.data.saturation+i.data.saturation<=15&&(s.data.saturation+=i.data.saturation,s.data.waterCapacity+=i.data.waterCapacity||i.data.saturation,a.setElement(e,t,a.registry.get("empty")),this.updateCloudColor(s))}}}if(void 0===s.data.lightningCooldown&&(s.data.lightningCooldown=0),s.data.lightningCooldown>0)s.data.lightningCooldown--;else if(s.data.saturation>=12&&Math.random()<8e-4){const n=a.getElement(e,t+1);n&&"empty"===n.name&&(a.setElement(e,t+1,a.registry.get("electricity")),s.data.lightningCooldown=180+Math.floor(120*Math.random()))}const i=480+Math.floor(240*Math.random()),r=s.data.cloudAge>=i;if(s.data.rainCooldown>0)s.data.rainCooldown--;else if(r&&s.data.canRain)if(s.data.waterCapacity>0){const n=s.data.isSnowCloud?10:12;if(s.data.saturation>=n){const n=this.triggerRainEvent(e,t,a,s);if(s.data.saturation-=n,s.data.waterCapacity-=n,s.data.rainCooldown=60+Math.floor(60*Math.random()),this.updateCloudColor(s),s.data.saturation<=0)return a.setElement(e,t,a.registry.get("empty")),!0}else if(s.data.saturation>=8){const n=s.data.isSnowCloud?.02:.005;if(Math.random()<n){this.dropSingleRain(e,t,a)&&(s.data.saturation-=1,s.data.waterCapacity-=1),s.data.rainCooldown=30,this.updateCloudColor(s)}}}else if(s.data.waterCapacity<=0&&Math.random()<.01)return a.setElement(e,t,a.registry.get("empty")),!0;if(n){const s=a.seasonData;let n=.4,i=Math.random()>.5?1:-1;if(s&&s.windVector&&(n+=.1*s.windStrength,i=s.windDirection>0?1:-1),Math.random()<n){if(a.isEmpty(e+i,t))return a.swap(e,t,e+i,t),!0;if(a.isEmpty(e-i,t))return a.swap(e,t,e-i,t),!0}return!!(Math.random()>.92&&a.isEmpty(e,t-1))&&(a.swap(e,t,e,t-1),!0)}{if(a.isEmpty(e,t-1))return a.swap(e,t,e,t-1),!0;const s=Math.random()>.5?1:-1;return a.isEmpty(e+s,t-1)?(a.swap(e,t,e+s,t-1),!0):!!a.isEmpty(e-s,t-1)&&(a.swap(e,t,e-s,t-1),!0)}}findNearbySteam(e,t,a){for(let s=-3;s<=3;s++)for(let n=-3;n<=3;n++){if(0===n&&0===s)continue;const i=a.getElement(e+n,t+s);if(i&&"steam"===i.name)return[e+n,t+s]}return null}findAdjacentCloud(e,t,a){const s=[[e-1,t],[e+1,t],[e,t-1],[e,t+1]];for(const[n,i]of s){const e=a.getElement(n,i);if(e&&"cloud"===e.name)return[n,i]}return null}triggerRainEvent(e,t,a,s){const n=!0===s.data.isSnowCloud,i=n?8+Math.floor(8*Math.random()):1+Math.floor(3*Math.random()),r=Math.min(i,s.data.waterCapacity),o=a.registry.get(n?"snow":"water");if(!o)return 0;let l=0;for(let d=1;d<=3&&l<r;d++)for(let s=-1;s<=1&&l<r;s++){const n=a.getCell(e+s,t+d);n&&0===n.element.id&&(a.setElement(e+s,t+d,o),l++)}return l}dropSingleRain(e,t,a){const s=a.getCell(e,t),n=s&&s.data&&!0===s.data.isSnowCloud,i=a.registry.get(n?"snow":"water");if(!i)return!1;const r=a.getCell(e,t+1);return!(!r||0!==r.element.id)&&(a.setElement(e,t+1,i),!0)}updateCloudColor(e){const t=e.data.saturation;let a;a=t<=1?240:t<=5?208:t<=10?176:144,e.element.color=a<<16|a<<8|a}}),ye.register(new class extends G{constructor(){super(33,"steam_vent",5592405,{density:10,state:i,movable:!1,ignitionResistance:1,tags:[E],brushSize:1,emissionDensity:.8})}updateImpl(e,t,a){const s=a.getCell(e,t);if(!s)return!1;if(void 0===s.data.ventTimer&&(s.data.ventTimer=0,s.data.ventCycle=Math.floor(60*Math.random())+30,s.data.ventActive=!1,s.data.ventDuration=0),s.data.ventTimer++,!s.data.ventActive&&s.data.ventTimer>=s.data.ventCycle&&(s.data.ventActive=!0,s.data.ventDuration=Math.floor(40*Math.random())+20,s.data.ventTimer=0),s.data.ventActive){if(s.data.ventDuration--,Math.random()<.8){const s=a.getElement(e,t-1);if(s&&"empty"===s.name)return a.setElement(e,t-1,a.registry.get("steam")),!0}s.data.ventDuration<=0&&(s.data.ventActive=!1,s.data.ventCycle=Math.floor(60*Math.random())+30,s.data.ventTimer=0)}return!1}});class we{constructor(){this.data={}}incrementTimer(e,t=1/0){return void 0===this.data[e]&&(this.data[e]=0),this.data[e]++,this.data[e]>=t}getTimer(e){return this.data[e]||0}resetTimer(e){this.data[e]=0}setTimer(e,t){this.data[e]=t}setState(e){this.data.state=e}getState(){return this.data.state}isState(e){return this.data.state===e}adjustTemperature(e){return void 0===this.data.temperature&&(this.data.temperature=0),this.data.temperature+=e,this.data.temperature}getTemperature(){return this.data.temperature||0}setTemperature(e){this.data.temperature=e}get(e,t=void 0){return void 0!==this.data[e]?this.data[e]:t}set(e,t){this.data[e]=t}has(e){return void 0!==this.data[e]}delete(e){delete this.data[e]}clear(){this.data={}}serialize(){return{...this.data}}deserialize(e){this.data={...e}}}class be{static updateConstructions(e){for(const t of e.activeConstructions){const a=e.keyToCoord(t),s=e.getCell(a.x,a.y);s&&s.data._houseConstruction&&this.updateConstruction(s,a.x,a.y,e)}}static updateConstruction(e,t,a,s){const n=e.data._houseConstruction;if(n&&"object"==typeof n&&(n.buildTimer++,n.buildTimer%1==0))switch(n.buildPhase){case"ground_fill":this.fillGround(n,s);break;case"foundation":this.buildFoundation(n,s);break;case"floor1":this.buildFloor1(n,s);break;case"floor2":this.buildFloor2(n,s);break;case"roof":this.buildRoof(n,s);break;case"complete":delete e.data._houseConstruction,s.unregisterConstruction(t,a)}}static fillGround(e,t){const a=e.centerX,s=e.baseY;if(0===e.buildStep){let n=s;for(let e=-2;e<=2;e++){const o=a+e;for(let e=s;e<Math.min(s+10,t.height);e++){const a=t.getElement(o,e);if(a&&(a.state===i||a.state===r))break;e>n&&(n=e)}}return e.targetBaseY=n,void e.buildStep++}const n=e.targetBaseY,o=e.buildStep-1;if(o<5){const s=a-2+o;for(let e=n;e<t.height;e++){const a=t.getElement(s,e);if(a&&(a.state===i||a.state===r))break;!a||0!==a.id&&"liquid"!==a.state||t.setElement(s,e,t.registry.get("stone"))}e.buildStep++}else e.buildPhase="foundation",e.buildStep=0,e.baseY=n}static buildFoundation(e,t){const a=e.centerX,s=e.baseY,n=e.buildStep;if(n<5){const i=a-2+n;this.forcePlaceBlock(i,s,"stone",t),e.buildStep++}else e.buildPhase="floor1",e.buildStep=0,e.currentY=s-1}static buildFloor1(e,t){const a=e.centerX,s=e.currentY,n=e.buildStep;if(n<3){const i=s-n;this.forcePlaceBlock(a-2,i,"wood",t),e.buildStep++}else if(n<6){const i=s-(n-3);this.forcePlaceBlock(a+2,i,"wood",t),e.buildStep++}else if(n<11){const i=a-2+(n-6),r=s-3;this.forcePlaceBlock(i,r,"wood",t),e.buildStep++}else e.buildPhase="floor2",e.buildStep=0,e.currentY=s-3-1}static buildFloor2(e,t){const a=e.centerX,s=e.currentY,n=e.buildStep;if(n<3){const i=s-n,r=n===Math.floor(1.5)?"glass":"wood";this.forcePlaceBlock(a-2,i,r,t),e.buildStep++}else if(n<6){const i=s-(n-3),r=n-3===Math.floor(1.5)?"glass":"wood";this.forcePlaceBlock(a+2,i,r,t),e.buildStep++}else if(n<11){const i=a-2+(n-6),r=s-3;this.forcePlaceBlock(i,r,"wood",t),e.buildStep++}else e.buildPhase="roof",e.buildStep=0,e.roofBaseY=s-3-1}static buildRoof(e,t){const a=e.centerX,s=e.roofBaseY,n=e.buildStep,i=[[-2,2],[-1,1],[0]];if(n<5){let r=0;for(let o=0;o<i.length;o++)for(let l of i[o]){if(r===n){const n=a+l,i=s-o;return this.forcePlaceBlock(n,i,"stone",t),void e.buildStep++}r++}}else{t.houses||(t.houses=[]);const s=[{x:a-1,y:e.currentY-1},{x:a+1,y:e.currentY-1}],n=Math.random()<.3;if(t.houses.push({centerX:a,baseY:e.baseY,windows:s,lightsOn:!1,hasBuilder:!1,isLateNighter:n}),null!==e.builderX&&null!==e.builderY){const a=t.getCell(e.builderX,e.builderY);a&&"house_seed"===a.element.name&&delete a.data._constructionActive}e.buildPhase="complete"}}static forcePlaceBlock(e,t,a,s){if(!s.isInBounds(e,t))return!1;const n=s.getCell(e,t);if(!n)return!1;const i=n.data._houseConstruction;if(s.setElement(e,t,s.registry.get(a)),i){const a=s.getCell(e,t);a&&(a.data._houseConstruction=i)}return!0}}class Me{static updateHouseLights(e,t){if(!e.houses||0===e.houses.length)return;let a;this.builderSpawnFrameCounter++,this.builderSpawnFrameCounter>=60&&(this.builderSpawnFrameCounter=0,t>.3&&t<.6&&Math.random()<.003&&this.spawnBuilderFromHouse(e)),this.integrityCheckCounter||(this.integrityCheckCounter=0),this.integrityCheckCounter++,this.integrityCheckCounter>=60&&(this.integrityCheckCounter=0,this.checkAndRemoveDestroyedHouses(e)),a=t>=.3&&t<=.7?"day":t>.7&&t<.85?"evening":t>=.85||t<.2?"night":"morning";if(this.previousTimeState!==a){for(const t of e.houses)"day"===a?this.turnOffLights(t,e):"evening"===a?this.turnOnLights(t,e,!1):"morning"===a&&(t.isLateNighter||this.turnOffLights(t,e));this.previousTimeState=a}if("night"===a)for(const s of e.houses){const t=s.isLateNighter?.001:.006;Math.random()<t&&this.turnOffRandomLight(s,e)}}static turnOnLights(e,t,a=!1){const s=t.registry.get("light");if(s){e.lightColors||(e.lightColors=e.windows.map(()=>this.randomLightColor()));for(let a=0;a<e.windows.length;a++){const n=e.windows[a],i=t.getElement(n.x,n.y);if(i&&0===i.id){t.setElement(n.x,n.y,s);const i=t.getCell(n.x,n.y);i&&(i.data.lightColor=e.lightColors[a])}}e.lightsOn=!0}}static randomLightColor(){const e=[16777215,16775408,16774368,16771280,16765120,16767208,16769279,15790320];return e[Math.floor(Math.random()*e.length)]}static turnOffLights(e,t){for(const a of e.windows){const e=t.getElement(a.x,a.y);e&&"light"===e.name&&t.setElement(a.x,a.y,t.registry.get("empty"))}e.lightsOn=!1}static turnOffRandomLight(e,t){const a=e.windows.filter(e=>{const a=t.getElement(e.x,e.y);return a&&"light"===a.name});if(a.length>0){const s=e.isLateNighter?.6:.2,n=e.isLateNighter?.8:.3;if(Math.random()<s)return;if(1===a.length&&Math.random()<n)return;const i=a[Math.floor(Math.random()*a.length)];t.setElement(i.x,i.y,t.registry.get("empty"))}}static spawnBuilderFromHouse(e){if(!e.houses||0===e.houses.length)return;const t=e.houses[Math.floor(Math.random()*e.houses.length)];if(t.hasBuilder)return;const a=t.centerX;for(let s=t.baseY-10;s<t.baseY;s++){const n=e.getElement(a,s),i=e.getElement(a,s+1);if(n&&0===n.id&&i&&"stone"===i.name){const n=e.registry.get("house_seed");return void(n&&(e.setElement(a,s,n),t.hasBuilder=!0,setTimeout(()=>{t.hasBuilder=!1},18e4)))}}}static checkAndRemoveDestroyedHouses(e){e.houses&&0!==e.houses.length&&(e.houses=e.houses.filter(t=>{const a=[{x:t.centerX-2,y:t.baseY-1},{x:t.centerX-2,y:t.baseY-2},{x:t.centerX+2,y:t.baseY-1},{x:t.centerX+2,y:t.baseY-2},{x:t.centerX,y:t.baseY}];let s=0;const n=["wood","glass","stone"];for(const i of a){const t=e.getElement(i.x,i.y);t&&n.includes(t.name)&&s++}return!(s<2)||(this.turnOffLights(t,e),!1)}))}}t(Me,"previousTimeState",null),t(Me,"builderSpawnFrameCounter",0);class ve{constructor(e,t,a,s){this.width=Math.floor(e/a),this.height=Math.floor(t/a),this.pixelSize=a,this.registry=s,this.grid=[],this.particleCount=0,this.frameCount=0,this.boulderCache=new Map,this.activeCells=new Map,this.activeConstructions=new Set,this.neighborOffsets=[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[1,-1],[-1,1],[1,1]];const n=this.registry.get("empty");for(let i=0;i<this.height;i++){this.grid[i]=[];for(let e=0;e<this.width;e++)this.grid[i][e]={element:n,lifetime:-1,updated:!1,state:new we,data:{}}}}coordToKey(e,t){return t*this.width+e}keyToCoord(e){return{x:e%this.width,y:Math.floor(e/this.width)}}registerConstruction(e,t){const a=this.coordToKey(e,t);this.activeConstructions.add(a)}unregisterConstruction(e,t){const a=this.coordToKey(e,t);this.activeConstructions.delete(a)}getCell(e,t){return e<0||e>=this.width||t<0||t>=this.height?null:this.grid[t][e]}getElement(e,t){const a=this.getCell(e,t);return a?a.element:null}setElement(e,t,a,s=!1,n=null){if(e<0||e>=this.width||t<0||t>=this.height)return;if(!a)return;const i=this.grid[t][e],r=0===i.element.id,o=0===a.id,l=i.data.boulderId,d=this.coordToKey(e,t),h="".concat(e,",").concat(t);if(void 0!==l){const e=this.boulderCache.get(l);e&&(e.delete(h),0===e.size&&this.boulderCache.delete(l))}r&&!o&&(this.particleCount++,this.activeCells.set(d,{x:e,y:t})),!r&&o&&(this.particleCount--,this.activeCells.delete(d)),i.element=a,i.lifetime=a.defaultLifetime,i.updated=!1,s||(i.state=new we,i.data={},null!==n&&(i.data.boulderId=n,this.boulderCache.has(n)||this.boulderCache.set(n,new Set),this.boulderCache.get(n).add(h)),a.initializeCell&&"function"==typeof a.initializeCell&&a.initializeCell(i.data))}isEmpty(e,t){const a=this.getElement(e,t);return a&&0===a.id}isInBounds(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height}canMoveTo(e,t,a,s){if(!this.isInBounds(a,s))return!1;const n=this.getElement(e,t),i=this.getElement(a,s);return!(!n||!i)&&(0===i.id||(n.state!==r||i.state!==r)&&(n.density>i.density&&i.movable))}swap(e,t,a,s){if(!this.isInBounds(e,t)||!this.isInBounds(a,s))return;const n=this.grid[t][e],i=this.grid[s][a],r=this.coordToKey(e,t),o=this.coordToKey(a,s),l=0===n.element.id,d=0===i.element.id;!l&&d?(this.activeCells.delete(r),this.activeCells.set(o,{x:a,y:s})):l&&!d&&(this.activeCells.delete(o),this.activeCells.set(r,{x:e,y:t})),this.grid[t][e]=i,this.grid[s][a]=n,this.grid[s][a].updated=!0}update(){var e;this.frameCount++;const t=this.registry.get("stone");t&&t.processedBoulders&&t.processedBoulders.clear();for(const[n,i]of this.activeCells){const t=null==(e=this.grid[i.y])?void 0:e[i.x];t&&(t.updated=!1)}const a=new Map;for(const[n,i]of this.activeCells){const e=i.y,t=i.x;a.has(e)||a.set(e,[]),a.get(e).push(t)}const s=Array.from(a.keys()).sort((e,t)=>t-e);for(const n of s){const e=a.get(n);Math.random()>.5?e.sort((e,t)=>e-t):e.sort((e,t)=>t-e);for(const t of e){const e=this.grid[n][t];e.updated||0===e.element.id||(e.lifetime>0&&(e.lifetime--,0===e.lifetime)?this.setElement(t,n,this.registry.get("empty")):(e.element.update(t,n,this),this.frameCount%2==0&&!1!==e.element.canInteract&&this.checkInteractions(t,n)))}}be.updateConstructions(this),void 0!==this.timeOfDay&&Me.updateHouseLights(this,this.timeOfDay)}setTimeOfDay(e){this.timeOfDay=e,this.dayNightCycle||(this.dayNightCycle={getTime:()=>this.timeOfDay})}setSeasonData(e){this.seasonData=e}checkInteractions(e,t){const a=this.getElement(e,t);if(a&&0!==a.id)for(const[s,n]of this.neighborOffsets){const i=e+s,r=t+n,o=this.getElement(i,r);if(o&&0!==o.id&&this.registry.checkInteraction(a,o,this,e,t,i,r))return}}getBoulderPixels(e){const t=this.boulderCache.get(e);if(!t)return[];const a=[];for(const s of t){const[e,t]=s.split(",").map(Number);a.push({x:e,y:t,cell:this.grid[t][e]})}return a}canBoulderMoveDown(e){const t=this.getBoulderPixels(e);if(0===t.length)return!1;const a=this.registry.get("stone");for(const{x:s,y:n}of t){const t=n+1;if(t>=this.height)return!1;const i=this.grid[t][s],r=i.element;if(0!==r.id&&(i.data.boulderId!==e&&!("liquid"===r.state&&a.density>r.density)))return!1}return!0}moveBoulderDown(e){const t=this.getBoulderPixels(e);t.sort((e,t)=>t.y-e.y);const a=this.registry.get("empty"),s=this.registry.get("stone"),n=this.boulderCache.get(e);for(const{x:i,y:r}of t){const t=this.grid[r][i],o=this.grid[r+1][i],l=o.element;if(o.data.boulderId===e)continue;0!==l.id&&"liquid"===l.state&&s.density>l.density?(this.grid[r+1][i]={element:t.element,lifetime:t.lifetime,updated:!0,data:{boulderId:e}},this.grid[r][i]={element:l,lifetime:o.lifetime,updated:!0,data:o.data}):(this.grid[r+1][i]={element:t.element,lifetime:t.lifetime,updated:!0,data:{boulderId:e}},this.grid[r][i]={element:a,lifetime:-1,updated:!1,data:{}}),n&&(n.delete("".concat(i,",").concat(r)),n.add("".concat(i,",").concat(r+1)))}}}class Ee{constructor(e=X){this.config=e;const t="random"===e.START_SEASON?function(){const e=X.SEASONS;return e[Math.floor(Math.random()*e.length)]}():e.START_SEASON;this.currentSeason=t,this.seasonTime=0,this.seasonLength=X.DAY_LENGTH*X.MONTH_LENGTH*X.SEASON_LENGTH,this.seasonProgress=0,this.currentTemp=this.getSeasonalTemp(t,.5),this.targetTemp=this.currentTemp,this.isTransitioning=!1,this.transitionProgress=0}update(e=1){this.seasonTime+=e,this.seasonProgress=this.seasonTime/this.seasonLength,this.seasonTime>=this.seasonLength&&this.advanceSeason(),this.updateTemperature(e),this.isTransitioning&&(this.transitionProgress+=.01,this.transitionProgress>=1&&(this.isTransitioning=!1,this.transitionProgress=0))}advanceSeason(){this.currentSeason,this.currentSeason=function(e){const t=X.SEASONS,a=t.indexOf(e);return t[(a+1)%t.length]}(this.currentSeason),this.seasonTime=0,this.seasonProgress=0,this.isTransitioning=!0,this.transitionProgress=0,this.targetTemp=this.getSeasonalTemp(this.currentSeason,.5)}updateTemperature(e){this.targetTemp=this.getSeasonalTemp(this.currentSeason,this.seasonProgress);const t=this.targetTemp-this.currentTemp;this.currentTemp+=t*this.config.TEMP_TRANSITION_SPEED*e}getSeasonalTemp(e,t){const a=this.config.TEMPERATURE[e];if(!a)return.5;const{min:s,max:n}=a;return(s+n)/2+Math.sin(t*Math.PI)*(n-s)/2}getCurrentSeason(){return this.currentSeason}getTemperature(){return this.currentTemp}getSeasonProgress(){return this.seasonProgress}isSeasonTransitioning(){return this.isTransitioning}getTransitionProgress(){return this.transitionProgress}shouldFreeze(){return this.currentTemp<0}shouldMelt(){return this.currentTemp>.5}getLeafColor(e=this.currentSeason){const t=this.config.LEAF_COLORS[e];return t&&0!==t.length?t[Math.floor(Math.random()*t.length)]:this.config.LEAF_COLORS.summer[0]}getTreeGrowthMultiplier(){return this.config.TREE_GROWTH_MULTIPLIER[this.currentSeason]||1}getTreeDecayChance(){return this.config.TREE_DECAY_CHANCE[this.currentSeason]||0}getLeafFallRate(){return this.config.LEAF_FALL_RATE[this.currentSeason]||0}getCloudSpawnMultiplier(){return this.config.CLOUD_SPAWN_MULTIPLIER[this.currentSeason]||1}shouldSpawnSnowClouds(){return"winter"===this.currentSeason&&Math.random()<this.config.SNOW_CLOUD_CHANCE}getIceMeltMultiplier(){return this.config.ICE_MELT_MULTIPLIER[this.currentSeason]||1}shouldBirdsMigrate(){return"autumn"===this.currentSeason&&this.seasonProgress>this.config.MIGRATION_START}isWinter(){return"winter"===this.currentSeason}isEarlySpring(){return"spring"===this.currentSeason&&this.seasonProgress<.2}getSkyTint(){return this.config.SKY_TINT[this.currentSeason]||{r:1,g:1,b:1}}getSunTint(){return this.config.SUN_TINT[this.currentSeason]||{r:1,g:1,b:1}}getDebugInfo(){return{season:this.currentSeason,progress:"".concat((100*this.seasonProgress).toFixed(1),"%"),temperature:this.currentTemp.toFixed(2),transitioning:this.isTransitioning,freezing:this.shouldFreeze(),melting:this.shouldMelt()}}serialize(){return{currentSeason:this.currentSeason,seasonTime:this.seasonTime,currentTemp:this.currentTemp}}deserialize(e){e.currentSeason&&(this.currentSeason=e.currentSeason),void 0!==e.seasonTime&&(this.seasonTime=e.seasonTime,this.seasonProgress=this.seasonTime/this.seasonLength),void 0!==e.currentTemp&&(this.currentTemp=e.currentTemp,this.targetTemp=e.currentTemp)}}class Ce{constructor(e=X,t){this.config=e,this.seasonManager=t,this.direction=Math.random()>.5?1:-1,this.strength=2*Math.random(),this.changeTimer=0,this.targetDirection=this.direction,this.targetStrength=this.strength}update(e=1){this.config.WIND_ENABLED&&(this.changeTimer-=e,this.changeTimer<=0&&(this.generateNewWind(),this.resetChangeTimer()),this.smoothTransition(e))}generateNewWind(){const e=this.seasonManager.getCurrentSeason(),t=this.config.WIND_PATTERNS[e]||{strength:1,variability:1};Math.random()<.3&&(this.targetDirection=-this.targetDirection);const a=t.strength,s=t.variability,n=2*(Math.random()-.5);this.targetStrength=a+n*s,this.targetStrength=Math.max(this.config.WIND_STRENGTH_RANGE.min,Math.min(this.config.WIND_STRENGTH_RANGE.max,this.targetStrength)),("autumn"===e||"winter"===e)&&Math.random()<.2&&(this.targetStrength=Math.min(this.config.WIND_STRENGTH_RANGE.max,this.targetStrength+1.5)),"summer"===e&&Math.random()<.4&&(this.targetStrength=0)}resetChangeTimer(){const e=this.config.WIND_CHANGE_INTERVAL,t=this.seasonManager.getCurrentSeason();this.changeTimer="autumn"===t?e*(.5+.5*Math.random()):"summer"===t?e*(1.5+.5*Math.random()):e*(.8+.4*Math.random())}smoothTransition(e){if(this.direction!==this.targetDirection){const t=.1*e;Math.abs(this.direction-this.targetDirection)<t?this.direction=this.targetDirection:this.direction+=Math.sign(this.targetDirection-this.direction)*t}const t=this.targetStrength-this.strength;this.strength+=.02*t*e}getWindDirection(){return this.direction}getWindStrength(){return this.strength}getWindVector(){return{x:this.direction*this.strength*.3,y:0}}getWindProbabilityBoost(){return Math.min(1,this.strength/3)}isWindy(){return this.strength>1.5}isCalm(){return this.strength<.5}isBlowingEast(){return this.direction>0}isBlowingWest(){return this.direction<0}getWindDescription(){const e=this.isBlowingEast()?"East":"West";let t="Calm";return this.strength>2.5?t="Strong Gale":this.strength>2?t="Strong":this.strength>1.5?t="Moderate":this.strength>1?t="Gentle":this.strength>.5&&(t="Light"),"".concat(t," ").concat(e)}getDebugInfo(){return{direction:this.direction>0?"East":"West",strength:this.strength.toFixed(2),description:this.getWindDescription(),nextChange:Math.ceil(this.changeTimer/60)}}serialize(){return{direction:this.direction,strength:this.strength,changeTimer:this.changeTimer}}deserialize(e){void 0!==e.direction&&(this.direction=e.direction),void 0!==e.strength&&(this.strength=e.strength,this.targetStrength=e.strength),void 0!==e.changeTimer&&(this.changeTimer=e.changeTimer)}}class Se{constructor(){this.sunRadius=25,this.moonRadius=18,this.moonPhases=["new","waxing_crescent","first_quarter","waxing_gibbous","full","waning_gibbous","third_quarter","waning_crescent"],this.currentMoonPhaseIndex=Math.floor(8*Math.random()),this.lastPhaseChangeDay=-1}update(e,t){e>=.25&&e<.3&&t!==this.lastPhaseChangeDay&&(this.currentMoonPhaseIndex=(this.currentMoonPhaseIndex+1)%8,this.lastPhaseChangeDay=t)}getMoonPhaseIndex(){return this.currentMoonPhaseIndex}getMoonPhaseName(){return this.moonPhases[this.currentMoonPhaseIndex]}getMoonPhaseNormalized(){return this.currentMoonPhaseIndex/8}getSunPosition(e,t,a){const s=(a-.25)/.5*Math.PI;return{x:e/2+Math.cos(Math.PI-s)*e*.5,y:t-(.2+.75*Math.sin(s))*t}}getMoonPosition(e,t,a){const s=((a+.5)%1-.25)/.5*Math.PI;return{x:e/2+Math.cos(Math.PI-s)*e*.5,y:t-(.2+.75*Math.sin(s))*t}}isSunVisible(e){return e>.2&&e<.8}isMoonVisible(e){return e<.3||e>.7}renderSun(e,t,a,s){const n=1-.5*a,i=this.tintColor(16776960,s),r=this.tintColor(16753920,s),o=this.tintColor(16747520,s),l=this.tintColor(16739125,s);e.fillStyle(i,1*n),e.fillCircle(t.x,t.y,this.sunRadius),e.fillStyle(r,.4*n),e.fillCircle(t.x,t.y,1.4*this.sunRadius),e.fillStyle(o,.2*n),e.fillCircle(t.x,t.y,1.8*this.sunRadius),e.fillStyle(l,.1*n),e.fillCircle(t.x,t.y,2.2*this.sunRadius)}tintColor(e,t){const a=e>>16&255,s=e>>8&255,n=255&e;return Math.min(255,Math.floor(a*t.r))<<16|Math.min(255,Math.floor(s*t.g))<<8|Math.min(255,Math.floor(n*t.b))}renderMoon(e,t){const a=this.getMoonPhaseNormalized(),s=this.moonRadius,n=a*Math.PI*2,i=-Math.cos(n),r=(i+1)/2;if(r>.3){const a=.04*r;e.fillStyle(10526896,a),e.fillCircle(t.x,t.y,1.4*s)}if(r<.05)e.fillStyle(4868682,.4),e.fillCircle(t.x,t.y,s);else if(r>=.98)e.fillStyle(16119285,1),e.fillCircle(t.x,t.y,s);else{const n=a<.5,r=i;if(e.fillStyle(15263976,1),e.beginPath(),n){e.arc(t.x,t.y,s,-Math.PI/2,Math.PI/2,!1);const a=30;for(let n=0;n<=a;n++){const i=Math.PI/2-n/a*Math.PI,o=t.y+s*Math.sin(i),l=t.x-s*r*Math.cos(i);e.lineTo(l,o)}}else{e.arc(t.x,t.y,s,-Math.PI/2,Math.PI/2,!0);const a=30;for(let n=0;n<=a;n++){const i=Math.PI/2-n/a*Math.PI,o=t.y+s*Math.sin(i),l=t.x+s*r*Math.cos(i);e.lineTo(l,o)}}e.closePath(),e.fillPath()}}serialize(){return{currentMoonPhaseIndex:this.currentMoonPhaseIndex,lastPhaseChangeDay:this.lastPhaseChangeDay}}deserialize(e){void 0!==e.currentMoonPhaseIndex&&(this.currentMoonPhaseIndex=e.currentMoonPhaseIndex),void 0!==e.lastPhaseChangeDay&&(this.lastPhaseChangeDay=e.lastPhaseChangeDay)}}class Te extends s.Scene{constructor(){super("GameScene"),this.selectedElement="sand",this.isDrawing=!1,this.elementRegistry=ye,this.nextBoulderId=1,this.playerX=null,this.playerY=null,this.buildMode=!0,this.keys={}}create(){const{width:e,height:t}=this.sys.game.config;this.pixelSize=4,this.pixelGrid=new ve(e,t,this.pixelSize,this.elementRegistry),this.dayNightCycle={time:.35,baseSpeed:.001},this.timeControl={speedLevels:[.1,.25,.5,1,2,5,10,20,50,100],currentSpeedIndex:3,maxPhysicsSpeed:5},this.currentDay=0,this.celestialManager=new Se,this.weatherSystem={cloudiness:Math.random(),cloudSpawnTimer:0,cloudCoverage:0,nextCloudDay:Math.random()},this.seasonManager=new Ee(X),this.windManager=new Ce(X,this.seasonManager),this.skyGraphics=this.add.graphics(),this.celestialGraphics=this.add.graphics(),this.graphics=this.add.graphics(),this.lavaGlowGraphics=this.add.graphics(),this.lightGlowGraphics=this.add.graphics(),this.overlayGraphics=this.add.graphics();const a=this.celestialGraphics.postFX.addGlow(16768324,2,0,!1,.1,5);this.celestialGlow=a;const s=this.lightGlowGraphics.postFX.addGlow(16768409,3,1,!1,.1,6);this.lightGlow=s;const n=this.lavaGlowGraphics.postFX.addGlow(16737792,6,2,!1,.1,8);this.lavaGlow=n,this.input.on("pointerdown",this.startDrawing,this),this.input.on("pointerup",this.stopDrawing,this),this.input.on("pointermove",this.draw,this),this.setupElementSelector(),this.fpsText=document.getElementById("fps"),this.particlesText=document.getElementById("particles"),this.versionText=document.getElementById("version"),this.modeDisplay=document.getElementById("mode-display"),this.seasonDisplay=document.getElementById("season-display"),this.speedDisplay=document.getElementById("speed-display"),this.versionText.textContent="4.2.3",this.updateModeDisplay();const i=document.getElementById("speed-down"),r=document.getElementById("speed-up");i&&i.addEventListener("click",()=>this.decreaseTimeSpeed()),r&&r.addEventListener("click",()=>this.increaseTimeSpeed()),this.createBorders()}createBorders(){const e=this.elementRegistry.get("wall");if(e){for(let t=0;t<this.pixelGrid.width;t++)for(let a=0;a<3;a++)this.pixelGrid.setElement(t,this.pixelGrid.height-1-a,e);for(let t=0;t<this.pixelGrid.height;t++)for(let a=0;a<3;a++)this.pixelGrid.setElement(a,t,e),this.pixelGrid.setElement(this.pixelGrid.width-1-a,t,e)}}resetWorld(){const e=this.elementRegistry.get("empty");for(let t=0;t<this.pixelGrid.height;t++)for(let a=0;a<this.pixelGrid.width;a++)this.pixelGrid.setElement(a,t,e);this.createBorders(),this.buildMode=!0,this.updateModeDisplay(),this.playerX=null,this.playerY=null}setupElementSelector(){const e=document.getElementById("element-selector"),t=document.getElementById("global-tooltip"),a=document.getElementById("tooltip-name"),s=document.getElementById("tooltip-props"),n=document.getElementById("tooltip-key");this.elementConfigs={sand:{icon:"",color:"#c2b280"},water:{icon:"",color:"#4a90e2"},stone:{icon:"",color:"#666"},wall:{icon:"",color:"#444"},fire:{icon:"",color:"#ff6b35"},wood:{icon:"",color:"#8b4513"},oil:{icon:"",color:"#3d3d1a"},gunpowder:{icon:"",color:"#333"},fossil:{icon:"",color:"#8b7355"},fish:{icon:"",color:"#1a5f7a"},bird:{icon:"",color:"#ffffff"},tree_seed:{icon:"",color:"#654321"},ash:{icon:"",color:"#999"},ice:{icon:"",color:"#87ceeb"},glass:{icon:"",color:"#add8e6"},lava:{icon:"",color:"#ff4500"},acid:{icon:"",color:"#7fff00"},vine:{icon:"",color:"#228b22"},snow:{icon:"",color:"#ffffff"},slush:{icon:"",color:"#b0e0e6"},coal:{icon:"",color:"#1a1a1a"},coral:{icon:"",color:"#ff6b9d"},steam_vent:{icon:"",color:"#555555"},house_seed:{icon:"",color:"#8b4513"},eraser:{icon:"",color:"#ff3333"}},[{name:"fire",key:"1"},{name:"steam_vent",key:"2"},{name:"water",key:"3"},{name:"oil",key:"4"},{name:"lava",key:"5"},{name:"acid",key:"6"},{name:"slush",key:"Y"},{name:"sand",key:"7"},{name:"gunpowder",key:"8"},{name:"snow",key:"9"},{name:"stone",key:"0"},{name:"wood",key:"Q"},{name:"ice",key:"W"},{name:"glass",key:"E"},{name:"wall",key:"R"},{name:"coal",key:"T"},{name:"tree_seed",key:"U"},{name:"vine",key:"I"},{name:"fish",key:"O"},{name:"bird",key:"L"},{name:"coral",key:"P"},{name:"house_seed",key:"A"},{name:"eraser",key:"X"}].forEach(({name:i,key:r},o)=>{const l=this.elementRegistry.get(i);if(!l&&"eraser"!==i)return;const d=this.elementConfigs[i],h=document.createElement("button");h.className="element-btn","sand"===i&&h.classList.add("active"),h.dataset.element=i,h.dataset.key=r,h.style.background=d.color,h.textContent=d.icon;const c=document.createElement("div");c.className="keybind",c.textContent=r,h.appendChild(c);const m=e=>{if(a.textContent=i.replace(/_/g," "),l){const e=this.generateElementDescription(l);s.textContent=e||l.state||""}else s.textContent="";n.textContent=r;const o=h.getBoundingClientRect();t.style.display="block";const d=t.getBoundingClientRect().width;let c=o.left+o.width/2,m="translateX(-50%)";c-d/2<10?(c=o.left,m="translateX(0)"):c+d/2>window.innerWidth-10&&(c=o.right,m="translateX(-100%)"),t.style.left="".concat(c,"px"),t.style.bottom="".concat(window.innerHeight-o.top+10,"px"),t.style.transform=m},u=()=>{t.style.display="none"};h.addEventListener("mouseenter",m),h.addEventListener("mouseleave",u);const g=()=>{document.querySelectorAll(".element-btn").forEach(e=>e.classList.remove("active")),h.classList.add("active"),this.selectedElement=i,u()};let f=0;h.addEventListener("touchstart",e=>{e.preventDefault(),f=Date.now(),m()}),h.addEventListener("touchend",e=>{e.preventDefault();Date.now()-f<300?g():u()}),h.addEventListener("touchcancel",u),h.addEventListener("click",g),e.appendChild(h)}),window.addEventListener("keydown",e=>{const t=e.key.toUpperCase();if("B"===t){this.buildMode=!this.buildMode,this.buildMode||null!==this.playerX||this.spawnPlayer(),this.updateModeDisplay();const t=document.getElementById("mode-indicator")||this.createModeIndicator();return t.textContent=this.buildMode?" Build Mode":" Explore Mode",t.style.display="block",setTimeout(()=>{t.style.display="none"},2e3),void e.preventDefault()}if("P"===t){const t=A.toggle();return document.getElementById("profiler-panel").style.display=t?"block":"none",void e.preventDefault()}if("["===t)return this.decreaseTimeSpeed(),void e.preventDefault();if("]"===t)return this.increaseTimeSpeed(),void e.preventDefault();if(!this.buildMode){if("ARROWLEFT"===t||"A"===t)return this.keys.left=!0,void e.preventDefault();if("ARROWRIGHT"===t||"D"===t)return this.keys.right=!0,void e.preventDefault();if("ARROWUP"===t||"W"===t||" "===t)return this.keys.jump=!0,void e.preventDefault()}const a=document.querySelector('.element-btn[data-key="'.concat(t,'"]'));a&&(a.click(),e.preventDefault())}),window.addEventListener("keyup",e=>{const t=e.key.toUpperCase();"ARROWLEFT"!==t&&"A"!==t||(this.keys.left=!1),"ARROWRIGHT"!==t&&"D"!==t||(this.keys.right=!1),"ARROWUP"!==t&&"W"!==t&&" "!==t||(this.keys.jump=!1)}),this.profilerPanel=document.getElementById("profiler-content")}createModeIndicator(){const e=document.createElement("div");return e.id="mode-indicator",e.style.cssText="\n            position: fixed;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(0,0,0,0.8);\n            color: white;\n            padding: 10px 20px;\n            border-radius: 8px;\n            font-size: 18px;\n            font-weight: bold;\n            z-index: 1000;\n            display: none;\n        ",document.body.appendChild(e),e}updateModeDisplay(){this.modeDisplay&&(this.buildMode?(this.modeDisplay.textContent=" Build",this.modeDisplay.style.color="#00ffff"):(this.modeDisplay.textContent=" Explore",this.modeDisplay.style.color="#00ff00"))}spawnPlayer(){const e=Math.floor(this.pixelGrid.width/2),t=Math.floor(.3*this.pixelGrid.height),a=this.elementRegistry.get("player");this.pixelGrid.setElement(e,t,a),this.playerX=e,this.playerY=t}getCurrentTimeSpeed(){return this.timeControl.speedLevels[this.timeControl.currentSpeedIndex]}increaseTimeSpeed(){this.timeControl.currentSpeedIndex<this.timeControl.speedLevels.length-1&&(this.timeControl.currentSpeedIndex++,this.showTimeSpeedIndicator())}decreaseTimeSpeed(){this.timeControl.currentSpeedIndex>0&&(this.timeControl.currentSpeedIndex--,this.showTimeSpeedIndicator())}showTimeSpeedIndicator(){const e=this.getCurrentTimeSpeed(),t=document.getElementById("mode-indicator")||this.createModeIndicator();let a;a=e<1?" ".concat(e,"x Speed"):1===e?" Normal Speed":" ".concat(e,"x Speed"),t.textContent=a,t.style.display="block",setTimeout(()=>{t.style.display="none"},2e3)}findPlayer(){if(null===this.playerX||null===this.playerY)return;for(let e=-5;e<=5;e++)for(let t=-5;t<=5;t++){const a=this.playerX+t,s=this.playerY+e,n=this.pixelGrid.getElement(a,s);if(n&&"player"===n.name)return this.playerX=a,void(this.playerY=s)}}generateElementDescription(e){const t={bird:"Living creature  Flies through the air with bobbing gliding motion  Gets hungry and seeks food on ground  Sleeps at night on perches (trees, roofs, ground)  Wakes up at dawn  Flocks with other birds  Escapes when trapped indoors  Dies if starving  Burns to ash when ignited  Multiple color variants (white, gray)  SEASONAL: Migrates south in mid-autumn (flies upward and disappears)  Returns in early spring (spawns at top of map)",fish:"Living creature  Swims in water bodies  Gets hungry and seeks food at water surface  Dies after 5 seconds out of water  Falls through air when stranded  Swims in schools with other fish  Multiple color variants (orange, gold, red, black)  Burns to ash when exposed to fire",tree_seed:"Organic seed  Falls until landing on solid ground  Germinates after 2 seconds on ground  Grows into procedurally-generated tree with trunk and branches  Takes 80 frames per growth segment  Produces leaves at branch terminals  Spacing prevents overcrowding  Burns to ash  SEASONAL: Grows 2x faster in spring, normal in summer, 2x slower in autumn, stops completely in winter",house_seed:"Wandering builder  Falls until landing  Wanders horizontally seeking good building spot  Climbs over 1-block obstacles  Burrows through sand and soft materials  Validates location (needs clearance, solid ground, avoids water/trees)  Builds complete house with foundation, walls, windows, door, and roof  Steps aside during construction  Waits 10s cooldown then builds another house  Burns to ash",water:"Liquid, flows downward and spreads  Extinguishes fire (70% chance)  becomes steam  Turns lava into stone on contact (20% chance)  Sand becomes wet when submerged in water  Absorbed by trees  trees get wet and grow leaves 3x faster  Evaporates near heat  steam  Essential for fish survival  SEASONAL: Surface freezes to ice in winter when temperature < 0C (deep water stays liquid)",lava:"Liquid, flows slowly  Very hot - ignites flammable materials on contact  Turns into stone when touching water (20% chance)  Melts ice on contact  Glowing heat source  High density (sinks below most liquids)",sand:"Powder, falls and piles  Becomes wet sand when submerged in water or when water directly above  Wet sand is darker and dries slowly over time  Can be burrowed through by builders  Buildable material for foundations",fire:"Gas, rises  Heat source - ignites combustible materials (10% base chance)  Spreads to nearby flammables  Extinguished by water  Creates light  Lasts 40s then burns out  Very light (rises above everything)",steam:"Gas, rises rapidly  Created when water evaporates or touches fire  Rises to atmosphere and forms clouds  Clouds accumulate steam and eventually rain  Dissipates after 20s",cloud:"Gas, floats in upper atmosphere  Forms from accumulated steam  Drifts horizontally with wind  40% of clouds produce rain  Saturated clouds (dark gray) drop 1-3 water droplets  Highly saturated clouds generate lightning strikes  Absorbs nearby steam to grow  Can merge with adjacent clouds  Lasts 40s  Darkens sky when covering sun  SEASONAL: Drops snow instead of rain in winter  Drift speed/direction affected by seasonal wind patterns",stone:"Solid, immovable  Created when lava touches water  Building material  Very dense and stable  Resistant to most interactions  Burns slowly if exposed to sustained heat",wood:"Solid building material  Burns slowly  burning wood (takes 25s to fully burn)  Resistant to ignition (80% resistance)  Tree trunks and branches made of wood  Can be used for construction",burning_wood:"Solid, burning  Heat source - ignites nearby flammables  Spreads fire to combustibles (12% chance)  Burns for 25 seconds total  ash  Creates warmth and light",coal:"Solid fuel  Burns very slowly and hot  fire  Excellent long-lasting heat source  Found in fossil deposits  High ignition resistance  Dense material",ash:"Powder, falls lightly  Created when organic materials burn completely  Settles on ground  Disperses easily  Dissolves after 6 seconds  Very light and soft - can be burrowed through",ice:"Solid, frozen water  Melts near heat sources  water  Can be broken or pushed  Slippery surface  Colder than regular materials  SEASONAL: Melts 2x faster in summer, 10x slower in winter",gunpowder:"Explosive powder, falls  Extremely flammable (ignites instantly on contact with heat)  Explodes in 3-cell radius when ignited  Explosion creates fire at center, ignites nearby gunpowder (chain reaction), destroys combustibles, pushes particles away 2-4 cells  Becomes wet and inert when submerged  wet gunpowder  Burns to fire",wet_gunpowder:"Wet powder, falls  Inert - cannot ignite or explode while wet  Dries very slowly over time (0.05% per frame)  gunpowder  Created when gunpowder touches water",oil:"Liquid, flows  Highly flammable - ignites easily  Burns intensely when ignited  fire  Floats on water (lower density)  Spreads across surfaces  Evaporates slowly",acid:"Liquid, flows  Corrosive - dissolves organic materials on contact  Melts through certain substances  Dangerous to living creatures  Bright green color",glass:"Solid, transparent  Created by heating sand to extreme temperatures  Fragile - shatters under pressure  Transparent/translucent material  Non-flammable",vine:"Organic plant  Grows and spreads along surfaces  Climbs upward on walls  Burns when exposed to fire  ash  Creates natural coverage  Living plant material",snow:"Powder, falls lightly  Forms slush when touching water (40% chance)  Melts near heat  water  Accumulates on surfaces  Very light and disperses easily  Cold material  Settles in piles  Drifts down gently",slush:"Thick liquid mixture of snow and water  Flows slowly and viscously  Forms when snow contacts water  Melts near heat  water  Freezes back to ice when exposed to cold air (not touching water)  Heavier than ice but lighter than water  Very thick and sludgy  Coastal/winter material",coral:"Organic solid  Grows underwater in colonies  Requires water to survive  Dies if exposed to air  Colorful reef-building material  Burns when exposed to fire",steam_vent:"Solid structure  Continuously produces steam  Natural heat source  Creates rising steam plumes  Contributes to cloud formation  Permanent fixture",fossil:"Solid organic remains  Ancient preserved material  Can contain coal deposits  Combustible under extreme heat  Historical remnant",electricity:"Energy, travels rapidly  Created by lightning from storm clouds  Follows conductive paths  Ignites flammables instantly  Dissipates quickly  Dangerous to living creatures",leaf:"Organic plant matter  Grows at tree branch terminals  Falls slowly when detached  Burns easily  ash  Soft material - can be burrowed through  Part of tree canopy  SEASONAL: Bright green in spring, deep green in summer, yellow/orange/red in autumn (0.2% fall rate), brown in winter (0.5% fall rate  bare trees)",tree_trunk:"Solid wood  Main structural trunk of trees  Absorbs water from above  gets wet  dries out slowly  Burns  burning wood  Strong building material  Part of tree structure  SEASONAL: Regrows leaves faster in spring (0.01% regrowth rate), occasional decay in autumn/winter (0.001-0.002%  ash)  WATERED: Wet trees (wetness > 20) have 3x leaf growth rate",tree_branch:"Solid wood  Tree branches extending from trunk  Absorbs water from above  gets wet  dries out slowly  Burns  burning wood  Supports leaves  Part of tree structure  SEASONAL: Regrows leaves in spring, may decay and fall off in autumn/winter (0.001-0.002%  movable wood)  WATERED: Wet branches (wetness > 20) have 3x leaf growth rate",wet_sand:"Wet powder, falls slowly  Darker than dry sand  Created when sand submerged or water directly above  Dries slowly over time  sand  Clumps together more than dry sand  Coastal/beach material",smoke:"Gas, rises  Created by burning materials  Rises into atmosphere  Visual indicator of fire  Dissipates after 10s  No direct interactions",player:"You!  Controlled character in explore mode  Use arrow keys or A/D to move left/right  Press B to toggle between build and explore modes  Affected by gravity and physics  Can interact with elements",empty:"Nothing - empty space  Draw here to place elements  Eraser removes elements leaving empty space",eraser:"Tool - removes elements and creates empty space  Use to clear unwanted materials  Large brush size for quick cleanup"};if(t[e.name])return t[e.name];const a=[];"liquid"===e.state?a.push("liquid, flows"):"powder"===e.state?a.push("powder, falls"):"solid"===e.state?a.push("solid"):"gas"===e.state&&a.push("gas, rises");const s=[];return Array.isArray(e.tags)&&(e.tags.includes("combustible")&&s.push("burns"),e.tags.includes("heat_source")&&s.push("heat source")),s.length>0&&a.push(s.join(", ")),a.join("  ")||"Unknown element"}startDrawing(e){this.buildMode&&(this.isDrawing=!0,this.draw(e))}stopDrawing(){this.isDrawing=!1}draw(e){if(!this.isDrawing)return;const t=Math.floor(e.x/this.pixelSize),a=Math.floor(e.y/this.pixelSize),s="eraser"===this.selectedElement?this.elementRegistry.get("empty"):this.elementRegistry.get(this.selectedElement);if(!s)return;const n=s.brushSize,i=s.emissionDensity;for(let r=-n;r<=n;r++)for(let e=-n;e<=n;e++)if(e*e+r*r<=n*n&&Math.random()<i){const n=t+e,i=a+r,o=2;if(n<o||n>=this.pixelGrid.width-o||i<o||i>=this.pixelGrid.height-o)continue;const l=this.pixelGrid.getElement(n,i);if(l&&"player"===l.name)continue;this.pixelGrid.setElement(n,i,s,!1,null)}}update(){A.start("frame:total");const e=this.getCurrentTimeSpeed(),t=this.dayNightCycle.time;if(this.dayNightCycle.time=(this.dayNightCycle.time+this.dayNightCycle.baseSpeed*e)%1,t>this.dayNightCycle.time&&this.currentDay++,this.celestialManager.update(this.dayNightCycle.time,this.currentDay),this.seasonManager.update(e),this.windManager.update(e),this.pixelGrid.setSeasonData({season:this.seasonManager.getCurrentSeason(),seasonProgress:this.seasonManager.getSeasonProgress(),temperature:this.seasonManager.getTemperature(),windVector:this.windManager.getWindVector(),windDirection:this.windManager.getWindDirection(),windStrength:this.windManager.getWindStrength()}),this.seasonManager.isEarlySpring()&&!this.birdsReturned&&(this.spawnSpringBirds(),this.birdsReturned=!0),"spring"!==this.seasonManager.getCurrentSeason()&&(this.birdsReturned=!1),this.dayNightCycle.time>this.weatherSystem.nextCloudDay&&this.dayNightCycle.time<this.weatherSystem.nextCloudDay+.01&&(this.weatherSystem.cloudiness=Math.random(),this.weatherSystem.nextCloudDay=(this.weatherSystem.nextCloudDay+1)%1),this.dayNightCycle.time>=.25&&this.dayNightCycle.time<=.75&&this.updateCloudSystem(),!this.buildMode&&null!==this.playerX&&null!==this.playerY){const e=this.pixelGrid.getElement(this.playerX,this.playerY);if(e&&"player"===e.name){if(this.movementTimer||(this.movementTimer=0),this.movementTimer++,this.movementTimer%3==0){if(this.keys.left){e.handleMovement(this.playerX,this.playerY,this.pixelGrid,"left")&&this.playerX--}if(this.keys.right){e.handleMovement(this.playerX,this.playerY,this.pixelGrid,"right")&&this.playerX++}}this.keys.jump&&!this.lastKeyJump?(e.handleMovement(this.playerX,this.playerY,this.pixelGrid,"jump"),this.lastKeyJump=!0):this.keys.jump||(this.lastKeyJump=!1)}}A.start("physics:update"),this.pixelGrid.setTimeOfDay(this.dayNightCycle.time);const a=Math.min(e,this.timeControl.maxPhysicsSpeed),s=Math.floor(a),n=a-s;for(let d=0;d<s;d++)this.pixelGrid.update();n>0&&Math.random()<n&&this.pixelGrid.update(),A.end("physics:update"),this.buildMode||this.findPlayer(),A.start("render:total"),this.render(),A.end("render:total"),this.fpsText.textContent=Math.round(this.game.loop.actualFps),this.particlesText.textContent=this.pixelGrid.particleCount;const i=this.seasonManager.getCurrentSeason(),r=i.charAt(0).toUpperCase()+i.slice(1);this.seasonDisplay.textContent="".concat({spring:"",summer:"",autumn:"",winter:""}[i]," ").concat(r);const o=this.getCurrentTimeSpeed();let l="";o<1?l="":o>10?l="":o>1&&(l=""),this.speedDisplay.textContent="".concat(l," ").concat(o,"x"),A.enabled&&this.updateProfilerPanel(),A.end("frame:total")}updateCloudSystem(){const e=this.pixelGrid,t=this.elementRegistry.get("cloud");if(!t)return;let a=0;const s=Math.floor(.4*e.height);for(let l=0;l<s;l++)for(let t=0;t<e.width;t++){const s=e.getElement(t,l);s&&"cloud"===s.name&&a++}const n=e.width*s*.02;this.weatherSystem.cloudCoverage=Math.min(a/n,1),this.weatherSystem.cloudSpawnTimer++;const i=this.weatherSystem.cloudiness,r=this.seasonManager.getCloudSpawnMultiplier();let o;if(o=i>.7?(60+60*Math.random())/r:i>.4?(120+180*Math.random())/r:(300+300*Math.random())/r,this.weatherSystem.cloudSpawnTimer>o&&this.weatherSystem.cloudCoverage<.8){this.weatherSystem.cloudSpawnTimer=0;const a=Math.floor(Math.random()*e.width),n=Math.floor(Math.random()*s),i=e.getElement(a,n);if(i&&0===i.id&&(e.setElement(a,n,t),this.seasonManager.shouldSpawnSnowClouds())){const t=e.getCell(a,n);t&&t.data&&(t.data.isSnowCloud=!0)}}}spawnSpringBirds(){const e=this.pixelGrid,t=this.elementRegistry.get("bird");if(!t)return;const a=5+Math.floor(6*Math.random());for(let s=0;s<a;s++){const a=Math.floor(Math.random()*e.width),s=10+Math.floor(10*Math.random());e.isEmpty(a,s)&&e.setElement(a,s,t)}}render(){var e;const{width:t,height:a}=this.sys.game.config,s=this.dayNightCycle.time;A.start("render:sky"),this.renderSky(t,a,s),A.end("render:sky"),A.start("render:celestial"),this.renderCelestialBodies(t,a,s),A.end("render:celestial"),A.start("render:particles"),this.graphics.clear(),this.lavaGlowGraphics.clear(),this.lightGlowGraphics.clear();const n=this.getLightingColor(s),i=new Map,r=[],o=[];for(const[l,d]of this.pixelGrid.activeCells){const t=null==(e=this.pixelGrid.grid[d.y])?void 0:e[d.x];if(t&&0!==t.element.id){const e=t.data.fishColor||t.data.birdColor||t.data.lightColor||t.data.leafColor||t.element.color,a="light"===t.element.name,s=a?e:this.applyLighting(e,n),l=!0===t.data.isLavaSurface;a?o.push({coords:d,color:s}):l?r.push({coords:d,color:s}):(i.has(s)||i.set(s,[]),i.get(s).push(d))}}for(const[l,d]of i){this.graphics.fillStyle(l,1);for(const e of d)this.graphics.fillRect(e.x*this.pixelSize,e.y*this.pixelSize,this.pixelSize,this.pixelSize)}if(r.length>0){const e=new Map;for(const t of r)e.has(t.color)||e.set(t.color,[]),e.get(t.color).push(t.coords);for(const[t,a]of e){this.lavaGlowGraphics.fillStyle(t,1);for(const e of a)this.lavaGlowGraphics.fillRect(e.x*this.pixelSize,e.y*this.pixelSize,this.pixelSize,this.pixelSize)}}if(o.length>0){const e=new Map;for(const t of o)e.has(t.color)||e.set(t.color,[]),e.get(t.color).push(t.coords);for(const[t,a]of e){this.lightGlowGraphics.fillStyle(t,1);for(const e of a)this.lightGlowGraphics.fillRect(e.x*this.pixelSize,e.y*this.pixelSize,this.pixelSize,this.pixelSize)}}A.end("render:particles"),A.start("render:border"),this.renderWorldBorder(),A.end("render:border"),A.start("render:atmosphere"),this.renderAtmosphere(t,a,s),A.end("render:atmosphere")}renderWorldBorder(){const e=2*this.pixelSize,{width:t,height:a}=this.sys.game.config;this.borderGraphics||(this.borderGraphics=this.add.graphics(),this.borderGraphics.setDepth(1e3)),this.borderGraphics.clear(),this.borderGraphics.lineStyle(e,4210752,1);const s=e/2;this.borderGraphics.strokeRect(s,s,t-e,a-e),this.borderGraphics.lineStyle(this.pixelSize,2105376,.5),this.borderGraphics.strokeRect(s+this.pixelSize,s+this.pixelSize,t-e-2*this.pixelSize,a-e-2*this.pixelSize)}renderSky(e,t,a){let s;if(this.skyGraphics.clear(),a<.2)s={top:51,bottom:85};else if(a<.3){const e=(a-.2)/.1;s={top:this.lerpColor(51,16739125,e),bottom:this.lerpColor(85,16753920,e)}}else if(a<.4){const e=(a-.3)/.1;s={top:this.lerpColor(16739125,8900331,e),bottom:this.lerpColor(16753920,8900331,e)}}else if(a<.65)s={top:8900331,bottom:8900331};else if(a<.75){const e=(a-.65)/.1;s={top:this.lerpColor(8900331,16739125,e),bottom:this.lerpColor(8900331,16729344,e)}}else if(a<.85){const e=(a-.75)/.1;s={top:this.lerpColor(16739125,51,e),bottom:this.lerpColor(16729344,85,e)}}else s={top:51,bottom:85};const n=this.weatherSystem.cloudCoverage;if(n>.1&&a>=.25&&a<=.75){const e=.4*n,t=8421504;s.top=this.lerpColor(s.top,t,e),s.bottom=this.lerpColor(s.bottom,t,e)}const i=this.seasonManager.getCurrentSeason(),r=X.SKY_TINT[i];r&&(s.top=this.tintColor(s.top,r),s.bottom=this.tintColor(s.bottom,r)),this.skyGraphics.fillGradientStyle(s.top,s.top,s.bottom,s.bottom,1),this.skyGraphics.fillRect(0,0,e,t)}renderCelestialBodies(e,t,a){this.celestialGraphics.clear();let s=2;if(a>.3&&a<.7){s=2+8*(1-Math.abs(a-.5)/.2)}this.celestialGlow.outerStrength=s;const n=this.celestialManager.getSunPosition(e,t,a),i=this.celestialManager.getMoonPosition(e,t,a);if(this.celestialManager.isSunVisible(a)){const e=this.weatherSystem.cloudCoverage,t=this.seasonManager.getCurrentSeason(),a=X.SUN_TINT[t]||{r:1,g:1,b:1};this.celestialManager.renderSun(this.celestialGraphics,n,e,a)}this.celestialManager.isMoonVisible(a)&&this.celestialManager.renderMoon(this.celestialGraphics,i)}renderAtmosphere(e,t,a){this.overlayGraphics.clear();const s=.15*t;let n,i,r,o;if(a<.2||a>.85)n=657978,i=.6;else if(a<.3){const e=(a-.2)/.1;n=this.lerpColor(657978,16747586,e),i=.6}else if(a<.4){const e=(a-.3)/.1;n=this.lerpColor(16747586,8900331,e),i=.5}else if(a<.65)n=8900331,i=.4;else if(a<.75){const e=(a-.65)/.1;n=this.lerpColor(8900331,16739125,e),i=.5}else if(a<.85){const e=(a-.75)/.1;n=this.lerpColor(16739125,657978,e),i=.6}else n=657978,i=.6;if(this.overlayGraphics.fillGradientStyle(n,n,n,n,i,i,0,0),this.overlayGraphics.fillRect(0,0,e,s),a<.2||a>.85)r=51,o=.2;else if(a<.3){r=16739125,o=.15*(1-(a-.2)/.1)}else if(a<.65)o=0;else if(a<.75){r=16739125,o=.15*((a-.65)/.1)}else r=51,o=(a-.75)/.1*.2;o>0&&(this.overlayGraphics.fillStyle(r,o),this.overlayGraphics.fillRect(0,0,e,t))}getLightingColor(e){if(e<.2||e>.85)return{r:.5,g:.5,b:.7};if(e<.3){const t=(e-.2)/.1;return{r:.5+.5*t,g:.5+.5*t,b:.7+.3*t}}if(e<.65)return{r:1,g:1,b:1};if(e<.75){const t=(e-.65)/.1;return{r:1-.15*t,g:1-.2*t,b:1-.2*t}}{const t=(e-.75)/.1;return{r:.85-.35*t,g:.8-.3*t,b:.8-.1*t}}}applyLighting(e,t){const a=(e>>16&255)*t.r,s=(e>>8&255)*t.g,n=(255&e)*t.b;return Math.floor(a)<<16|Math.floor(s)<<8|Math.floor(n)}updateProfilerPanel(){var e,t,a,s,n,i,r,o;if(!this.profilerPanel)return;const l=A.getMetrics();A.getBottlenecks(10);const d=e=>{const t=e>10?"critical":e>5?"warn":"";return{value:e.toFixed(3),cssClass:t}};let h="";h+='<div class="section">',h+="<h3>Frame Timing</h3>";const c=d((null==(e=l["frame:total"])?void 0:e.avg)||0),m=d((null==(t=l["physics:update"])?void 0:t.avg)||0),u=d((null==(a=l["render:total"])?void 0:a.avg)||0);h+='<div class="metric '.concat(c.cssClass,'">\n            <span class="metric-name">Total Frame</span>\n            <span class="metric-value">').concat(c.value,"ms</span>\n        </div>"),h+='<div class="metric '.concat(m.cssClass,'">\n            <span class="metric-name"> Physics Update</span>\n            <span class="metric-value">').concat(m.value,"ms</span>\n        </div>"),h+='<div class="metric '.concat(u.cssClass,'">\n            <span class="metric-name"> Render Total</span>\n            <span class="metric-value">').concat(u.value,"ms</span>\n        </div>"),h+="</div>",h+='<div class="section">',h+="<h3>Render Breakdown</h3>";const g=d((null==(s=l["render:sky"])?void 0:s.avg)||0),f=d((null==(n=l["render:celestial"])?void 0:n.avg)||0),p=d((null==(i=l["render:particles"])?void 0:i.avg)||0),y=d((null==(r=l["render:atmosphere"])?void 0:r.avg)||0);h+='<div class="metric">\n            <span class="metric-name">Sky</span>\n            <span class="metric-value">'.concat(g.value,"ms</span>\n        </div>"),h+='<div class="metric">\n            <span class="metric-name">Celestial</span>\n            <span class="metric-value">'.concat(f.value,"ms</span>\n        </div>"),h+='<div class="metric '.concat(p.cssClass,'">\n            <span class="metric-name">Particles</span>\n            <span class="metric-value">').concat(p.value,"ms</span>\n        </div>"),h+='<div class="metric">\n            <span class="metric-name">Atmosphere</span>\n            <span class="metric-value">'.concat(y.value,"ms</span>\n        </div>"),h+="</div>";const w=Object.entries(l).filter(([e])=>e.startsWith("element:")).sort((e,t)=>t[1].avg-e[1].avg);w.length>0&&(h+='<div class="section">',h+="<h3>Element Updates (Top 5)</h3>",w.slice(0,5).forEach(([e,t])=>{const a=e.replace("element:",""),s=d(t.avg);h+='<div class="metric '.concat(s.cssClass,'">\n                    <span class="metric-name">').concat(a,'</span>\n                    <span class="metric-value">').concat(s.value,"ms</span>\n                </div>")}),h+="</div>"),h+='<div class="section">',h+="<h3>System Info</h3>",h+='<div class="metric">\n            <span class="metric-name">Active Cells</span>\n            <span class="metric-value">'.concat(this.pixelGrid.activeCells.size,"</span>\n        </div>"),h+='<div class="metric">\n            <span class="metric-name">Target FPS</span>\n            <span class="metric-value">60</span>\n        </div>';const b=(null==(o=l["frame:total"])?void 0:o.avg)||0,M=d(16.67-b);h+='<div class="metric '.concat(M.cssClass,'">\n            <span class="metric-name">Frame Budget</span>\n            <span class="metric-value">').concat(M.value,"ms</span>\n        </div>"),h+="</div>",this.profilerPanel.innerHTML=h}lerpColor(e,t,a){const s=e>>16&255,n=e>>8&255,i=255&e,r=t>>16&255,o=t>>8&255,l=255&t;return Math.floor(s+(r-s)*a)<<16|Math.floor(n+(o-n)*a)<<8|Math.floor(i+(l-i)*a)}tintColor(e,t){const a=e>>16&255,s=e>>8&255,n=255&e;return Math.min(255,Math.floor(a*t.r))<<16|Math.min(255,Math.floor(s*t.g))<<8|Math.min(255,Math.floor(n*t.b))}}const xe={type:s.AUTO,width:Math.min(window.innerWidth,800),height:Math.min(window.innerHeight,600),parent:"game-container",backgroundColor:"#000000",scene:Te,render:{pixelArt:!0,antialias:!1},fps:{target:60,forceSetTimeOut:!1},resolution:Math.min(window.devicePixelRatio||1,2)};window.__pixelboxGame&&window.__pixelboxGame.destroy(!0),window.__pixelboxGame=new s.Game(xe);export{a as __vite_legacy_guard};
